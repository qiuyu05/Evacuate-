import { useState, useEffect, useRef, useCallback, useMemo } from "react";

/* ═══════════════════════════════════════════════════════════════
   ECHOAID — Disaster Evacuation Companion
   UW Mathematics & Computer Building No. 17 — 1st Floor
   Floor plan walls extracted from architectural PDF
   Room coordinates from GeoJSON (OpenCV + Tesseract extraction)
   Coordinate space: X: 1309-4255.5, Y: 330.5-3111.5 → SVG: 1200×1120
   ═══════════════════════════════════════════════════════════════ */

// Transform: GeoJSON coords → SVG viewBox coords
// Updated for new coordinate space: X: 1309-4255.5, Y: 330.5-3111.5
const S = 0.4, OX = 1309, OY = 330.5;
const tx = x => (x - OX) * S;
const ty = y => (y - OY) * S;

// ── ROOM DATA from extracted GeoJSON coordinates ──
const RAW = [
  {x:2733.5,y:1386,id:2,type:"ROOM",label:"10"},{x:3644,y:613,id:3,type:"ROOM",label:"083"},
  {x:2132.5,y:331,id:5,type:"ROOM",label:"101"},
  {x:1864,y:836.5,id:6,type:"ROOM",label:"104"},{x:4041,y:1981,id:7,type:"ROOM",label:"1001"},
  {x:3599.9,y:2040.9,id:8,type:"ROOM",label:"h16",hallway:true,color:"green"},
  {x:3771,y:2438.5,id:10,type:"ROOM",label:"1002"},{x:3544,y:1849,id:11,type:"ROOM",label:"1003"},
  {x:3535,y:2137.5,id:12,type:"ROOM",label:"1004"},{x:3445.5,y:2137.5,id:13,type:"ROOM",label:"1005"},
  {x:3356,y:2137.5,id:14,type:"ROOM",label:"1006"},{x:3356,y:1920,id:15,type:"ROOM",label:"1007"},
  {x:3266.5,y:2137.5,id:16,type:"ROOM",label:"1008"},{x:3266.5,y:1921,id:17,type:"ROOM",label:"1009"},
  {x:3177,y:2137.5,id:18,type:"ROOM",label:"1010"},{x:3177,y:1920,id:19,type:"ROOM",label:"1011"},
  {x:3087.5,y:2137.5,id:20,type:"ROOM",label:"1012"},{x:3084,y:1919,id:21,type:"ROOM",label:"1013"},
  {x:2998,y:2137.5,id:22,type:"ROOM",label:"1014"},{x:2995,y:1917.5,id:23,type:"ROOM",label:"1015"},
  {x:2908.5,y:2137.5,id:24,type:"ROOM",label:"1016"},{x:2911,y:1919,id:25,type:"ROOM",label:"1017"},
  {x:2763,y:2137.5,id:26,type:"ROOM",label:"1018"},{x:2558,y:2137.5,id:27,type:"ROOM",label:"1020"},
  {x:2470,y:2137.5,id:28,type:"ROOM",label:"1021"},{x:2382,y:2137.5,id:29,type:"ROOM",label:"1022"},
  {x:2294,y:2137.5,id:30,type:"ROOM",label:"1023"},{x:2206,y:2137.5,id:31,type:"ROOM",label:"1024"},
  {x:2118,y:2137.5,id:32,type:"ROOM",label:"1025"},{x:2098,y:2260,id:33,type:"ROOM",label:"1026"},
  {x:2020.5,y:2275,id:34,type:"ROOM",label:"1026A"},{x:1873,y:2108,id:35,type:"ROOM",label:"1027"},
  {x:1868,y:1911,id:36,type:"ROOM",label:"1028"},{x:1866.5,y:1819.5,id:37,type:"ROOM",label:"1029"},
  {x:1868,y:1728.5,id:38,type:"ROOM",label:"1030"},{x:1865,y:1641,id:39,type:"ROOM",label:"1031"},
  {x:2040.5,y:1633.5,id:40,type:"ROOM",label:"1032"},{x:1868,y:1547,id:41,type:"ROOM",label:"1033"},
  {x:1865.5,y:1455.5,id:42,type:"ROOM",label:"1034"},{x:2041,y:1522.5,id:43,type:"ROOM",label:"1035"},
  {x:2040,y:1412,id:44,type:"ROOM",label:"1036"},{x:1870,y:1366,id:45,type:"ROOM",label:"1037"},
  {x:1864,y:1272.5,id:46,type:"ROOM",label:"1038"},{x:2039,y:1301,id:47,type:"ROOM",label:"1039"},
  {x:2041,y:1187,id:48,type:"ROOM",label:"1040"},{x:1868,y:1183.5,id:49,type:"ROOM",label:"1041"},
  {x:1871,y:1091,id:50,type:"ROOM",label:"1042"},{x:1868,y:998,id:51,type:"ROOM",label:"1043"},
  {x:1865.5,y:906,id:52,type:"ROOM",label:"1044"},{x:1870.5,y:843,id:53,type:"ROOM",label:"1045"},
  {x:1876,y:740.5,id:54,type:"ROOM",label:"1046"},{x:2156,y:567,id:55,type:"ROOM",label:"1048"},
  {x:2039.5,y:900,id:56,type:"ROOM",label:"1049"},{x:2302,y:1254.5,id:57,type:"ROOM",label:"1052"},
  {x:1868,y:1547,id:58,type:"ROOM",label:"1055"},{x:2303,y:1774,id:59,type:"ROOM",label:"1056"},
  {x:2038,y:1829,id:60,type:"ROOM",label:"1058"},{x:2623.5,y:1699,id:61,type:"ROOM",label:"1059"},
  {x:2943,y:1634,id:62,type:"ROOM",label:"1060A"},{x:3435.5,y:1632,id:63,type:"ROOM",label:"1060D"},
  {x:3246,y:1745.5,id:64,type:"ROOM",label:"h14",hallway:true,color:"green"},{x:3062.5,y:1798.5,id:65,type:"ROOM",label:"1060H"},
  {x:3313.5,y:1799,id:66,type:"ROOM",label:"1060G"},{x:2986,y:955.5,id:67,type:"ROOM",label:"1061A"},
  {x:3042,y:1317,id:68,type:"ROOM",label:"1061"},{x:2625,y:1130,id:69,type:"ROOM",label:"1063"},
  {x:2212,y:725.5,id:70,type:"ROOM",label:"1065"},{x:2399,y:727.5,id:71,type:"ROOM",label:"1066"},
  {x:2580,y:727.5,id:72,type:"ROOM",label:"1068"},{x:2717,y:727.5,id:73,type:"ROOM",label:"1070"},
  {x:2809,y:727.5,id:74,type:"ROOM",label:"1071"},{x:2900.5,y:727.5,id:75,type:"ROOM",label:"1072"},
  {x:2992,y:727.5,id:76,type:"ROOM",label:"1073"},{x:3083.5,y:728,id:77,type:"ROOM",label:"1074"},
  {x:3173,y:727,id:78,type:"ROOM",label:"1076"},{x:3169,y:945,id:79,type:"ROOM",label:"1077"},
  {x:3427,y:952,id:80,type:"ROOM",label:"1078"},{x:3263,y:726,id:81,type:"ROOM",label:"1079"},
  {x:3358,y:725.5,id:82,type:"ROOM",label:"1080"},{x:3446,y:725.5,id:83,type:"ROOM",label:"1081"},
  {x:3544,y:635,id:84,type:"ROOM",label:"1082"},{x:3799,y:546.5,id:85,type:"ROOM",label:"1083B"},
  {x:3702.5,y:629.5,id:86,type:"ROOM",label:"1083A"},{x:4076.5,y:1051,id:87,type:"ROOM",label:"1084"},
  {x:3451,y:1319.5,id:88,type:"ROOM",label:"1085"},{x:3991,y:1560.5,id:89,type:"ROOM",label:"1088B"},
  {x:4180,y:1607,id:90,type:"ROOM",label:"1088A"},{x:3926,y:1676.5,id:91,type:"ROOM",label:"1088"},
  {x:3974,y:2200,id:92,type:"ROOM",label:"1089"},
  {x:3594,y:2310,id:95,type:"ROOM",label:"h18",hallway:true,color:"green"},
  {x:3552.5,y:2442,id:96,type:"ROOM",label:"1094"},
  {x:2816,y:2030,id:98,type:"ROOM",label:"h15",hallway:true,color:"green"},
  {x:2136.5,y:1383,id:100,type:"ROOM",label:"h19",hallway:true,color:"green"},{x:1945,y:1383,id:101,type:"ROOM",label:"h20",hallway:true,color:"green"},
  {x:2120,y:448,id:103,type:"ROOM",label:"00"},
  {x:2107,y:448,id:104,type:"ROOM",label:"1100"},{x:2125.5,y:331,id:105,type:"ROOM",label:"1101"},
  {x:2149,y:330.5,id:106,type:"ROOM",label:"1102"},{x:2824,y:815.5,id:107,type:"ROOM",label:"1103",hallway:true,color:"green"},
  {x:3981,y:1329.6,id:110,type:"ROOM",label:"h11",hallway:true,color:"green"},
  {x:3710,y:1325.5,id:112,type:"ROOM",label:"h21",hallway:true,color:"green"},
  {x:4043,y:1888,id:115,type:"ROOM",label:"1109"},
  {x:3850,y:2045.7,id:118,type:"ROOM",label:"h17",hallway:true,color:"green"},
  {x:3710,y:841,id:120,type:"ROOM",label:"h13",hallway:true,color:"green"},
  {x:2151,y:353.5,id:123,type:"ROOM",label:"ELV"},
  {x:2128.5,y:354.5,id:124,type:"ROOM",label:"ELV"},
  {x:3720.9,y:2045.7,id:126,type:"ROOM",label:"h1",hallway:true,color:"green"},
  {x:3706.3,y:1760.2,id:127,type:"ROOM",label:"h2",hallway:true,color:"green"},
  {x:2811.3,y:1760.2,id:128,type:"ROOM",label:"h3",hallway:true,color:"green"},
  {x:2148.4,y:831.3,id:129,type:"ROOM",label:"h4",hallway:true,color:"green"},
  {x:1940.4,y:2026.3,id:130,type:"ROOM",label:"h5",hallway:true,color:"green"},
  {x:2148.4,y:700.6,id:131,type:"ROOM",label:"h6",hallway:true,color:"green"},
  {x:1940.4,y:2026.3,id:132,type:"ROOM",label:"h7",hallway:true,color:"green"},
  {x:2153.2,y:2026.3,id:133,type:"ROOM",label:"h8",hallway:true,color:"green"},
  {x:2032.3,y:2026.3,id:134,type:"ROOM",label:"h9",hallway:true,color:"green"},
  {x:1945.2,y:831.3,id:135,type:"ROOM",label:"h10",hallway:true,color:"green"},
  // Exits (manually added for evacuation routing)
  {x:2028.4,y:2141.6,id:200,type:"EXIT",label:"Exit 1"},
  {x:2018,y:705.5,id:201,type:"EXIT",label:"Exit 2"},
  {x:3753,y:719.7,id:202,type:"EXIT",label:"Exit 3"},
  {x:3720.9,y:2150,id:203,type:"EXIT",label:"Exit 4"},
];

const ROOMS = RAW.filter(r => r.type === "ROOM").map(r => ({ ...r, sx: tx(r.x), sy: ty(r.y) }));
const EXITS = RAW.filter(r => r.type === "EXIT").map(r => ({ ...r, sx: tx(r.x), sy: ty(r.y) }));

// ── WALL SEGMENTS extracted from architectural PDF ──
// Each [x1,y1,x2,y2] in GeoJSON 3× coordinate space
const WALLS_RAW = [
  [204.7,61.1,4950.2,61.1],
  [204.7,3308.3,4950.2,3308.3],
  [206.0,63.9,206.0,3305.5],
  [329.5,2651.0,329.5,2721.4],
  [329.5,2924.1,329.5,2973.3],
  [330.8,1951.4,330.8,2023.2],
  [330.8,2135.8,330.8,2206.2],
  [350.6,2515.9,350.6,2590.5],
  [351.9,3043.7,351.9,3174.6],
  [350.6,3102.8,387.3,3102.8],
  [350.6,3157.7,460.9,3157.7],
  [350.6,3166.2,472.7,3166.2],
  [350.6,3173.2,488.5,3173.2],
  [351.9,2271.0,351.9,2316.0],
  [351.9,2786.1,351.9,2848.1],
  [351.9,3112.7,397.8,3112.7],
  [351.9,3119.7,405.7,3119.7],
  [351.9,3132.4,418.9,3133.8],
  [351.9,3150.7,441.2,3150.7],
  [368.9,3077.5,371.6,3149.3],
  [541.1,1743.1,585.7,1744.5],
  [545.0,3191.5,592.3,3191.5],
  [665.9,3174.6,709.2,3174.6],
  [780.2,3191.5,827.5,3191.5],
  [890.5,3173.2,922.1,3173.2],
  [983.8,3191.5,1035.0,3191.5],
  [1103.4,3171.8,1166.4,3171.8],
  [1179.6,1730.4,1246.6,1731.9],
  [1222.9,3191.5,1284.7,3191.5],
  [1259.7,1370.1,1309.6,1371.5],
  [1261.0,1375.7,1309.6,1377.1],
  [1266.3,1296.9,1301.7,1298.3],
  [1278.1,1251.9,1547.4,1251.9],
  [1278.1,1265.9,1837.8,1265.9],
  [1278.1,1339.1,1309.6,1339.1],
  [1279.4,1057.6,1279.4,1263.1],
  [1287.3,1406.7,1548.7,1406.7],
  [1287.3,1412.3,1550.1,1412.3],
  [1287.3,1416.6,1550.1,1416.6],
  [1292.5,1118.2,1292.5,1423.6],
  [1289.9,1274.4,1547.4,1274.4],
  [1293.9,1368.7,1295.2,1425.0],
  [1300.4,1067.5,1523.8,1067.5],
  [1332.0,1302.5,1504.1,1302.5],
  [1332.0,1377.1,1505.4,1377.1],
  [1334.6,1123.8,1454.1,1123.8],
  [1349.0,1130.8,1489.6,1130.8],
  [1377.9,1185.7,1429.2,1185.7],
  [1380.6,1197.0,1429.2,1198.4],
  [1397.7,1330.7,1441.0,1332.1],
  [1397.7,1339.1,1446.3,1339.1],
  [1397.7,1344.8,1442.3,1344.8],
  [1409.5,1353.2,1446.3,1353.2],
  [1455.5,1122.4,1489.6,1125.2],
  [1459.4,1171.6,1547.4,1171.6],
  [1481.7,1211.1,1547.4,1211.1],
  [1510.6,1201.2,1547.4,1201.2],
  [1510.6,2917.0,1512.0,2987.4],
  [1522.5,1181.5,1564.5,1184.3],
  [1525.1,1175.9,1526.4,1253.3],
  [1529.0,1278.6,1529.0,1415.2],
  [1534.3,1118.2,1534.3,1425.0],
  [1539.5,1298.3,1539.5,1425.0],
  [1542.2,1191.3,1542.2,1278.6],
  [1546.1,1060.4,1546.1,1188.5],
  [1606.5,1168.8,1749.8,1168.8],
  [1606.5,1191.3,1713.0,1195.6],
  [1606.5,1202.6,1714.3,1202.6],
  [1606.5,1222.3,1714.3,1232.2],
  [1614.4,1236.4,1714.3,1237.8],
  [1614.4,1251.9,1915.3,1251.9],
  [1703.8,687.4,2080.8,687.4],
  [1703.8,694.5,2080.8,694.5],
  [1703.8,698.7,1783.9,698.7],
  [1705.1,351.0,1705.1,697.3],
  [1713.0,351.0,1713.0,700.1],
  [1739.2,1059.0,1837.8,1059.0],
  [1739.2,1060.4,1739.2,1180.1],
  [1739.2,1070.3,1783.9,1070.3],
  [1752.4,484.8,1752.4,557.9],
  [1748.4,382.0,1753.7,442.5],
  [1755.0,477.7,1755.0,546.7],
  [1781.3,1254.7,1914.0,1254.7],
  [1782.6,353.8,1782.6,431.3],
  [1782.6,428.4,1782.6,490.4],
  [1782.6,476.3,1782.6,594.5],
  [1782.6,593.1,1942.9,595.9],
  [1782.6,708.6,1837.8,708.6],
  [1782.6,874.6,1835.2,874.6],
  [1782.6,1429.2,1837.8,1429.2],
  [1782.6,1636.1,1837.8,1636.1],
  [1782.6,1986.6,1837.8,1988.0],
  [1783.9,351.0,1946.8,351.0],
  [1783.9,1244.8,1837.8,1244.8],
  [1783.9,1450.3,1837.8,1450.3],
  [1783.9,1820.5,1837.8,1820.5],
  [1785.2,895.8,1837.8,895.8],
  [1785.2,1080.2,1836.5,1080.2],
  [1785.2,1799.4,1837.8,1799.4],
  [1785.2,2169.6,1869.3,2169.6],
  [1786.5,408.7,1927.1,411.6],
  [1789.2,2190.7,1850.9,2190.7],
  [1793.1,362.3,1793.1,477.7],
  [1794.4,546.7,1794.4,688.8],
  [1793.1,462.2,1793.1,539.6],
  [1793.1,521.3,1794.4,560.8],
  [1793.1,639.6,1856.2,639.6],
  [1794.4,641.0,1824.6,643.8],
  [1794.4,646.6,1861.4,650.8],
  [1794.4,894.4,1798.4,1060.4],
  [1795.7,977.4,1916.6,977.4],
  [1799.7,1278.6,1799.7,1430.6],
  [1798.4,1463.0,1801.0,1616.4],
  [1799.7,710.0,1799.7,745.2],
  [1799.7,833.8,1886.4,833.8],
  [1801.0,1078.7,1801.0,1257.5],
  [1799.7,1346.2,1915.3,1346.2],
  [1799.7,1719.2,1916.6,1719.2],
  [1799.7,1900.8,1915.3,1900.8],
  [1799.7,1906.4,1915.3,1906.4],
  [1799.7,2004.9,1799.7,2171.0],
  [1801.0,838.1,1803.6,873.2],
  [1801.0,1634.7,1801.0,1800.8],
  [1801.0,1820.5,1801.0,1985.2],
  [1801.0,2030.3,1829.9,2030.3],
  [1802.3,2158.3,1829.9,2158.3],
  [1804.9,583.3,1833.8,584.7],
  [1806.2,894.4,1806.2,1060.4],
  [1808.9,1867.0,1808.9,1985.2],
  [1808.9,1278.6,1808.9,1430.6],
  [1808.9,1078.7,1808.9,1254.7],
  [1808.9,1448.9,1808.9,1616.4],
  [1808.9,1634.7,1810.2,1733.3],
  [1810.2,2004.9,1810.2,2171.0],
  [1812.8,653.7,1857.5,655.1],
  [1815.4,1219.5,1815.4,1289.9],
  [1818.1,743.7,1818.1,839.5],
  [1819.4,688.8,1819.4,722.6],
  [1823.3,1219.5,1823.3,1289.9],
  [1828.6,1219.5,1828.6,1288.5],
  [1829.9,710.0,1829.9,873.2],
  [1832.5,1159.0,1869.3,1160.4],
  [1836.5,1996.5,1915.3,1996.5],
  [1837.8,1068.9,1915.3,1068.9],
  [1837.8,1810.7,1915.3,1810.7],
  [1839.1,921.1,1886.4,921.1],
  [1839.1,1311.0,1915.3,1312.4],
  [1839.1,1436.3,1914.0,1439.1],
  [1840.4,1851.5,1877.2,1852.9],
  [1843.0,1760.0,1891.6,1761.4],
  [1843.0,1771.3,1890.3,1771.3],
  [1845.7,856.3,1899.5,860.6],
  [1845.7,1220.9,1886.4,1220.9],
  [1848.3,831.0,1848.3,887.3],
  [1848.3,757.8,1898.2,757.8],
  [1848.3,863.4,1906.1,869.0],
  [1848.3,2088.0,1895.6,2088.0],
  [1848.3,2095.0,1894.3,2095.0],
  [1848.3,2104.9,1891.6,2104.9],
  [1850.9,763.4,1899.5,763.4],
  [1852.2,2169.6,1941.6,2169.6],
  [1853.5,2190.7,1853.5,2432.8],
  [1856.2,831.0,1856.2,887.3],
  [1854.9,880.3,1914.0,883.1],
  [1862.7,832.4,1862.7,887.3],
  [1862.7,2169.6,1862.7,2432.8],
  [1864.1,770.5,1898.2,773.3],
  [1869.3,885.9,1898.2,887.3],
  [1873.3,832.4,1915.3,832.4],
  [1873.3,831.0,1873.3,885.9],
  [1874.6,2180.9,1941.6,2180.9],
  [1885.1,831.0,1885.1,887.3],
  [1887.7,1845.9,1890.3,1878.2],
  [1891.6,808.5,1891.6,887.3],
  [1889.0,1106.9,1891.6,1136.5],
  [1889.0,1187.1,1891.6,1220.9],
  [1889.0,1372.9,1889.0,1402.5],
  [1889.0,1743.1,1890.3,1771.3],
  [1891.6,998.5,1891.6,1032.3],
  [1896.9,1109.7,1896.9,1198.4],
  [1898.2,804.3,1898.2,866.2],
  [1895.6,1682.6,1900.8,1755.8],
  [1896.9,801.5,2040.1,801.5],
  [1899.5,940.8,1899.5,1014.0],
  [1902.2,1123.8,1902.2,1199.8],
  [1902.2,1865.6,1902.2,1941.6],
  [1903.5,802.9,1903.5,887.3],
  [1904.8,1679.8,1904.8,1755.8],
  [1906.1,963.3,1906.1,997.1],
  [1906.1,1494.0,1906.1,1682.6],
  [1903.5,2045.7,1904.8,2078.1],
  [1904.8,2078.1,2080.8,2078.1],
  [1904.8,2082.3,1973.1,2082.3],
  [1906.1,2171.0,1935.0,2171.0],
  [1908.7,1938.8,1908.7,2047.1],
  [1911.4,867.6,1911.4,942.2],
  [1908.7,1067.5,1908.7,1128.0],
  [1908.7,1149.1,1910.0,1177.3],
  [1908.7,1197.0,1908.7,1312.4],
  [1908.7,1395.4,1963.9,1395.4],
  [1908.7,1567.2,1910.0,1612.2],
  [1910.0,1707.9,1910.0,1868.4],
  [1908.7,1888.1,1910.0,1916.2],
  [1910.0,1382.8,1910.0,1498.2],
  [1914.0,871.8,1914.0,915.5],
  [1914.0,1012.6,1914.0,1126.6],
  [1914.0,1197.0,1914.0,1311.0],
  [1914.0,1568.6,1914.0,1655.8],
  [1914.0,1709.3,1914.0,1868.4],
  [1914.0,1938.8,1915.3,2042.9],
  [1915.3,1382.8,1915.3,1496.8],
  [1921.9,2351.2,1921.9,2432.8],
  [1921.9,2361.0,2067.7,2362.4],
  [1921.9,2403.3,1923.2,2432.8],
  [1928.4,662.1,1928.4,804.3],
  [1927.1,762.0,2008.6,763.4],
  [1927.1,767.7,1963.9,769.1],
  [1927.1,774.7,2007.3,774.7],
  [1927.1,793.0,2009.9,793.0],
  [1927.1,795.8,2080.8,795.8],
  [1928.4,780.3,2007.3,780.3],
  [1931.1,270.8,1931.1,418.6],
  [1931.1,522.8,1931.1,608.6],
  [1929.7,1384.2,2075.6,1384.2],
  [1929.7,1433.4,1963.9,1436.3],
  [1931.1,422.8,1932.4,453.8],
  [1931.1,612.8,1932.4,649.4],
  [1931.1,629.7,2074.3,629.7],
  [1931.1,641.0,2080.8,641.0],
  [1931.1,650.8,2080.8,650.8],
  [1931.1,662.1,2044.0,662.1],
  [1931.1,679.0,2080.8,679.0],
  [1933.7,705.7,1933.7,804.3],
  [1931.1,2185.1,2007.3,2185.1],
  [1931.1,2192.1,2005.9,2192.1],
  [1931.1,2200.6,2004.6,2200.6],
  [1931.1,2207.6,2004.6,2207.6],
  [1931.1,2183.7,1931.1,2382.1],
  [1931.1,2389.2,1932.4,2432.8],
  [1932.4,669.1,2072.9,669.1],
  [1932.4,1401.1,1962.6,1402.5],
  [1935.0,2088.0,1963.9,2088.0],
  [1935.0,2102.0,2016.5,2102.0],
  [1935.0,2109.1,2016.5,2109.1],
  [1935.0,2117.5,2016.5,2117.5],
  [1936.3,2099.2,1936.3,2166.8],
  [1941.6,339.8,1941.6,453.8],
  [1942.9,270.8,1942.9,341.2],
  [1941.6,327.1,1941.6,383.4],
  [1941.6,522.8,1941.6,557.9],
  [1942.9,563.6,1942.9,693.1],
  [1941.6,1385.6,1941.6,1437.7],
  [1941.6,2083.7,1941.6,2362.4],
  [1944.2,2224.5,2003.3,2224.5],
  [1945.5,656.5,2072.9,656.5],
  [1945.5,2231.5,2003.3,2234.4],
  [1952.1,270.8,1952.1,349.6],
  [1949.5,2349.8,1996.7,2351.2],
  [1957.3,270.8,1957.3,345.4],
  [1953.4,619.9,1954.7,693.1],
  [1957.3,873.2,2100.5,873.2],
  [1957.3,909.8,1960.0,940.8],
  [1957.3,971.8,2097.9,971.8],
  [1957.3,1001.3,1957.3,1239.2],
  [1957.3,1157.6,2070.3,1157.6],
  [1957.3,1195.6,1957.3,1235.0],
  [1957.3,1274.4,2099.2,1274.4],
  [1957.3,1304.0,1957.3,1463.0],
  [1958.6,1529.2,1958.6,1688.2],
  [1957.3,1712.1,1957.3,1945.8],
  [1957.3,2002.1,2099.2,2002.1],
  [1957.3,2007.7,2013.8,2009.1],
  [1958.6,1609.4,2099.2,1609.4],
  [1958.6,1720.6,2100.5,1720.6],
  [1960.0,2285.0,2040.1,2286.4],
  [1963.9,270.8,1963.9,320.1],
  [1961.3,763.4,1961.3,804.3],
  [1961.3,784.6,2007.3,784.6],
  [1963.9,960.5,1963.9,1128.0],
  [1962.6,1129.4,1963.9,1239.2],
  [1962.6,1302.5,1962.6,1430.6],
  [1963.9,1707.9,1963.9,1795.2],
  [1962.6,1781.1,1962.6,1958.5],
  [1963.9,1896.5,1963.9,2007.7],
  [1963.9,612.8,1969.2,684.6],
  [1963.9,1527.8,1963.9,1689.6],
  [1967.8,270.8,1967.8,382.0],
  [1965.2,1256.1,1965.2,1285.7],
  [1966.5,270.8,1969.2,300.4],
  [1970.5,407.3,1970.5,535.4],
  [1966.5,2217.5,2004.6,2220.3],
  [1971.8,470.7,1971.8,504.5],
  [1970.5,753.6,1974.4,802.9],
  [1971.8,2066.9,2000.7,2066.9],
  [1977.0,593.1,1977.0,695.9],
  [1973.1,1686.8,1973.1,1722.0],
  [1981.0,405.9,1981.0,535.4],
  [1975.7,593.1,2042.7,593.1],
  [1975.7,970.4,1975.7,1001.3],
  [1975.7,1494.0,1978.4,1529.2],
  [1977.0,749.4,1981.0,802.9],
  [1977.0,2061.2,2004.6,2061.2],
  [1979.7,270.8,1979.7,382.0],
  [1981.0,594.5,1981.0,695.9],
  [1978.4,2183.7,1981.0,2237.2],
  [1981.0,503.0,1983.6,535.4],
  [1983.6,404.5,1983.6,483.3],
  [1983.6,719.8,2033.5,719.8],
  [1983.6,2064.0,1983.6,2116.1],
  [1986.2,732.5,2032.2,732.5],
  [1991.5,594.5,1991.5,695.9],
  [1990.2,762.0,1990.2,804.3],
  [1987.6,2088.0,2016.5,2089.4],
  [1992.8,341.2,1992.8,535.4],
  [1998.1,594.5,1998.1,693.1],
  [1992.8,1268.8,2099.2,1268.8],
  [1995.4,348.2,1999.4,458.0],
  [1996.7,1059.0,2055.9,1059.0],
  [1998.1,1067.5,2058.5,1073.1],
  [1998.1,2145.7,2048.0,2145.7],
  [2002.0,594.5,2002.0,697.3],
  [2000.7,2183.7,2000.7,2286.4],
  [2002.0,387.6,2002.0,448.2],
  [2000.7,2154.1,2048.0,2154.1],
  [2000.7,2161.2,2048.0,2162.6],
  [2002.0,1861.3,2050.6,1864.2],
  [2003.3,270.8,2004.6,377.8],
  [2003.3,918.3,2053.2,918.3],
  [2003.3,1323.7,2053.2,1323.7],
  [2004.6,594.5,2005.9,624.1],
  [2004.6,1208.2,2055.9,1208.2],
  [2004.6,1662.9,2054.6,1662.9],
  [2004.6,1855.7,2050.6,1858.5],
  [2004.6,1869.8,2053.2,1869.8],
  [2004.6,1874.0,2048.0,1875.4],
  [2005.9,925.3,2053.2,926.7],
  [2005.9,1329.3,2053.2,1329.3],
  [2005.9,1334.9,2053.2,1334.9],
  [2005.9,2185.1,2005.9,2286.4],
  [2007.3,417.2,2008.6,448.2],
  [2007.3,1677.0,2054.6,1677.0],
  [2008.6,763.4,2008.6,804.3],
  [2008.6,1215.3,2055.9,1216.7],
  [2008.6,1222.3,2053.2,1222.3],
  [2011.2,594.5,2011.2,693.1],
  [2013.8,1159.0,2097.9,1159.0],
  [2017.8,594.5,2017.8,693.1],
  [2016.5,2085.2,2016.5,2114.7],
  [2019.1,2082.3,2080.8,2083.7],
  [2023.0,594.5,2023.0,693.1],
  [2020.4,2044.3,2101.9,2044.3],
  [2025.7,270.8,2025.7,301.8],
  [2033.5,594.5,2033.5,693.1],
  [2030.9,815.5,2094.0,815.5],
  [2033.5,377.8,2033.5,448.2],
  [2037.5,594.5,2037.5,693.1],
  [2042.7,594.5,2042.7,693.1],
  [2042.7,270.8,2042.7,372.1],
  [2046.7,612.8,2049.3,693.1],
  [2048.0,826.8,2094.0,826.8],
  [2048.0,831.0,2091.3,831.0],
  [2050.6,2034.5,2101.9,2034.5],
  [2053.2,612.8,2053.2,693.1],
  [2059.8,1382.8,2099.2,1382.8],
  [2062.4,612.8,2062.4,693.1],
  [2062.4,2082.3,2062.4,2117.5],
  [2063.8,396.1,2095.3,396.1],
  [2069.0,308.8,2069.0,407.3],
  [2071.6,611.4,2071.6,742.3],
  [2074.3,308.8,2074.3,401.7],
  [2074.3,439.7,2074.3,610.0],
  [2078.2,2116.1,2078.2,2348.4],
  [2074.3,2323.0,2074.3,2362.4],
  [2075.6,2187.9,2113.7,2190.7],
  [2075.6,2325.8,2113.7,2325.8],
  [2079.5,439.7,2079.5,763.4],
  [2079.5,2117.5,2082.1,2180.9],
  [2079.5,2248.4,2082.1,2327.3],
  [2088.7,2211.8,2088.7,2362.4],
  [2091.3,2244.2,2094.0,2289.2],
  [2094.0,308.8,2094.0,401.7],
  [2092.7,870.4,2092.7,1958.5],
  [2094.0,1710.7,2094.0,2009.1],
  [2092.7,2324.4,2092.7,2362.4],
  [2096.6,919.7,2096.6,1240.6],
  [2097.9,1302.5,2097.9,1465.8],
  [2097.9,1526.3,2097.9,1691.0],
  [2097.9,1710.7,2097.9,1861.3],
  [2099.2,2211.8,2099.2,2296.3],
  [2100.5,2324.4,2100.5,2400.4],
  [2103.2,2400.4,2212.2,2400.4],
  [2108.4,2933.9,2108.4,2994.4],
  [2111.1,2176.6,2163.6,2176.6],
  [2111.1,2324.4,2116.3,2400.4],
  [2122.9,2355.4,2122.9,2400.4],
  [2121.6,308.8,2122.9,379.2],
  [2122.9,2173.8,2163.6,2175.2],
  [2128.1,400.3,2182.0,400.3],
  [2129.4,2189.3,2163.6,2189.3],
  [2130.8,308.8,2132.1,356.7],
  [2140.0,2133.0,2140.0,2251.2],
  [2138.6,2154.1,2166.2,2154.1],
  [2143.9,2171.0,2143.9,2400.4],
  [2143.9,2168.2,2207.0,2168.2],
  [2147.8,2154.1,2147.8,2328.7],
  [2146.5,2078.1,2228.0,2078.1],
  [2151.8,310.2,2153.1,363.7],
  [2151.8,2065.4,2225.4,2065.4],
  [2151.8,2251.2,2151.8,2313.2],
  [2153.1,1280.0,2179.4,1281.4],
  [2153.1,1330.7,2187.3,1330.7],
  [2155.7,2175.2,2155.7,2224.5],
  [2155.7,2354.0,2155.7,2400.4],
  [2162.3,1240.6,2162.3,1330.7],
  [2161.0,310.2,2162.3,401.7],
  [2162.3,527.0,2203.0,527.0],
  [2162.3,586.1,2250.3,588.9],
  [2162.3,618.5,2208.3,619.9],
  [2162.3,565.0,2162.3,804.3],
  [2162.3,687.4,3486.6,687.4],
  [2162.3,711.4,2207.0,711.4],
  [2162.3,738.1,2162.3,804.3],
  [2162.3,798.6,2274.0,798.6],
  [2162.3,870.4,2463.1,870.4],
  [2162.3,871.8,2162.3,901.4],
  [2162.3,1056.2,2162.3,1092.8],
  [2162.3,1637.5,2224.0,1640.4],
  [2162.3,1798.0,2163.6,1850.1],
  [2162.3,1876.8,2162.3,2006.3],
  [2162.3,2009.1,2791.6,2009.1],
  [2164.9,2075.3,2164.9,2263.9],
  [2163.6,2238.6,2214.8,2238.6],
  [2164.9,2050.0,2229.3,2050.0],
  [2166.2,2054.2,2229.3,2058.4],
  [2167.5,712.8,2167.5,804.3],
  [2167.5,2045.7,2167.5,2169.6],
  [2168.9,563.6,2168.9,607.2],
  [2168.9,1876.8,2168.9,1985.2],
  [2168.9,2080.9,2228.0,2080.9],
  [2171.5,2290.7,2171.5,2400.4],
  [2170.2,1636.1,2170.2,1688.2],
  [2171.5,2194.9,2171.5,2266.7],
  [2174.1,607.2,2174.1,684.6],
  [2174.1,1820.5,2174.1,1883.9],
  [2176.7,525.6,2176.7,566.4],
  [2180.7,1080.2,2180.7,1242.0],
  [2179.4,1643.2,2216.2,1643.2],
  [2182.0,525.6,2182.0,619.9],
  [2180.7,901.4,2180.7,1054.8],
  [2180.7,1330.7,2180.7,1426.4],
  [2180.7,1453.2,2180.7,1610.8],
  [2180.7,1671.3,2180.7,1796.6],
  [2182.0,1862.8,2182.0,1983.8],
  [2184.6,360.9,2184.6,401.7],
  [2183.3,576.2,2229.3,577.7],
  [2183.3,2187.9,3570.7,2187.9],
  [2184.6,393.3,2212.2,393.3],
  [2185.9,1332.1,2185.9,1561.5],
  [2185.9,1484.1,2187.3,1619.2],
  [2185.9,1620.7,2506.5,1620.7],
  [2185.9,1672.7,2185.9,1840.2],
  [2185.9,1868.4,2187.3,2000.7],
  [2185.9,2002.1,2510.4,2002.1],
  [2185.9,2354.0,2185.9,2400.4],
  [2187.3,870.4,2187.3,1277.2],
  [2187.3,1627.7,2506.5,1627.7],
  [2188.6,876.1,2463.1,876.1],
  [2195.1,679.0,2325.2,679.0],
  [2196.4,2200.6,2325.2,2200.6],
  [2199.1,2237.2,2199.1,2330.1],
  [2201.7,2286.4,2201.7,2399.0],
  [2204.3,308.8,2204.3,380.6],
  [2201.7,2252.7,2203.0,2282.2],
  [2203.0,2130.2,2235.9,2130.2],
  [2212.2,2118.9,2239.8,2118.9],
  [2213.5,2240.0,2213.5,2400.4],
  [2216.2,308.8,2220.1,370.7],
  [2225.4,2092.2,2293.7,2092.2],
  [2233.2,739.5,2283.2,739.5],
  [2235.9,308.8,2235.9,405.9],
  [2235.9,749.4,2283.2,749.4],
  [2237.2,442.5,2237.2,590.3],
  [2237.2,515.7,2238.5,619.9],
  [2239.8,756.4,2279.2,756.4],
  [2249.0,308.8,2249.0,619.9],
  [2280.5,2142.9,2306.8,2144.3],
  [2288.4,2130.2,2317.3,2130.2],
  [2292.4,797.2,2401.4,797.2],
  [2292.4,804.3,2400.1,804.3],
  [2292.4,2080.9,2401.4,2080.9],
  [2293.7,2075.3,2350.2,2075.3],
  [2298.9,2120.3,2325.2,2120.3],
  [2314.7,708.6,2380.4,708.6],
  [2314.7,2171.0,2380.4,2171.0],
  [2318.6,1273.0,2367.2,1273.0],
  [2319.9,1280.0,2368.6,1280.0],
  [2319.9,1288.5,2367.2,1288.5],
  [2321.3,1807.9,2368.6,1807.9],
  [2327.8,2704.5,2389.6,2705.9],
  [2329.1,3191.5,2385.6,3191.5],
  [2333.1,1799.4,2368.6,1800.8],
  [2337.0,2237.2,2337.0,2332.9],
  [2342.3,2075.3,2400.1,2075.3],
  [2350.2,2088.0,2350.2,2171.0],
  [2356.7,546.7,2356.7,643.8],
  [2358.0,2237.2,2358.0,2332.9],
  [2365.9,2140.0,2392.2,2141.5],
  [2368.6,679.0,2498.6,679.0],
  [2368.6,2200.6,2498.6,2200.6],
  [2373.8,2130.2,2406.7,2130.2],
  [2383.0,2120.3,2409.3,2121.7],
  [2383.0,2126.0,2409.3,2126.0],
  [2398.8,2086.6,2469.7,2086.6],
  [2400.1,2095.0,2435.6,2095.0],
  [2409.3,740.9,2459.2,740.9],
  [2411.9,750.8,2460.5,750.8],
  [2411.9,756.4,2460.5,756.4],
  [2421.1,800.0,2573.5,800.0],
  [2456.6,895.8,2530.2,897.2],
  [2463.1,2130.2,2492.1,2130.2],
  [2464.5,2121.7,2501.3,2121.7],
  [2465.8,2080.9,2573.5,2080.9],
  [2471.0,2075.3,2573.5,2075.3],
  [2473.7,2116.1,2501.3,2116.1],
  [2485.5,691.7,2511.8,691.7],
  [2486.8,708.6,2552.5,708.6],
  [2486.8,2171.0,2552.5,2171.0],
  [2497.3,686.0,2528.8,687.4],
  [2507.8,870.4,2790.3,870.4],
  [2509.1,1427.8,2509.1,2014.8],
  [2510.4,2238.6,2510.4,2334.3],
  [2511.8,546.7,2511.8,643.8],
  [2513.1,1477.1,2514.4,1613.6],
  [2513.1,1636.1,2513.1,1800.8],
  [2513.1,1821.9,2513.1,1985.2],
  [2519.6,711.4,2519.6,802.9],
  [2522.3,2076.7,2522.3,2171.0],
  [2530.2,546.7,2530.2,643.8],
  [2530.2,878.9,2792.9,878.9],
  [2530.2,2238.6,2530.2,2334.3],
  [2542.0,679.0,2672.0,679.0],
  [2542.0,2200.6,2611.6,2202.0],
  [2548.5,2127.4,2576.1,2128.8],
  [2548.5,2133.0,2574.8,2133.0],
  [2570.9,2085.2,2641.8,2085.2],
  [2581.4,746.6,2631.3,746.6],
  [2582.7,738.1,2631.3,738.1],
  [2582.7,2002.1,2653.7,2002.1],
  [2584.0,752.2,2631.3,752.2],
  [2584.0,757.8,2631.3,757.8],
  [2616.9,794.4,2716.7,794.4],
  [2622.1,1727.6,2672.0,1727.6],
  [2623.4,1149.1,2673.4,1149.1],
  [2627.4,2141.5,2653.7,2141.5],
  [2635.3,2134.4,2662.8,2137.2],
  [2637.9,679.0,2672.0,680.4],
  [2637.9,2128.8,2664.2,2128.8],
  [2639.2,2078.1,2746.9,2078.1],
  [2640.5,804.3,2746.9,804.3],
  [2644.5,2121.7,2672.0,2121.7],
  [2660.2,708.6,2725.9,711.4],
  [2660.2,797.2,2746.9,797.2],
  [2660.2,2171.0,2724.6,2171.0],
  [2669.4,2002.1,2792.9,2002.1],
  [2672.0,2075.3,2746.9,2076.7],
  [2683.9,546.7,2683.9,643.8],
  [2685.2,686.0,2715.4,687.4],
  [2690.4,742.3,2761.4,742.3],
  [2693.1,711.4,2693.1,814.1],
  [2702.3,2237.2,2702.3,2300.5],
  [2703.6,546.7,2703.6,643.8],
  [2710.1,1265.9,2711.5,1354.6],
  [2710.1,1267.4,2764.0,1267.4],
  [2710.1,1273.0,2792.9,1274.4],
  [2710.1,1344.8,2749.6,1344.8],
  [2710.1,1350.4,2749.6,1350.4],
  [2710.1,1357.4,2749.6,1357.4],
  [2710.1,1367.3,2749.6,1367.3],
  [2710.1,1381.4,2749.6,1381.4],
  [2710.1,1396.9,2749.6,1396.9],
  [2710.1,1405.3,2791.6,1408.1],
  [2710.1,1422.2,2782.4,1423.6],
  [2710.1,1433.4,2783.7,1433.4],
  [2710.1,1441.9,2783.7,1441.9],
  [2712.8,752.2,2761.4,752.2],
  [2716.7,1265.9,2719.3,1440.5],
  [2716.7,2202.0,2844.2,2202.0],
  [2719.3,679.0,2768.0,680.4],
  [2736.4,2705.9,2808.7,2705.9],
  [2745.6,1301.1,2745.6,1440.5],
  [2743.0,788.8,2815.2,788.8],
  [2743.0,3191.5,2804.7,3191.5],
  [2744.3,2085.2,2794.2,2085.2],
  [2745.6,1302.5,2792.9,1302.5],
  [2746.9,784.6,2813.9,784.6],
  [2753.5,2121.7,2803.4,2121.7],
  [2756.1,2127.4,2803.4,2127.4],
  [2756.1,2134.4,2804.7,2134.4],
  [2766.6,797.2,2792.9,797.2],
  [2777.1,679.0,2777.1,742.3],
  [2779.8,707.1,2779.8,804.3],
  [2785.0,870.4,2785.0,1137.9],
  [2787.7,1220.9,2787.7,1405.3],
  [2785.0,1426.4,2785.0,2007.7],
  [2789.0,2085.2,2869.1,2085.2],
  [2790.3,871.8,2790.3,1136.5],
  [2791.6,1430.6,2791.6,2007.7],
  [2792.9,1712.1,2823.1,1715.0],
  [2795.5,679.0,2842.8,679.0],
  [2799.5,743.7,2846.8,743.7],
  [2802.1,755.0,2846.8,755.0],
  [2804.7,2027.4,2846.8,2030.3],
  [2811.3,797.2,2920.4,797.2],
  [2811.3,2082.3,2967.7,2082.3],
  [2812.6,802.9,2919.0,802.9],
  [2812.6,2075.3,2874.4,2075.3],
  [2833.6,708.6,2899.3,710.0],
  [2833.6,2169.6,2899.3,2169.6],
  [2844.2,679.0,2844.2,711.4],
  [2848.1,1715.0,2974.2,1715.0],
  [2853.4,1495.4,2853.4,1654.4],
  [2854.7,871.8,3080.6,871.8],
  [2854.7,873.2,2854.7,1319.4],
  [2854.7,1610.8,3146.3,1610.8],
  [2854.7,1678.4,2856.0,1717.8],
  [2854.7,1720.6,2972.9,1720.6],
  [2854.7,2007.7,2892.8,2009.1],
  [2856.0,546.7,2856.0,643.8],
  [2856.0,1080.2,2917.7,1081.6],
  [2858.6,1450.3,2858.6,1578.4],
  [2856.0,1768.4,2856.0,1821.9],
  [2856.0,2238.6,2857.3,2331.5],
  [2859.9,1080.2,2859.9,1244.8],
  [2861.2,1265.9,2861.2,1384.2],
  [2859.9,1637.5,2859.9,1729.0],
  [2861.2,894.4,2861.2,1059.0],
  [2861.2,1368.7,2861.2,1429.2],
  [2861.2,1539.0,2861.2,1615.0],
  [2865.2,2082.3,2865.2,2171.0],
  [2866.5,710.0,2866.5,802.9],
  [2871.7,1265.9,2871.7,1416.6],
  [2871.7,1080.2,2871.7,1244.8],
  [2871.7,1450.3,2871.7,1615.0],
  [2871.7,1823.3,2871.7,1981.0],
  [2873.1,1715.0,2878.3,1805.0],
  [2874.4,690.3,3030.7,690.3],
  [2875.7,546.7,2877.0,641.0],
  [2875.7,877.5,3164.7,877.5],
  [2875.7,2237.2,2875.7,2332.9],
  [2877.0,1059.0,2877.0,1318.0],
  [2877.0,1422.2,2877.0,1581.2],
  [2877.0,1821.9,2878.3,1874.0],
  [2877.0,1883.9,2877.0,2009.1],
  [2877.0,1905.0,2924.3,1905.0],
  [2879.6,1799.4,2978.2,1799.4],
  [2880.9,840.9,2928.2,845.1],
  [2884.9,740.9,2933.5,740.9],
  [2886.2,749.4,2933.5,749.4],
  [2886.2,753.6,2932.2,755.0],
  [2887.5,680.4,3017.6,680.4],
  [2887.5,2200.6,3017.6,2200.6],
  [2892.8,1617.8,3146.3,1617.8],
  [2894.1,1948.6,3036.0,1948.6],
  [2896.7,1957.1,2959.8,1957.1],
  [2896.7,1964.1,2938.7,1965.5],
  [2917.7,790.2,2987.4,790.2],
  [2917.7,1658.7,2975.5,1658.7],
  [2920.4,1664.3,2978.2,1665.7],
  [2920.4,1672.7,2980.8,1675.6],
  [2924.3,2089.4,2987.4,2089.4],
  [2936.1,794.4,3060.9,794.4],
  [2938.7,1081.6,3080.6,1081.6],
  [2940.1,1075.9,3082.0,1075.9],
  [2941.4,1907.8,3104.3,1907.8],
  [2949.3,3170.4,2983.4,3170.4],
  [2951.9,2075.3,2951.9,2202.0],
  [2953.2,679.0,2953.2,804.3],
  [2954.5,1900.8,2954.5,1974.0],
  [2958.5,971.8,3017.6,971.8],
  [2961.1,980.2,3020.2,980.2],
  [2963.7,3149.3,3004.4,3149.3],
  [2965.0,3153.5,3009.7,3153.5],
  [2970.3,742.3,3020.2,742.3],
  [2971.6,1767.0,3147.6,1767.0],
  [2971.6,1772.7,3149.0,1772.7],
  [2972.9,755.0,3041.2,755.0],
  [2975.5,985.8,3021.5,988.7],
  [2975.5,1955.7,3039.9,1955.7],
  [2975.5,1962.7,3039.9,1962.7],
  [2976.8,748.0,3020.2,748.0],
  [2984.7,2080.9,3092.5,2080.9],
  [2986.0,2075.3,3057.0,2075.3],
  [2988.7,1902.2,3237.0,1902.2],
  [2990.0,2007.7,3092.5,2007.7],
  [3005.8,708.6,3071.4,708.6],
  [3005.8,2169.6,3071.4,2171.0],
  [3005.8,2175.2,3071.4,2175.2],
  [3005.8,2180.9,3071.4,2180.9],
  [3020.2,802.9,3091.1,802.9],
  [3020.2,1339.1,3067.5,1339.1],
  [3022.8,1344.8,3067.5,1344.8],
  [3022.8,1351.8,3067.5,1351.8],
  [3028.1,2276.6,3029.4,2316.0],
  [3029.4,546.7,3029.4,643.8],
  [3029.4,1829.0,3095.1,1829.0],
  [3030.7,1715.0,3093.8,1715.0],
  [3030.7,1722.0,3092.5,1722.0],
  [3032.0,1840.2,3095.1,1843.1],
  [3036.0,708.6,3036.0,797.2],
  [3036.0,2075.3,3036.0,2192.1],
  [3038.6,1900.8,3038.6,2009.1],
  [3039.9,1610.8,3039.9,1720.6],
  [3041.2,711.4,3041.2,795.8],
  [3045.2,2075.3,3092.5,2075.3],
  [3046.5,593.1,3049.1,643.8],
  [3046.5,690.3,3204.1,690.3],
  [3049.1,2237.2,3049.1,2334.3],
  [3057.0,743.7,3104.3,743.7],
  [3058.3,1948.6,3106.9,1948.6],
  [3059.6,749.4,3104.3,749.4],
  [3059.6,756.4,3105.6,756.4],
  [3059.6,1961.3,3127.9,1961.3],
  [3059.6,2000.7,3093.8,2003.5],
  [3060.9,679.0,3191.0,679.0],
  [3060.9,1965.5,3106.9,1965.5],
  [3060.9,2200.6,3149.0,2200.6],
  [3063.6,798.6,3092.5,798.6],
  [3064.9,2133.0,3091.1,2133.0],
  [3075.4,1658.7,3101.7,1660.1],
  [3076.7,2121.7,3103.0,2121.7],
  [3078.0,1068.9,3121.4,1068.9],
  [3084.6,1647.4,3130.6,1647.4],
  [3089.8,787.4,3162.1,787.4],
  [3089.8,795.8,3265.9,795.8],
  [3089.8,1996.5,3159.5,1996.5],
  [3089.8,2083.7,3265.9,2083.7],
  [3091.1,2093.6,3160.8,2093.6],
  [3103.0,2704.5,3173.9,2704.5],
  [3105.6,1083.0,3650.8,1083.0],
  [3108.2,3191.5,3155.5,3191.5],
  [3118.7,870.4,3118.7,1077.3],
  [3116.1,1060.4,3222.5,1060.4],
  [3124.0,679.0,3124.0,804.3],
  [3122.7,742.3,3192.3,742.3],
  [3122.7,2142.9,3168.7,2142.9],
  [3124.0,870.4,3162.1,870.4],
  [3125.3,2075.3,3125.3,2202.0],
  [3126.6,1902.2,3126.6,2009.1],
  [3130.6,1647.4,3130.6,1722.0],
  [3135.8,2200.6,3188.4,2202.0],
  [3138.4,959.1,3188.4,963.3],
  [3141.1,978.8,3183.1,978.8],
  [3143.7,738.1,3191.0,738.1],
  [3145.0,750.8,3184.4,752.2],
  [3145.0,756.4,3192.3,756.4],
  [3149.0,1948.6,3214.6,1948.6],
  [3150.3,1955.7,3214.6,1955.7],
  [3150.3,1964.1,3214.6,1964.1],
  [3150.3,2131.6,3176.5,2131.6],
  [3156.8,2002.1,3202.8,2002.1],
  [3158.2,2006.3,3265.9,2006.3],
  [3159.5,802.9,3264.6,802.9],
  [3159.5,2075.3,3206.8,2075.3],
  [3160.8,1902.2,3229.1,1905.0],
  [3162.1,2120.3,3188.4,2120.3],
  [3168.7,1772.7,3297.4,1772.7],
  [3170.0,1613.6,3650.8,1613.6],
  [3179.2,708.6,3244.9,708.6],
  [3179.2,2171.0,3244.9,2171.0],
  [3179.2,2176.6,3244.9,2176.6],
  [3179.2,2183.7,3244.9,2183.7],
  [3181.8,1634.7,3183.1,1705.1],
  [3189.7,679.0,3189.7,711.4],
  [3193.6,892.9,3259.3,892.9],
  [3193.6,1821.9,3229.1,1821.9],
  [3201.5,2237.2,3202.8,2332.9],
  [3202.8,546.7,3202.8,643.8],
  [3206.8,3181.6,3252.7,3181.6],
  [3209.4,708.6,3210.7,767.7],
  [3209.4,739.5,3276.4,739.5],
  [3209.4,743.7,3277.7,743.7],
  [3210.7,895.8,3210.7,1059.0],
  [3212.0,2075.3,3212.0,2192.1],
  [3213.3,1713.6,3298.7,1715.0],
  [3213.3,1719.2,3293.5,1722.0],
  [3213.3,1900.8,3213.3,1985.2],
  [3214.6,708.6,3216.0,795.8],
  [3214.6,1667.1,3214.6,1772.7],
  [3216.0,2075.3,3258.0,2076.7],
  [3221.2,546.7,3221.2,643.8],
  [3219.9,1084.4,3219.9,1244.8],
  [3221.2,690.3,3328.9,691.7],
  [3221.2,1075.9,3548.4,1075.9],
  [3223.8,1143.5,3223.8,1585.5],
  [3221.2,1450.3,3221.2,1636.1],
  [3221.2,2002.1,3265.9,2002.1],
  [3221.2,2237.2,3221.2,2332.9],
  [3222.5,1619.2,3547.0,1619.2],
  [3222.5,1660.1,3248.8,1661.5],
  [3222.5,1716.4,3222.5,1772.7],
  [3225.2,1084.4,3225.2,1360.3],
  [3226.5,1444.7,3226.5,1484.1],
  [3229.1,3174.6,3255.4,3174.6],
  [3230.4,749.4,3277.7,749.4],
  [3230.4,755.0,3276.4,756.4],
  [3230.4,1950.0,3279.0,1951.4],
  [3233.0,679.0,3363.1,679.0],
  [3233.0,1647.4,3259.3,1647.4],
  [3233.0,1958.5,3280.3,1958.5],
  [3233.0,1964.1,3280.3,1964.1],
  [3235.7,2085.2,3334.2,2085.2],
  [3235.7,2202.0,3363.1,2202.0],
  [3237.0,1715.0,3239.6,1772.7],
  [3239.6,2131.6,3267.2,2131.6],
  [3242.2,1767.0,3293.5,1769.9],
  [3248.8,2123.2,3276.4,2123.2],
  [3250.1,2117.5,3276.4,2118.9],
  [3259.3,873.2,3515.5,873.2],
  [3261.9,788.8,3334.2,788.8],
  [3261.9,1902.2,3326.3,1902.2],
  [3263.3,3156.3,3336.8,3156.3],
  [3264.6,2093.6,3331.6,2093.6],
  [3269.8,1831.8,3317.1,1831.8],
  [3272.5,3178.8,3317.1,3178.8],
  [3276.4,3152.1,3336.8,3152.1],
  [3279.0,1620.7,3283.0,1722.0],
  [3280.3,1703.7,3306.6,1705.1],
  [3285.6,798.6,3311.9,798.6],
  [3285.6,1620.7,3285.6,1722.0],
  [3288.2,3169.0,3314.5,3169.0],
  [3296.1,679.0,3296.1,804.3],
  [3296.1,1948.6,3364.4,1951.4],
  [3298.7,1900.8,3298.7,2009.1],
  [3300.0,2075.3,3300.0,2200.6],
  [3315.8,1715.0,3472.2,1715.0],
  [3317.1,736.7,3448.5,736.7],
  [3317.1,1720.6,3466.9,1720.6],
  [3317.1,1955.7,3364.4,1955.7],
  [3317.1,1962.7,3359.2,1962.7],
  [3318.4,745.2,3388.1,745.2],
  [3318.4,750.8,3388.1,750.8],
  [3318.4,1769.9,3385.4,1769.9],
  [3321.1,756.4,3365.7,756.4],
  [3327.6,2128.8,3353.9,2128.8],
  [3331.6,795.8,3470.8,795.8],
  [3331.6,2002.1,3388.1,2002.1],
  [3331.6,2009.1,3388.1,2009.1],
  [3331.6,2078.1,3438.0,2078.1],
  [3331.6,2080.9,3373.6,2080.9],
  [3332.9,802.9,3447.2,802.9],
  [3336.8,2118.9,3364.4,2118.9],
  [3352.6,2171.0,3417.0,2171.0],
  [3352.6,2178.1,3417.0,2178.1],
  [3352.6,2182.3,3417.0,2182.3],
  [3353.9,1902.2,3386.8,1902.2],
  [3374.9,2237.2,3374.9,2331.5],
  [3376.2,546.7,3376.2,643.8],
  [3378.9,687.4,3448.5,687.4],
  [3382.8,710.0,3382.8,804.3],
  [3384.1,1767.0,3384.1,1869.8],
  [3382.8,1986.6,3530.0,1986.6],
  [3382.8,1992.3,3547.0,1992.3],
  [3382.8,2082.3,3410.4,2085.2],
  [3384.1,976.0,3432.7,976.0],
  [3384.1,981.6,3432.7,981.6],
  [3385.4,1896.5,3385.4,2007.7],
  [3385.4,1664.3,3447.2,1664.3],
  [3385.4,1669.9,3445.9,1669.9],
  [3385.4,1814.9,3415.7,1816.3],
  [3385.4,2075.3,3386.8,2192.1],
  [3393.3,588.9,3394.6,641.0],
  [3393.3,2237.2,3393.3,2334.3],
  [3396.0,1654.4,3444.6,1655.8],
  [3405.1,745.2,3445.9,745.2],
  [3405.1,752.2,3448.5,752.2],
  [3405.1,1342.0,3455.1,1342.0],
  [3406.5,679.0,3476.1,679.0],
  [3406.5,1350.4,3455.1,1350.4],
  [3406.5,1358.8,3453.8,1358.8],
  [3406.5,2202.0,3533.9,2202.0],
  [3414.3,2134.4,3440.6,2134.4],
  [3415.7,2128.8,3441.9,2128.8],
  [3424.9,2120.3,3452.4,2120.3],
  [3435.4,2088.0,3507.6,2088.0],
  [3436.7,2095.0,3505.0,2095.0],
  [3444.6,791.6,3579.9,791.6],
  [3444.6,1767.0,3508.9,1767.0],
  [3444.6,1772.7,3649.5,1772.7],
  [3449.8,690.3,3476.1,690.3],
  [3465.6,795.8,3497.1,797.2],
  [3468.2,2103.5,3473.5,2187.9],
  [3476.1,2262.5,3476.1,2420.2],
  [3476.1,2437.0,3476.1,2482.1],
  [3477.4,504.5,3477.4,804.3],
  [3477.4,786.0,3662.7,786.0],
  [3480.0,503.0,3552.3,504.5],
  [3485.3,2366.7,3485.3,2534.2],
  [3486.6,503.0,3486.6,804.3],
  [3486.6,2339.9,3487.9,2370.9],
  [3491.9,2407.5,3491.9,2534.2],
  [3489.2,2407.5,3493.2,2453.9],
  [3490.5,1715.0,3569.4,1715.0],
  [3491.9,1720.6,3566.7,1720.6],
  [3494.5,1890.9,3541.8,1892.3],
  [3494.5,2414.5,3497.1,2453.9],
  [3505.0,1997.9,3547.0,1997.9],
  [3505.0,2131.6,3532.6,2131.6],
  [3511.6,2449.7,3516.8,2534.2],
  [3514.2,884.5,3547.0,887.3],
  [3514.2,2120.3,3541.8,2120.3],
  [3515.5,2075.3,3569.4,2075.3],
  [3516.8,2080.9,3569.4,2082.3],
  [3524.7,2175.2,3570.7,2175.2],
  [3524.7,2180.9,3570.7,2180.9],
  [3524.7,2449.7,3526.0,2534.2],
  [3524.7,2705.9,3597.0,2705.9],
  [3530.0,2106.3,3530.0,2134.4],
  [3532.6,2449.7,3539.2,2534.2],
  [3535.2,2169.6,3535.2,2199.2],
  [3537.8,797.2,3577.3,797.2],
  [3539.2,2441.3,3545.7,2534.2],
  [3540.5,2007.7,3646.9,2007.7],
  [3541.8,1767.0,3649.5,1767.0],
  [3543.1,873.2,3650.8,873.2],
  [3544.4,2465.2,3544.4,2532.8],
  [3545.7,897.2,3649.5,897.2],
  [3545.7,1059.0,3547.0,1164.6],
  [3545.7,1161.8,3650.8,1161.8],
  [3545.7,1982.4,3649.5,1982.4],
  [3547.0,503.0,3547.0,804.3],
  [3547.0,721.2,3575.9,721.2],
  [3547.0,752.2,3606.2,753.6],
  [3547.0,1123.8,3649.5,1123.8],
  [3547.0,1133.6,3587.8,1133.6],
  [3547.0,1143.5,3644.3,1146.3],
  [3551.0,1084.4,3552.3,1159.0],
  [3551.0,2168.2,3552.3,2196.3],
  [3552.3,712.8,3552.3,804.3],
  [3552.3,726.9,3589.1,728.3],
  [3552.3,738.1,3589.1,738.1],
  [3552.3,759.2,3606.2,759.2],
  [3552.3,788.8,3653.5,788.8],
  [3553.6,711.4,3589.1,711.4],
  [3556.2,1636.1,3556.2,1722.0],
  [3556.2,2199.2,3556.2,2275.2],
  [3564.1,1126.6,3564.1,1164.6],
  [3562.8,2075.3,3562.8,2173.8],
  [3562.8,2441.3,3562.8,2532.8],
  [3566.7,2002.1,3649.5,2002.1],
  [3568.1,522.8,3942.5,522.8],
  [3568.1,642.4,3727.0,642.4],
  [3569.4,483.3,3569.4,804.3],
  [3568.1,877.5,3614.0,877.5],
  [3568.1,890.1,3642.9,891.5],
  [3568.1,1989.4,3604.8,1990.8],
  [3568.1,2089.4,3568.1,2275.2],
  [3569.4,2158.3,3569.4,2275.2],
  [3569.4,2441.3,3569.4,2534.2],
  [3569.4,1129.4,3572.0,1164.6],
  [3573.3,483.3,3573.3,643.8],
  [3573.3,552.3,3573.3,643.8],
  [3575.9,604.4,3575.9,757.8],
  [3575.9,2441.3,3578.6,2499.0],
  [3577.3,2042.9,3629.8,2045.7],
  [3579.9,2057.0,3678.4,2057.0],
  [3579.9,2062.6,3641.6,2062.6],
  [3583.8,483.3,3583.8,532.6],
  [3582.5,583.3,3586.5,642.4],
  [3586.5,676.2,3586.5,759.2],
  [3589.1,1111.1,3589.1,1164.6],
  [3587.8,483.3,3590.4,532.6],
  [3590.4,1713.6,3650.8,1715.0],
  [3591.7,2489.1,3593.0,2534.2],
  [3597.0,483.3,3597.0,563.6],
  [3594.3,1116.7,3597.0,1159.0],
  [3597.0,1657.3,3597.0,1686.8],
  [3594.3,1662.9,3620.6,1664.3],
  [3595.6,798.6,3707.3,798.6],
  [3599.6,871.8,3599.6,1032.3],
  [3602.2,1111.1,3602.2,1164.6],
  [3600.9,622.7,3600.9,670.6],
  [3602.2,483.3,3604.8,563.6],
  [3604.8,871.8,3604.8,953.5],
  [3604.8,990.1,3604.8,1064.7],
  [3603.5,1651.6,3650.8,1651.6],
  [3604.8,985.8,3606.2,1016.8],
  [3607.5,1106.9,3607.5,1164.6],
  [3607.5,1641.8,3607.5,1677.0],
  [3606.2,1619.2,3641.6,1619.2],
  [3607.5,625.5,3607.5,669.1],
  [3608.8,871.8,3612.7,921.1],
  [3611.4,939.4,3612.7,978.8],
  [3614.0,1105.5,3614.0,1188.5],
  [3611.4,2452.5,3612.7,2534.2],
  [3612.7,626.9,3612.7,669.1],
  [3612.7,1001.3,3615.4,1032.3],
  [3618.0,483.3,3618.0,532.6],
  [3616.7,1251.9,3648.2,1251.9],
  [3619.3,939.4,3619.3,978.8],
  [3620.6,995.7,3620.6,1035.1],
  [3618.0,1636.1,3618.0,1667.1],
  [3620.6,2449.7,3620.6,2534.2],
  [3623.2,1123.8,3623.2,1195.6],
  [3625.9,871.8,3625.9,1075.9],
  [3628.5,1125.2,3628.5,1191.3],
  [3627.2,1325.1,3627.2,1364.5],
  [3631.1,483.3,3631.1,563.6],
  [3629.8,1125.2,3629.8,1257.5],
  [3631.1,871.8,3631.1,1097.0],
  [3633.8,1437.7,3633.8,1519.3],
  [3632.4,1740.3,3633.8,1774.1],
  [3632.4,2487.7,3632.4,2534.2],
  [3633.8,802.9,3702.1,804.3],
  [3633.8,1129.4,3636.4,1174.5],
  [3636.4,1202.6,3639.0,1232.2],
  [3640.3,483.3,3640.3,531.2],
  [3637.7,1463.0,3639.0,1492.6],
  [3641.6,1094.2,3641.6,1181.5],
  [3641.6,1606.6,3641.6,1821.9],
  [3640.3,593.1,3871.5,593.1],
  [3640.3,653.7,3762.5,655.1],
  [3640.3,687.4,3640.3,724.0],
  [3640.3,695.9,3761.2,695.9],
  [3640.3,702.9,3698.1,702.9],
  [3640.3,729.7,3696.8,729.7],
  [3640.3,743.7,3696.8,743.7],
  [3640.3,760.6,3698.1,760.6],
  [3640.3,767.7,3698.1,767.7],
  [3642.9,597.4,3642.9,664.9],
  [3642.9,1325.1,3642.9,1443.3],
  [3642.9,1513.7,3642.9,1596.7],
  [3642.9,1578.4,3644.3,1630.5],
  [3642.9,1791.0,3642.9,1947.2],
  [3644.3,1909.2,3644.3,2009.1],
  [3642.9,2076.7,3828.2,2076.7],
  [3642.9,2083.7,3858.4,2083.7],
  [3642.9,2090.8,3721.8,2090.8],
  [3642.9,2097.8,3686.3,2097.8],
  [3642.9,2131.6,3782.2,2131.6],
  [3642.9,2134.4,3733.6,2134.4],
  [3644.3,1250.5,3644.3,1282.8],
  [3646.9,2168.2,3646.9,2410.3],
  [3646.9,687.4,3646.9,804.3],
  [3648.2,795.8,3784.8,795.8],
  [3649.5,1092.8,3649.5,1181.5],
  [3649.5,1513.7,3649.5,1605.2],
  [3649.5,1579.8,3649.5,1688.2],
  [3649.5,1250.5,3649.5,1443.3],
  [3649.5,1698.1,3650.8,1730.4],
  [3649.5,1758.6,3649.5,2009.1],
  [3649.5,2273.8,3649.5,2313.2],
  [3650.8,2324.4,3650.8,2534.2],
  [3650.8,2214.6,3650.8,2249.8],
  [3650.8,2332.9,3782.2,2332.9],
  [3652.1,2327.3,3791.4,2327.3],
  [3653.5,697.3,3653.5,725.4],
  [3653.5,2075.3,3657.4,2169.6],
  [3657.4,483.3,3657.4,521.3],
  [3660.0,622.7,3660.0,677.6],
  [3660.0,2418.7,3662.7,2508.8],
  [3661.3,726.9,3662.7,773.3],
  [3666.6,597.4,3666.6,676.2],
  [3664.0,752.2,3698.1,753.6],
  [3667.9,484.8,3669.2,563.6],
  [3671.9,604.4,3671.9,674.8],
  [3675.8,2051.4,3675.8,2116.1],
  [3681.0,525.6,3681.0,605.8],
  [3681.0,783.2,3840.0,783.2],
  [3681.0,1923.3,3745.4,1923.3],
  [3682.4,995.7,3742.8,997.1],
  [3682.4,1612.2,3745.4,1616.4],
  [3682.4,1619.2,3746.7,1619.2],
  [3682.4,2532.8,3685.0,2587.7],
  [3683.7,1938.8,3745.4,1938.8],
  [3685.0,793.0,3774.3,793.0],
  [3685.0,1629.1,3746.7,1631.9],
  [3685.0,1931.7,3745.4,1931.7],
  [3686.3,2361.0,3744.1,2361.0],
  [3687.6,697.3,3691.6,804.3],
  [3688.9,586.1,3692.9,635.4],
  [3688.9,676.2,3759.9,683.2],
  [3688.9,684.6,3761.2,684.6],
  [3691.6,2193.5,3737.5,2193.5],
  [3692.9,853.5,3740.2,857.8],
  [3692.9,1353.2,3740.2,1353.2],
  [3692.9,1363.1,3737.5,1365.9],
  [3692.9,2202.0,3737.5,2202.0],
  [3696.8,534.0,3696.8,565.0],
  [3696.8,619.9,3698.1,778.9],
  [3699.4,2393.4,3699.4,2472.2],
  [3698.1,534.0,3942.5,534.0],
  [3698.1,2559.5,3699.4,2587.7],
  [3704.7,1346.2,3740.2,1349.0],
  [3716.5,2235.8,3716.5,2299.1],
  [3715.2,2247.0,3783.5,2248.4],
  [3717.8,2235.8,3782.2,2240.0],
  [3721.8,2448.3,3721.8,2587.7],
  [3723.1,2235.8,3723.1,2323.0],
  [3723.1,2092.2,3782.2,2092.2],
  [3724.4,802.9,3812.4,802.9],
  [3724.4,2116.1,3782.2,2116.1],
  [3725.7,2448.3,3725.7,2587.7],
  [3727.0,557.9,3779.6,557.9],
  [3732.3,2075.3,3732.3,2134.4],
  [3733.6,2393.4,3733.6,2493.3],
  [3729.7,2407.5,3795.3,2407.5],
  [3731.0,2539.8,3734.9,2587.7],
  [3732.3,2235.8,3737.5,2301.9],
  [3738.9,2097.8,3782.2,2097.8],
  [3738.9,2235.8,3741.5,2296.3],
  [3740.2,2393.4,3740.2,2455.3],
  [3741.5,719.8,3791.4,722.6],
  [3741.5,2539.8,3745.4,2587.7],
  [3744.1,728.3,3792.7,728.3],
  [3744.1,732.5,3792.7,732.5],
  [3744.1,738.1,3790.1,738.1],
  [3744.1,2259.7,3783.5,2262.5],
  [3745.4,2393.4,3750.7,2451.1],
  [3750.7,2235.8,3750.7,2293.5],
  [3749.4,2075.3,3753.3,2134.4],
  [3752.0,2110.5,3782.2,2110.5],
  [3753.3,2507.4,3757.2,2587.7],
  [3755.9,793.0,3840.0,793.0],
  [3759.9,555.1,3759.9,697.3],
  [3757.2,770.5,3787.5,770.5],
  [3757.2,776.1,3840.0,776.1],
  [3757.2,2052.8,3832.1,2052.8],
  [3757.2,2054.2,3759.9,2111.9],
  [3759.9,2235.8,3762.5,2286.4],
  [3771.7,2235.8,3773.0,2279.4],
  [3774.3,2393.4,3774.3,2451.1],
  [3780.9,826.8,3780.9,1294.1],
  [3780.9,1399.7,4252.6,1399.7],
  [3780.9,1412.3,4252.6,1412.3],
  [3780.9,1858.5,3997.7,1858.5],
  [3780.9,1867.0,3992.4,1867.0],
  [3780.9,2137.2,3780.9,2587.7],
  [3780.9,2376.5,4059.4,2376.5],
  [3780.9,2389.2,4418.1,2389.2],
  [3782.2,883.1,3829.5,883.1],
  [3782.2,1294.1,3920.2,1294.1],
  [3782.2,1460.2,3782.2,1819.1],
  [3782.2,2047.1,3830.8,2047.1],
  [3783.5,826.8,3883.4,826.8],
  [3784.8,763.4,3840.0,763.4],
  [3784.8,2045.7,3784.8,2083.7],
  [3784.8,2062.6,3832.1,2062.6],
  [3784.8,2399.0,3786.2,2483.5],
  [3791.4,825.4,3791.4,1347.6],
  [3791.4,1458.8,3791.4,1592.5],
  [3791.4,1574.2,3792.7,1613.6],
  [3791.4,1669.9,3791.4,1817.7],
  [3792.7,2075.3,3792.7,2587.7],
  [3795.3,2073.9,3883.4,2073.9],
  [3798.0,1350.4,3800.6,1395.4],
  [3804.5,1356.0,3807.2,1388.4],
  [3812.4,793.0,3840.0,794.4],
  [3826.9,883.1,3826.9,964.7],
  [3825.6,894.4,3867.6,894.4],
  [3825.6,900.0,3866.3,904.2],
  [3826.9,536.8,3829.5,598.8],
  [3828.2,624.1,3928.0,624.1],
  [3828.2,631.1,3942.5,631.1],
  [3828.2,655.1,3942.5,655.1],
  [3828.2,726.9,3928.0,728.3],
  [3828.2,742.3,3895.2,745.2],
  [3829.5,930.9,3866.3,933.8],
  [3829.5,963.3,3866.3,964.7],
  [3829.5,1282.8,3922.8,1285.7],
  [3833.4,890.1,3840.0,966.1],
  [3841.3,536.8,3841.3,673.4],
  [3842.6,890.1,3842.6,966.1],
  [3847.9,583.3,3847.9,743.7],
  [3847.9,831.0,3886.0,832.4],
  [3849.2,1349.0,4072.6,1349.0],
  [3849.2,1374.3,3989.8,1374.3],
  [3850.5,586.1,3854.5,655.1],
  [3853.2,677.6,3854.5,710.0],
  [3854.5,890.1,3859.7,966.1],
  [3854.5,1702.3,3904.4,1703.7],
  [3855.8,1710.7,3904.4,1712.1],
  [3855.8,1717.8,3904.4,1717.8],
  [3861.0,590.3,3861.0,657.9],
  [3858.4,648.0,3928.0,648.0],
  [3859.7,825.4,3968.8,825.4],
  [3861.0,876.1,3868.9,966.1],
  [3862.4,873.2,4072.6,873.2],
  [3863.7,636.8,3928.0,642.4],
  [3871.5,597.4,3875.5,648.0],
  [3892.6,1550.3,3895.2,1636.1],
  [3892.6,1983.8,3892.6,2152.7],
  [3893.9,726.9,3893.9,804.3],
  [3893.9,1244.8,4016.1,1244.8],
  [3893.9,1553.1,3926.7,1554.5],
  [3893.9,1981.0,3989.8,1981.0],
  [3895.2,1584.1,3951.7,1589.7],
  [3897.8,1581.2,3899.1,1615.0],
  [3900.5,2237.2,3950.4,2237.2],
  [3903.1,2247.0,3949.1,2248.4],
  [3905.7,1319.4,3955.6,1319.4],
  [3908.3,1325.1,3955.6,1327.9],
  [3908.3,1337.7,3950.4,1337.7],
  [3914.9,1867.0,3914.9,2152.7],
  [3913.6,2044.3,3992.4,2044.3],
  [3914.9,2055.6,3983.2,2055.6],
  [3916.2,1599.5,3968.8,1599.5],
  [3916.2,2704.5,3978.0,2704.5],
  [3920.2,1938.8,3920.2,1969.7],
  [3926.7,536.8,3926.7,743.7],
  [3929.4,1265.9,3995.0,1265.9],
  [3930.7,825.4,4102.8,825.4],
  [3935.9,3191.5,3983.2,3191.5],
  [3938.6,1630.5,3983.2,1631.9],
  [3938.6,1636.1,3983.2,1636.1],
  [3941.2,525.6,3941.2,839.5],
  [3941.2,1553.1,3983.2,1555.9],
  [3942.5,1320.8,3942.5,1349.0],
  [3943.8,1278.6,4039.7,1278.6],
  [3946.4,1249.1,4016.1,1250.5],
  [3946.4,1254.7,4016.1,1256.1],
  [3958.3,838.1,4030.5,838.1],
  [3964.8,1917.7,4013.4,1917.7],
  [3964.8,2014.8,4001.6,2017.6],
  [3966.1,2007.7,3996.4,2010.6],
  [3967.5,1923.3,4014.8,1923.3],
  [3967.5,1931.7,4013.4,1933.1],
  [3967.5,2023.2,4012.1,2023.2],
  [3967.5,2028.8,4010.8,2028.8],
  [3968.8,2055.6,4067.3,2055.6],
  [3972.7,2044.3,4066.0,2044.3],
  [3975.3,1209.6,4016.1,1211.1],
  [3975.3,1215.3,4016.1,1216.7],
  [3975.3,1226.5,4016.1,1227.9],
  [3984.5,1413.7,3984.5,1826.2],
  [3984.5,2009.1,3984.5,2057.0],
  [3987.2,1981.0,4085.7,1981.0],
  [3989.8,1399.7,3989.8,1868.4],
  [3991.1,1204.0,3991.1,1295.5],
  [3992.4,1993.7,4066.0,1995.1],
  [3995.0,1986.6,4085.7,1986.6],
  [3996.4,1068.9,4043.7,1068.9],
  [3997.7,825.4,4067.3,825.4],
  [3997.7,1081.6,4046.3,1081.6],
  [3997.7,1353.2,4072.6,1353.2],
  [3999.0,1294.1,4092.3,1295.5],
  [4016.1,1284.2,4092.3,1284.2],
  [4017.4,1857.1,4221.0,1857.1],
  [4020.0,1868.4,4365.5,1868.4],
  [4025.3,838.1,4140.9,838.1],
  [4050.2,3171.8,4081.8,3171.8],
  [4058.1,2406.1,4431.2,2406.1],
  [4059.4,2141.5,4059.4,2375.1],
  [4067.3,1981.0,4067.3,2390.6],
  [4075.2,826.8,4260.4,826.8],
  [4085.7,726.9,4085.7,804.3],
  [4085.7,1868.4,4085.7,2152.7],
  [4088.3,1631.9,4147.4,1631.9],
  [4091.0,1637.5,4150.1,1637.5],
  [4091.0,1646.0,4151.4,1646.0],
  [4092.3,876.1,4186.9,876.1],
  [4097.5,871.8,4155.3,871.8],
  [4106.7,3157.7,4179.0,3157.7],
  [4106.7,3166.2,4158.0,3166.2],
  [4106.7,3177.4,4156.6,3177.4],
  [4112.0,1282.8,4260.4,1282.8],
  [4117.2,1294.1,4251.2,1294.1],
  [4122.5,1857.1,4171.1,1858.5],
  [4129.1,726.9,4259.1,726.9],
  [4129.1,740.9,4240.7,740.9],
  [4129.1,753.6,4163.2,753.6],
  [4129.1,815.5,4158.0,815.5],
  [4139.6,832.4,4240.7,832.4],
  [4176.4,791.6,4203.9,791.6],
  [4186.9,3177.4,4239.4,3177.4],
  [4203.9,894.4,4203.9,1112.5],
  [4203.9,1243.4,4252.6,1243.4],
  [4205.3,1133.6,4205.3,1249.1],
  [4206.6,1855.7,4286.7,1855.7],
  [4207.9,900.0,4207.9,1111.1],
  [4223.6,815.5,4249.9,815.5],
  [4239.4,1982.4,4418.1,1982.4],
  [4239.4,1982.4,4239.4,2152.7],
  [4251.2,894.4,4252.6,1032.3],
  [4251.2,1080.2,4251.2,1244.8],
  [4251.2,1450.3,4251.2,1615.0],
  [4251.2,1852.9,4407.6,1852.9],
  [4252.6,826.8,4252.6,873.2],
  [4252.6,1265.9,4252.6,1429.2],
  [4252.6,1636.1,4252.6,1800.8],
  [4259.1,1979.6,4259.1,2152.7],
  [4261.7,826.8,4261.7,1868.4],
  [4269.6,1928.9,4318.2,1928.9],
  [4274.9,3191.5,4337.9,3191.5],
  [4280.1,2704.5,4340.6,2704.5],
  [4284.1,1895.1,4326.1,1899.4],
  [4284.1,1902.2,4324.8,1906.4],
  [4284.1,1910.6,4323.5,1912.0],
  [4284.1,1941.6,4313.0,1944.4],
  [4284.1,1972.5,4429.9,1972.5],
  [4394.4,1867.0,4420.7,1868.4],
  [4418.1,1974.0,4418.1,2390.6],
  [4432.5,1852.9,4432.5,2407.5],
  [4541.6,2704.5,4592.8,2704.5],
  [4546.8,3191.5,4608.6,3191.5],
  [4948.9,63.9,4948.9,3305.5]
];

// ── NAVIGATION GRAPH ──
const NAV_RAW = RAW.map(r => ({ id: `p${r.id}`, x: tx(r.x), y: ty(r.y), label: r.label, feat: r }));

// ── ORIGINAL EDGES (before intermediate waypoints) ──
const EDGES_BASE = [
  ["p201","p131"], // exit2-h6
  ["p131","p129"], // h6-h4
  ["p129","p135"], // h4-h10
  ["p129","p107"], // h4-h12
  ["p107","p120"], // h12-h13
  ["p107","p128"], // h12-h3
  ["p128","p64"],  // h3-h14
  ["p128","p98"],  // h3-h15
  ["p98","p8"],    // h15-h16
  ["p98","p133"],  // h15-h8
  ["p133","p134"], // h8-h9
  ["p134","p200"], // h9-exit1
  ["p134","p130"], // h9-h5
  ["p130","p101"], // h5-h20
  ["p101","p135"], // h20-h10
  ["p129","p100"], // h4-h19
  ["p100","p133"], // h19-h8
  ["p64","p127"],  // h14-h2
  ["p127","p112"], // h2-h21
  ["p112","p110"], // h21-h11
  ["p112","p120"], // h21-h13
  ["p120","p202"], // h13-exit3
  ["p8","p95"],    // h16-h18
  ["p8","p126"],   // h16-h1
  ["p126","p203"], // h1-exit4
  ["p126","p127"], // h1-h2
  ["p126","p118"], // h1-h17
];

// ── AUTO-GENERATE INTERMEDIATE WAYPOINTS ──
// First pass: Create initial waypoints along edges
const WAYPOINT_INTERVAL = 80; // SVG units between waypoints
const EXTRA = [];
const EDGES = [];
let waypointCounter = 10000; // Start IDs at 10000 to avoid conflicts

EDGES_BASE.forEach(([nodeA, nodeB], edgeIdx) => {
  const nA = NAV_RAW.find(n => n.id === nodeA);
  const nB = NAV_RAW.find(n => n.id === nodeB);

  if (!nA || !nB) {
    EDGES.push([nodeA, nodeB]);
    return;
  }

  const dx = nB.x - nA.x;
  const dy = nB.y - nA.y;
  const dist = Math.sqrt(dx * dx + dy * dy);

  if (dist < WAYPOINT_INTERVAL * 1.5) {
    EDGES.push([nodeA, nodeB]);
    return;
  }

  const numWaypoints = Math.floor(dist / WAYPOINT_INTERVAL);
  const waypoints = [];

  for (let i = 1; i <= numWaypoints; i++) {
    const t = i / (numWaypoints + 1);
    const wpId = `pw${waypointCounter++}`;
    const wpX = nA.x + dx * t;
    const wpY = nA.y + dy * t;

    EXTRA.push({
      id: wpId,
      x: wpX,
      y: wpY,
      label: `·`,
      feat: {
        id: waypointCounter,
        type: "WAYPOINT",
        hallway: true,
        color: "green",
        x: wpX / 0.4 + 1309,
        y: wpY / 0.4 + 330.5,
      }
    });

    waypoints.push(wpId);
  }

  let prev = nodeA;
  for (const wp of waypoints) {
    EDGES.push([prev, wp]);
    prev = wp;
  }
  EDGES.push([prev, nodeB]);
});

// ── SECOND PASS: ADD 100 ADDITIONAL HALLWAY NODES ──
// Distribute them evenly along ALL existing hallway edges
const ADDITIONAL_WAYPOINTS = 500;

// Collect all hallway-to-hallway edges with their lengths
const hallwayEdges = [];
EDGES.forEach(([a, b]) => {
  const nA = NAV_RAW.find(n => n.id === a) || EXTRA.find(n => n.id === a);
  const nB = NAV_RAW.find(n => n.id === b) || EXTRA.find(n => n.id === b);
  
  if (!nA || !nB) return;
  
  // Only consider hallway-to-hallway connections
  const isAHallway = nA.feat?.hallway === true || nA.feat?.type === "WAYPOINT" || nA.feat?.color === "green";
  const isBHallway = nB.feat?.hallway === true || nB.feat?.type === "WAYPOINT" || nB.feat?.color === "green";
  
  if (isAHallway && isBHallway) {
    const dx = nB.x - nA.x;
    const dy = nB.y - nA.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    
    if (dist > 20) {
      hallwayEdges.push({ a, b, nA, nB, dist, dx, dy });
    }
  }
});

// Calculate total hallway length
const totalHallwayLength = hallwayEdges.reduce((sum, edge) => sum + edge.dist, 0);

// Distribute 100 waypoints proportionally by edge length
const waypointsToAdd = [];
let remainingWaypoints = ADDITIONAL_WAYPOINTS;

hallwayEdges.forEach((edge, idx) => {
  const proportion = edge.dist / totalHallwayLength;
  let count = Math.round(proportion * ADDITIONAL_WAYPOINTS);
  
  if (idx === hallwayEdges.length - 1) {
    count = remainingWaypoints;
  } else {
    remainingWaypoints -= count;
  }
  
  if (count > 0) {
    waypointsToAdd.push({ ...edge, count });
  }
});

// Generate and insert the additional waypoints
const newEdges = [];
const processedEdges = new Set();

EDGES.forEach(([a, b]) => {
  const edgeKey = `${a}-${b}`;
  const reverseKey = `${b}-${a}`;
  
  const edgeToProcess = waypointsToAdd.find(e => 
    (e.a === a && e.b === b) || (e.a === b && e.b === a)
  );
  
  if (edgeToProcess && !processedEdges.has(edgeKey) && !processedEdges.has(reverseKey)) {
    processedEdges.add(edgeKey);
    
    const { nA, nB, dx, dy, count } = edgeToProcess;
    const isReversed = edgeToProcess.a === b;
    const startNode = isReversed ? nB : nA;
    const endNode = isReversed ? nA : nB;
    const actualDx = isReversed ? -dx : dx;
    const actualDy = isReversed ? -dy : dy;
    
    const newWaypoints = [];
    
    for (let i = 1; i <= count; i++) {
      const t = i / (count + 1);
      const wpId = `ph${waypointCounter++}`;
      const wpX = startNode.x + actualDx * t;
      const wpY = startNode.y + actualDy * t;
      
      EXTRA.push({
        id: wpId,
        x: wpX,
        y: wpY,
        label: `•`,
        feat: {
          id: waypointCounter,
          type: "WAYPOINT",
          hallway: true,
          color: "green",
          priority: true,
          x: wpX / 0.4 + 1309,
          y: wpY / 0.4 + 330.5,
        }
      });
      
      newWaypoints.push(wpId);
    }
    
    let prev = a;
    for (const wp of newWaypoints) {
      newEdges.push([prev, wp]);
      prev = wp;
    }
    newEdges.push([prev, b]);
    
  } else {
    newEdges.push([a, b]);
  }
});

// Replace EDGES with new segmented edges
EDGES.length = 0;
EDGES.push(...newEdges);

console.log(`✅ Generated ${ADDITIONAL_WAYPOINTS} additional hallway waypoints`);
console.log(`📊 Total waypoints: ${EXTRA.length} across ${EDGES.length} edge segments`);

const NODES = [...NAV_RAW, ...EXTRA];
const NM = {}; NODES.forEach(n => NM[n.id] = n);

// ── HALLWAY-ONLY NAVIGATION ──
// Only hallway nodes and exits can be used for pathfinding
const HALLWAY_NODES = NODES.filter(n =>
  n.feat.hallway === true ||
  n.feat.type === "EXIT" ||
  n.feat.type === "WAYPOINT" ||
  n.feat.color === "green"
);
const HALLWAY_NODE_IDS = new Set(HALLWAY_NODES.map(n => n.id));

const EX_IDS = ["p200","p201","p202","p203"]; // 4 exits at specific coordinates

// ── PATHFINDING (A*) ──
const dist = (a,b) => Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2);

// Find nearest hallway node from any room (for non-hallway starting points)
function findNearestHallway(startNodeId) {
  if (HALLWAY_NODE_IDS.has(startNodeId)) return startNodeId;

  const startNode = NM[startNodeId];
  if (!startNode) return null;

  let nearest = null;
  let minDist = Infinity;

  for (const hallwayNode of HALLWAY_NODES) {
    const d = dist(startNode, hallwayNode);
    if (d < minDist) {
      minDist = d;
      nearest = hallwayNode.id;
    }
  }

  return nearest;
}

// A* pathfinding - only uses hallway nodes and edges
function astar(s,e,bl=[]) {
  if(!NM[s]||!NM[e]) return null;

  // Ensure start and end are hallway nodes or exits
  if (!HALLWAY_NODE_IDS.has(s)) {
    s = findNearestHallway(s);
    if (!s) return null;
  }
  if (!HALLWAY_NODE_IDS.has(e)) return null;

  // Build adjacency list from edges, excluding blocked edges
  const adj={}; HALLWAY_NODES.forEach(n=>adj[n.id]=[]);
  EDGES.forEach(([a,b])=>{
    // Only add edge if both nodes are hallways/exits and edge is not blocked
    if(HALLWAY_NODE_IDS.has(a) && HALLWAY_NODE_IDS.has(b) &&
       !bl.includes(`${a}-${b}`) && !bl.includes(`${b}-${a}`)) {
      adj[a]?.push(b);
      adj[b]?.push(a);
    }
  });

  const open=new Set([s]),from={},g={},f={};
  HALLWAY_NODES.forEach(n=>{g[n.id]=1/0;f[n.id]=1/0;});
  g[s]=0;f[s]=dist(NM[s],NM[e]);

  while(open.size){
    let c=null,mf=1/0;
    for(const id of open) if(f[id]<mf){mf=f[id];c=id;}

    if(c===e){
      const p=[c];
      let x=c;
      while(from[x]){x=from[x];p.unshift(x);}
      return p;
    }

    open.delete(c);
    for(const nb of adj[c]||[]){
      const t=g[c]+dist(NM[c],NM[nb]);
      if(t<g[nb]){
        from[nb]=c;
        g[nb]=t;
        f[nb]=t+dist(NM[nb],NM[e]);
        open.add(nb);
      }
    }
  }

  return null;
}

function speak(t){if("speechSynthesis"in window){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.rate=1.1;window.speechSynthesis.speak(u);}}

/* ═══════════════════════════════════════════════════════════════
   GLOBAL BRAIN — Synchronized Multi-User Evacuation Intelligence
   
   The brain coordinates ALL evacuees simultaneously to:
   1. Balance load across exits (no single exit gets overwhelmed)
   2. Penalize congested corridors (edge bandwidth, not just nodes)
   3. Iteratively converge routes (3 passes — rerouting once isn't enough
      because person A's new route may crowd person B's corridor)
   4. Track per-exit capacity & live assignment counts
   5. Simulate user movement so congestion is dynamic
   6. Share blockade knowledge instantly across all users
   ═══════════════════════════════════════════════════════════════ */

// Exit capacity limits (people per minute throughput)
const EXIT_CAPACITY = { p8: 15, p23: 12, p125: 10, p133: 15 };

const brain = (() => {
  let users = new Map(), blocks = [], eventLog = [];

  // ── Edge congestion: counts how many active routes use each edge ──
  function edgeCong() {
    const ec = {};
    for (const [, u] of users) {
      if (!u.path) continue;
      for (let i = 0; i < u.path.length - 1; i++) {
        const ek = [u.path[i], u.path[i+1]].sort().join("~");
        ec[ek] = (ec[ek] || 0) + 1;
      }
    }
    return ec;
  }

  // ── Node congestion (for heatmap vis) ──
  function nodeCong() {
    const c = {};
    NODES.forEach(n => c[n.id] = 0);
    for (const [, u] of users) {
      if (!u.path) continue;
      // Weight nodes by how far along the user is (nodes ahead matter more)
      const start = u.progress || 0;
      for (let i = start; i < u.path.length; i++) {
        c[u.path[i]] = (c[u.path[i]] || 0) + 1;
      }
    }
    return c;
  }

  // ── Per-exit load: how many users are currently routed to each exit ──
  function exitLoads() {
    const loads = {};
    EX_IDS.forEach(e => loads[e] = 0);
    for (const [, u] of users) {
      if (!u.path || u.path.length === 0) continue;
      const dest = u.path[u.path.length - 1];
      if (loads[dest] !== undefined) loads[dest]++;
    }
    return loads;
  }

  // ── Congestion-aware route cost (the core intelligence) ──
  function routeCost(path, ec, el) {
    if (!path) return Infinity;
    let cost = 0;
    const dest = path[path.length - 1];
    for (let i = 1; i < path.length; i++) {
      const baseDist = dist(NM[path[i-1]], NM[path[i]]);
      // Edge congestion penalty — exponential to strongly discourage bottlenecks
      const ek = [path[i-1], path[i]].sort().join("~");
      const edgeLoad = ec[ek] || 0;
      const edgePenalty = edgeLoad > 3 ? edgeLoad * edgeLoad * 8 : edgeLoad * 15;
      cost += baseDist + edgePenalty;
    }
    // Exit overload penalty — push people to less-crowded exits
    const cap = EXIT_CAPACITY[dest] || 12;
    const load = el[dest] || 0;
    const ratio = load / cap;
    if (ratio > 0.8) cost += ratio * ratio * 200; // exponential penalty near capacity
    else if (ratio > 0.5) cost += ratio * 60;
    return cost;
  }

  return {
    addBlock(e, by) {
      if (!blocks.find(b => b.edge === e)) {
        blocks.push({ edge: e, by, time: Date.now() });
        eventLog.push({ type: "blockade", msg: `Blockade at ${e}`, time: Date.now() });
      }
      return [...blocks];
    },
    rmBlock(e) { blocks = blocks.filter(b => b.edge !== e); return [...blocks]; },
    clearBlocks() { blocks = []; return []; },
    blocked() { return blocks.map(b => b.edge); },
    blocks() { return [...blocks]; },

    // Node congestion for heatmap
    cong() { return nodeCong(); },
    // Edge congestion for route intelligence
    edgeCong() { return edgeCong(); },
    // Per-exit assignment counts
    exitLoads() { return exitLoads(); },

    // ── Smart route: considers edge congestion + exit balancing ──
    route(start, uid) {
      const bl = this.blocked();
      const ec = edgeCong();
      const el = exitLoads();
      // If user already has a route to this exit, remove their old contribution first
      const oldUser = users.get(uid);
      if (oldUser?.path) {
        const oldDest = oldUser.path[oldUser.path.length - 1];
        if (el[oldDest] !== undefined) el[oldDest] = Math.max(0, el[oldDest] - 1);
      }
      let best = null, bs = Infinity;
      for (const ex of EX_IDS) {
        const p = astar(start, ex, bl);
        if (p) {
          const c = routeCost(p, ec, el);
          if (c < bs) { bs = c; best = p; }
        }
      }
      if (best) {
        users.set(uid, { nodeId: start, path: best, progress: 0, lastUpdate: Date.now() });
      }
      return best;
    },

    // Local-only route (no congestion awareness — Bluetooth/offline mode)
    localRoute(start) {
      const bl = this.blocked();
      let best = null, bd = Infinity;
      for (const ex of EX_IDS) {
        const p = astar(start, ex, bl);
        if (p) {
          let d = 0;
          for (let i = 1; i < p.length; i++) d += dist(NM[p[i-1]], NM[p[i]]);
          if (d < bd) { bd = d; best = p; }
        }
      }
      return best;
    },

    // ── Iterative convergence reroute ──
    // Single pass can cause thrashing (A steals B's corridor, B steals C's, etc.)
    // Multiple passes let the system settle into a balanced state
    rerouteAll() {
      const ids = [...users.keys()];
      let totalRerouted = 0;
      const PASSES = 3; // 3 convergence passes
      for (let pass = 0; pass < PASSES; pass++) {
        // Shuffle order each pass to avoid ordering bias
        for (let i = ids.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [ids[i], ids[j]] = [ids[j], ids[i]];
        }
        for (const id of ids) {
          const u = users.get(id);
          if (!u) continue;
          const oldPath = u.path ? [...u.path] : null;
          const p = this.route(u.nodeId, id);
          if (p && oldPath && p.join(",") !== oldPath.join(",")) totalRerouted++;
        }
      }
      eventLog.push({ type: "reroute", msg: `Convergence: ${PASSES} passes, ${totalRerouted} route changes`, time: Date.now() });
      return ids;
    },

    // ── Simulate user movement (advance progress along paths) ──
    tick() {
      const moved = [];
      for (const [id, u] of users) {
        if (!u.path || u.path.length === 0) continue;
        const prog = u.progress || 0;
        if (prog < u.path.length - 1) {
          u.progress = prog + 1;
          u.nodeId = u.path[u.progress];
          moved.push({ id, nodeId: u.nodeId, x: NM[u.nodeId]?.x, y: NM[u.nodeId]?.y });
        }
      }
      return moved;
    },

    // Get simulated user positions for map rendering
    getUserPositions() {
      const positions = [];
      for (const [id, u] of users) {
        if (!u.path || u.path.length === 0) continue;
        const node = NM[u.nodeId];
        if (!node) continue;
        // Add small random offset so overlapping users spread visually
        const hash = id.charCodeAt(id.length-1) || 0;
        positions.push({
          x: node.x + (hash % 7 - 3) * 2,
          y: node.y + ((hash * 3) % 7 - 3) * 1.5,
          id,
          progress: u.progress || 0,
          total: u.path.length,
          dest: u.path[u.path.length - 1],
        });
      }
      return positions;
    },

    count() { return users.size; },
    log() { return eventLog.slice(-20); },

    // ── Analytics snapshot ──
    analytics() {
      const el = exitLoads();
      const ec = edgeCong();
      // Find most congested edge
      let maxEdge = "", maxEdgeLoad = 0;
      for (const [e, l] of Object.entries(ec)) {
        if (l > maxEdgeLoad) { maxEdgeLoad = l; maxEdge = e; }
      }
      // Exit balance score (0=perfect, 1=all at one exit)
      const loads = Object.values(el);
      const total = loads.reduce((a, b) => a + b, 0) || 1;
      const ideal = total / EX_IDS.length;
      const imbalance = loads.reduce((s, l) => s + Math.abs(l - ideal), 0) / (total * 2);

      return {
        totalUsers: users.size,
        exitLoads: el,
        exitCapacity: EXIT_CAPACITY,
        bottleneck: maxEdge ? { edge: maxEdge, load: maxEdgeLoad } : null,
        balanceScore: Math.round((1 - imbalance) * 100), // 100=perfect balance
        activeBlocks: blocks.length,
      };
    },

    seed(n) {
      // Spread seed users across different areas of the building
      const roomNodes = NAV_RAW.filter(r => r.feat?.type === "ROOM");
      // Pick rooms distributed across the building
      const step = Math.max(1, Math.floor(roomNodes.length / n));
      for (let i = 0; i < n; i++) {
        const node = roomNodes[(i * step) % roomNodes.length];
        this.route(node.id, `sim_${i}`);
      }
      // Run 2 convergence passes on seed to get a balanced starting state
      this.rerouteAll();
    },
  };
})();

/* ─── SVG FLOOR PLAN COMPONENT ─── */
const FloorPlan = ({ userPos, route, blockades, congestion, edgeCong, exitLoadData, onClick, people, hoveredRoom, setHoveredRoom, clients, adminMode, mode, userHeading }) => {
  const rp = route ? route.map(id => NM[id]).filter(Boolean) : [];

  // Convert wall segments to SVG space
  const wallLines = useMemo(() => WALLS_RAW.map(([x1,y1,x2,y2]) => ({
    x1: tx(x1), y1: ty(y1), x2: tx(x2), y2: ty(y2)
  })), []);

  return (
    <svg viewBox="-150 0 1350 1120" preserveAspectRatio="xMidYMid meet"
      style={{ width: "100%", height: "100%", background: "#060a10", borderRadius: 12, display: "block" }}>
      <defs>
        <filter id="gl"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <filter id="gs"><feGaussianBlur stdDeviation="5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#00ffaa"/><stop offset="100%" stopColor="#00aaff"/></linearGradient>
        <pattern id="grd" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M20 0L0 0 0 20" fill="none" stroke="#ffffff03" strokeWidth=".3"/></pattern>
      </defs>
      <rect width="1200" height="1120" fill="url(#grd)"/>

      {/* ═══ ACTUAL FLOOR PLAN WALLS from PDF ═══ */}
      {wallLines.map((w, i) => (
        <line key={i} x1={w.x1} y1={w.y1} x2={w.x2} y2={w.y2}
          stroke="#A7C7E7" strokeWidth="1" strokeLinecap="round"/>
      ))}

      {/* Navigation Edges - thick green lines connecting hallway nodes */}
      {EDGES.map(([a, b], i) => {
        const na = NM[a], nb = NM[b];
        if (!na || !nb) return null;
        return (
          <line key={`edge-${i}`} x1={na.x} y1={na.y} x2={nb.x} y2={nb.y}
            stroke="transparent" strokeWidth="3" strokeLinecap="round" opacity="0"/>
        );
      })}

      {/* Intermediate Waypoints (auto-generated along edges) */}
      {EXTRA.map(wp => {
        const isPriority = wp.feat?.priority === true; // Check if it's one of the 100 new waypoints
        return (
          <circle key={wp.id} cx={wp.x} cy={wp.y} r={isPriority ? "3" : "2"}
            fill={isPriority ? "#00ff88" : "#00ff8850"}
            opacity= "0"
            stroke={"transparent"} 
            strokeWidth={0}>
          </circle>
        );
      })}

      {/* Rooms */}
      {ROOMS.map(r => {
        const isHovered = hoveredRoom === r.label;
        return (
          <g key={r.id} style={{ cursor: "pointer" }}
            onClick={() => {
              onClick(NAV_RAW.find(n => n.feat?.id === r.id));
            }}
            onMouseEnter={() => setHoveredRoom(r.label)}
            onMouseLeave={() => setHoveredRoom(null)}>
            <circle cx={r.sx} cy={r.sy} r={isHovered ? 14 : 10} fill={isHovered ? "#1a2f4a" : (r.color === "green" || r.hallway ? "transparent" : "#FFFFFF")} stroke={isHovered ? "#3b82f640" : "#1a254020"} strokeWidth={isHovered ? 1 : .5} opacity={r.color === "green" || r.hallway ? 0 : 1} />
            <circle cx={r.sx} cy={r.sy} r="3.5" fill={isHovered ? "#3b82f6" : (r.color === "green" || r.hallway ? "transparent" : "#1e2a3a")} stroke="#2a3f5f30" strokeWidth=".5" opacity={r.color === "green" || r.hallway ? 0 : 1} />
            <text x={r.sx} y={r.sy-9} textAnchor="middle" fill={isHovered ? "#93c5fd" : (r.color === "green" || r.hallway ? "transparent" : "#4a5a70")} fontSize="5.5" fontFamily="monospace" fontWeight={isHovered ? "bold" : "normal"} opacity={r.color === "green" || r.hallway ? 0 : 1}>{r.label}</text>
          </g>
        );
      })}

      {/* Exits */}
      {EXITS.map(e => (
        <g key={e.id} style={{ cursor: "pointer" }}>
          <circle cx={e.sx} cy={e.sy} r="10" fill="#FF0000" stroke="#008800" strokeWidth="1.5"/>
          <text x={e.sx} y={e.sy-13} textAnchor="middle" fill="#FF0000" fontSize="6" fontFamily="monospace" fontWeight="bold">EXIT</text>
        </g>
      ))}

      {/* Congestion heatmap — node-level heat + edge-level thickness */}
      {congestion && Object.entries(congestion).map(([nid, lv]) => {
        const n = NM[nid]; if (!n || lv < 2) return null;
        const intensity = Math.min(lv / 8, 1);
        const r = 5 + lv * 2.5;
        const color = lv > 6 ? `rgba(255,30,30,${0.08 + intensity*0.15})` 
                    : lv > 3 ? `rgba(255,140,0,${0.06 + intensity*0.12})` 
                    : `rgba(255,255,0,${0.04 + intensity*0.08})`;
        return <circle key={`c${nid}`} cx={n.x} cy={n.y} r={r} fill={color}/>;
      })}

      {/* Edge congestion — thicker corridor lines where traffic is heavy */}
      {edgeCong && Object.entries(edgeCong).map(([ek, lv]) => {
        if (lv < 2) return null;
        const [a, b] = ek.split("~");
        const na = NM[a], nb = NM[b];
        if (!na || !nb) return null;
        const intensity = Math.min(lv / 6, 1);
        const color = lv > 5 ? "#ff333335" : lv > 3 ? "#ff880028" : "#ffcc001a";
        return <line key={`ec${ek}`} x1={na.x} y1={na.y} x2={nb.x} y2={nb.y}
          stroke={color} strokeWidth={1.5 + intensity * 4} strokeLinecap="round"/>;
      })}

      {/* Exit load indicators — ring fill shows capacity usage */}
      {exitLoadData && EXITS.map(e => {
        const eid = `p${e.id}`;
        const load = exitLoadData[eid] || 0;
        const cap = EXIT_CAPACITY[eid] || 12;
        const ratio = Math.min(load / cap, 1);
        const loadColor = ratio > 0.8 ? "#ff4444" : ratio > 0.5 ? "#ffaa00" : "#00ff88";
        return (
          <g key={`el${e.id}`}>
            {/* Capacity ring background */}
            <circle cx={e.sx} cy={e.sy} r="18" fill="none" stroke="#ffffff08" strokeWidth="2.5"/>
            {/* Filled arc representing load */}
            <circle cx={e.sx} cy={e.sy} r="18" fill="none" stroke={`${loadColor}50`} strokeWidth="2.5"
              strokeDasharray={`${ratio * 113} 113`} strokeDashoffset="28"
              transform={`rotate(-90 ${e.sx} ${e.sy})`}/>
            {/* Load count */}
            <text x={e.sx} y={e.sy+26} textAnchor="middle" fill={loadColor} fontSize="5" fontFamily="monospace" fontWeight="bold">
              {load}/{cap}
            </text>
          </g>
        );
      })}

      {/* Blockades */}
      {blockades.map((b, i) => {
        const ps = b.edge.split("-"), n1 = NM[ps[0]], n2 = NM[ps[1]];
        if (!n1 || !n2) return null;
        const mx = (n1.x + n2.x) / 2, my = (n1.y + n2.y) / 2;
        return (
          <g key={`b${i}`}>
            <line x1={n1.x} y1={n1.y} x2={n2.x} y2={n2.y} stroke="#ff000050" strokeWidth="3" strokeDasharray="5 3"/>
            <circle cx={mx} cy={my} r="10" fill="#ff000025" stroke="#ff3333" strokeWidth="1.5" filter="url(#gl)">
              <animate attributeName="r" values="10;14;10" dur="1.5s" repeatCount="indefinite"/>
            </circle>
            <text x={mx} y={my+1} textAnchor="middle" dominantBaseline="middle" fill="#ff4444" fontSize="12" fontWeight="bold">✕</text>
          </g>
        );
      })}

      {/* Simulated evacuees — colored by assigned exit */}
      {people.map((p, i) => {
        const exitColors = { p8: "#4488ff", p23: "#ff8844", p125: "#44ff88", p133: "#ff44aa" };
        const c = exitColors[p.dest] || "#5588ee";
        const alpha = p.progress < p.total * 0.5 ? 0.6 : 0.3; // fade as they get closer to exit
        return (
          <g key={`sp${i}`}>
            <circle cx={p.x} cy={p.y} r="3.5" fill={`${c}18`}/>
            <circle cx={p.x} cy={p.y} r="1.5" fill={c} opacity={alpha}/>
          </g>
        );
      })}

      {/* Client Routes in Admin Mode */}
      {adminMode && clients && clients.map(client => {
        const clientRoute = client.route ? client.route.map(id => NM[id]).filter(Boolean) : [];
        if (clientRoute.length < 2) return null;
        return (
          <g key={`cr${client.id}`} filter="url(#gs)">
            <polyline 
              points={clientRoute.map(p => `${p.x},${p.y}`).join(" ")} 
              fill="none" 
              stroke={client.color} 
              strokeWidth="2.5" 
              strokeLinecap="round" 
              strokeLinejoin="round" 
              strokeDasharray="8 4"
              opacity="0.7">
              <animate attributeName="stroke-dashoffset" from="0" to="-12" dur=".5s" repeatCount="indefinite"/>
            </polyline>
            {clientRoute.slice(1, -1).map((p, i) => 
              <circle key={`r${i}`} cx={p.x} cy={p.y} r="1.8" fill={client.color} opacity=".4"/>
            )}
          </g>
        );
      })}

      {/* Route (Single Client Mode) */}
      {!adminMode && rp.length > 1 && <g filter="url(#gs)">
        <polyline points={rp.map(p => `${p.x},${p.y}`).join(" ")} fill="none" stroke="url(#rg)" strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round" strokeDasharray="10 5">
          <animate attributeName="stroke-dashoffset" from="0" to="-15" dur=".5s" repeatCount="indefinite"/>
        </polyline>
        {rp.slice(1, -1).map((p, i) => <circle key={`r${i}`} cx={p.x} cy={p.y} r="2.5" fill="#00ffaa" opacity=".5"/>)}
      </g>}

      {/* Client Positions in Admin Mode */}
      {adminMode && clients && clients.map(client => (
        <g key={`cp${client.id}`} filter="url(#gs)">
          <circle cx={client.pos.x} cy={client.pos.y} r="14" fill={`${client.color}08`} stroke={client.color} strokeWidth=".8">
            <animate attributeName="r" values="10;18;10" dur="2s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values=".6;.12;.6" dur="2s" repeatCount="indefinite"/>
          </circle>
          <circle cx={client.pos.x} cy={client.pos.y} r="5" fill={client.color}/>
          <circle cx={client.pos.x} cy={client.pos.y} r="2" fill="#fff"/>
          <text x={client.pos.x} y={client.pos.y - 20} textAnchor="middle" fill={client.color} fontSize="6" fontFamily="monospace" fontWeight="bold">
            {client.name.split(" ")[1]}
          </text>
        </g>
      ))}

      {/* User position (Single Client Mode) */}
      {!adminMode && userPos && mode === "SIMULATION" && <g filter="url(#gs)">
        <circle cx={userPos.x} cy={userPos.y} r="16" fill="#00aaff08" stroke="#00aaff" strokeWidth=".8">
          <animate attributeName="r" values="12;22;12" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values=".6;.12;.6" dur="2s" repeatCount="indefinite"/>
        </circle>
        <circle cx={userPos.x} cy={userPos.y} r="6" fill="#00ccff"/>
        <circle cx={userPos.x} cy={userPos.y} r="2.5" fill="#fff"/>
      </g>}

      {/* User position with directional arrow (LIVE Mode) */}
      {!adminMode && userPos && mode === "LIVE" && (
        <g transform={`translate(${userPos.x}, ${userPos.y}) rotate(${userHeading || 0})`} filter="url(#gs)">
          <circle r="16" fill="#00ff8808" stroke="#00ff88" strokeWidth=".8">
            <animate attributeName="r" values="12;22;12" dur="2s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values=".6;.12;.6" dur="2s" repeatCount="indefinite"/>
          </circle>
          <circle r="6" fill="#00ff88"/>
          <path d="M0 -10 L6 4 L0 1 L-6 4 Z" fill="#fff" stroke="#00ff88" strokeWidth="0.5" />
        </g>
      )}

      {/* Destination (Single Client Mode) */}
      {!adminMode && route && rp.length > 0 && <g filter="url(#gl)">
        <circle cx={rp[rp.length-1].x} cy={rp[rp.length-1].y} r="10" fill="none" stroke="#00ff88" strokeWidth="2">
          <animate attributeName="r" values="10;17;10" dur="1.5s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="1;.2;1" dur="1.5s" repeatCount="indefinite"/>
        </circle>
      </g>}

    {/* Debugging Label */}
      <text x="18" y="810" fill="#1a2a4050" fontSize="7" fontFamily="monospace">MC Building No.17 — 1st Floor — University of Waterloo — EchoAid GeoJSON</text>
    </svg>
  );
};

/* ═══════════════════════════════════════
   MAIN APP — ECHOAID
   ═══════════════════════════════════════ */
export default function App() {
  // Initialize 5 controllable clients
  const initialClients = [
    { id: 1, name: "Client Alpha", pos: { x: tx(1783), y: ty(955) }, node: "p48", route: null, status: "STANDBY", progress: 0, color: "#00aaff" },
    { id: 2, name: "Client Beta", pos: { x: tx(1418), y: ty(1014) }, node: "p43", route: null, status: "STANDBY", progress: 0, color: "#00ff88" },
    { id: 3, name: "Client Gamma", pos: { x: tx(2047), y: ty(1018) }, node: "p6", route: null, status: "STANDBY", progress: 0, color: "#ffaa00" },
    { id: 4, name: "Client Delta", pos: { x: tx(1289), y: ty(980) }, node: "p71", route: null, status: "STANDBY", progress: 0, color: "#ff44aa" },
    { id: 5, name: "Client Epsilon", pos: { x: tx(2194), y: ty(948) }, node: "p54", route: null, status: "STANDBY", progress: 0, color: "#4488ff" },
  ];
  
  const [clients, setClients] = useState(initialClients);
  const [activeClientId, setActiveClientId] = useState(1);
  const [mode, setMode] = useState("SIMULATION"); // SIMULATION or LIVE
  const [sensorPermission, setSensorPermission] = useState(false);
  const [requestingSensors, setRequestingSensors] = useState(false);
  const [userHeading, setUserHeading] = useState(0);
  const [wifi, setWifi] = useState(true);
  const [logs, setLogs] = useState([]);
  const [listening, setListening] = useState(false);
  const [transcript, setTranscript] = useState("");
  const [blocks, setBlocks] = useState([]);
  const [cong, setCong] = useState({});
  const [eCong, setECong] = useState({});
  const [exLoads, setExLoads] = useState({});
  const [analytics, setAnalytics] = useState(null);
  const [people, setPeople] = useState([]);
  const [showBM, setShowBM] = useState(false);
  const [hoveredRoom, setHoveredRoom] = useState(null);
  const [searchQuery, setSearchQuery] = useState("");
  const [adminMode, setAdminMode] = useState(false);
  const [selectedUser, setSelectedUser] = useState(null);
  const recRef = useRef(null);
  const logRef = useRef(null);
  const simRef = useRef(null);
  const headingRef = useRef(0);
  const lastStepTime = useRef(0);
  
  const activeClient = clients.find(c => c.id === activeClientId);
  const updateClient = useCallback((id, updates) => {
    setClients(prev => prev.map(c => c.id === id ? { ...c, ...updates } : c));
  }, []);

  const log = useCallback((m, t = "info") => {
    const d = new Date();
    const ts = `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}:${String(d.getSeconds()).padStart(2, "0")}`;
    setLogs(p => [...p.slice(-60), { msg: m, type: t, time: ts }]);
  }, []);
  useEffect(() => { logRef.current && (logRef.current.scrollTop = logRef.current.scrollHeight); }, [logs]);

  // Refresh all brain-derived state
  const refreshBrain = useCallback(() => {
    setCong(brain.cong());
    setECong(brain.edgeCong());
    setExLoads(brain.exitLoads());
    setAnalytics(brain.analytics());
    setPeople(brain.getUserPositions());
  }, []);

  // Enable sensors for live tracking (iOS requires permission)
  const enableSensors = useCallback(async () => {
    console.log("🔓 enableSensors called!");
    setRequestingSensors(true);
    log("🔓 Requesting sensor permissions...", "info");

    // Check if DeviceOrientationEvent exists
    if (typeof DeviceOrientationEvent === 'undefined') {
      log("❌ Device sensors not available on this browser", "error");
      alert("⚠️ Your browser doesn't support motion sensors. Try using Safari on iOS or Chrome on Android.");
      setRequestingSensors(false);
      return;
    }

    // iOS 13+ requires explicit permission
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        log("📱 iOS detected - requesting permission...", "info");
        const response = await DeviceOrientationEvent.requestPermission();
        if (response === 'granted') {
          setSensorPermission(true);
          log("✅ Sensors enabled! You can now use LIVE mode.", "success");
          speak("Sensors enabled.");
        } else {
          log("❌ Sensor permission denied. Please allow motion & orientation access.", "error");
          alert("⚠️ Permission denied. Please allow motion & orientation access in your browser settings.");
        }
      } catch (error) {
        log(`❌ Error requesting sensors: ${error.message}`, "error");
        alert(`⚠️ Error: ${error.message}\n\nMake sure you're using HTTPS and try again.`);
        console.error("Sensor permission error:", error);
      } finally {
        setRequestingSensors(false);
      }
    } else {
      // Android/Desktop - no permission needed
      setSensorPermission(true);
      log("✅ Sensors ready! (No permission required on this device)", "success");
      speak("Sensors ready.");
      setRequestingSensors(false);
    }
  }, [log]);

  // Find nearest node to a given position
  const findNearestNode = useCallback((x, y, route = null) => {
    // If we have a route, prefer nodes along that route
    const searchNodes = route ? route.map(id => NM[id]).filter(Boolean) : NODES;
    let minDist = Infinity;
    let nearest = null;
    for (const node of searchNodes) {
      const d = Math.sqrt((node.x - x) ** 2 + (node.y - y) ** 2);
      if (d < minDist) {
        minDist = d;
        nearest = node;
      }
    }
    return nearest;
  }, []);

  // LIVE mode sensor tracking
  useEffect(() => {
    if (mode !== "LIVE" || !sensorPermission || activeClient.status !== "EVACUATING") return;

    // ═══════════════════════════════════════════════════════
    // 🎛️  SENSITIVITY CONTROLS - Edit these values:
    // ═══════════════════════════════════════════════════════
    const STEP_SIZE = 20;          // Distance moved per step (pixels)
                                   // HIGHER = faster movement
                                   // Default: 6 | Recommended: 8-15 for faster response

    const STEP_THRESHOLD = 1;    // Acceleration change needed to detect a step
                                   // LOWER = more sensitive (detects lighter movements)
                                   // Default: 10 | For WALKING: 2-4 (tapping needs higher)

    const DEBOUNCE_MS = 200;       // Minimum time between steps (milliseconds)
                                   // LOWER = more responsive (detects steps faster)
                                   // Default: 300 | For WALKING: 250-400 (matches walking rhythm)

    const HEADING_OFFSET = -40;    // Compass calibration (degrees)
                                   // Adjust if your arrow points the wrong direction
    // ═══════════════════════════════════════════════════════

    let lastAcceleration = 0;
    let sampleCount = 0; // For debug logging

    const handleMotion = (event) => {
      const acc = event.accelerationIncludingGravity;
      if (!acc) return;
    
      const magnitude = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);
      const delta = Math.abs(magnitude - lastAcceleration);
      lastAcceleration = magnitude;
    
      // Debug: Log acceleration every 20 samples to see what's happening
      sampleCount++;
      if (sampleCount % 20 === 0) {
        console.log(`📊 Accel delta: ${delta.toFixed(2)} (threshold: ${STEP_THRESHOLD})`);
      }
    
      if (delta > STEP_THRESHOLD) {
        console.log(`✅ STEP DETECTED! Delta: ${delta.toFixed(2)}`); // Debug log
        const now = Date.now();
        if (now - lastStepTime.current < DEBOUNCE_MS) return; // Debounce steps
        lastStepTime.current = now;
    
        setClients(prevClients => {
          return prevClients.map(client => {
            if (client.id !== activeClientId) return client;
            if (!client.pos || !client.route) return client;
    
            // ═══════════════════════════════════════════════════════
            // 🎯 HALLWAY-WAYPOINT-ONLY MOVEMENT
            // User can ONLY move to green waypoint nodes
            // ═══════════════════════════════════════════════════════
    
            // Calculate intended direction based on heading
            const heading = headingRef.current + HEADING_OFFSET;
            const rad = (heading * Math.PI) / 180;
            const dirX = Math.sin(rad);
            const dirY = -Math.cos(rad);
    
            // Find all hallway waypoint nodes (the 526 green nodes)
            const hallwayWaypoints = NODES.filter(n => 
              n.feat?.hallway === true || 
              n.feat?.type === "WAYPOINT" || 
              n.feat?.color === "green"
            );
    
            // Get current waypoint node
            const currentNode = NM[client.node] || client.pos;
            
            // Find nearest waypoint in the direction of movement
            let bestNode = null;
            let bestScore = -Infinity;
            const SEARCH_RADIUS = 100; // Only consider waypoints within 100px
    
            for (const waypoint of hallwayWaypoints) {
              // Skip current position
              if (waypoint.id === client.node) continue;
    
              // Vector from current position to waypoint
              const toWaypointX = waypoint.x - currentNode.x;
              const toWaypointY = waypoint.y - currentNode.y;
              const distance = Math.sqrt(toWaypointX ** 2 + toWaypointY ** 2);
    
              // Skip if too far
              if (distance > SEARCH_RADIUS) continue;
    
              // Calculate alignment with heading (dot product)
              const alignment = (toWaypointX * dirX + toWaypointY * dirY) / distance;
    
              // Score = alignment (prefer nodes in direction) - distance penalty
              const score = alignment * 100 - distance * 0.5;
    
              if (score > bestScore && alignment > 0.3) { // Must be roughly in the right direction
                bestScore = score;
                bestNode = waypoint;
              }
            }
    
            // If we found a valid waypoint to move to, snap to it
            if (bestNode) {
              console.log(`🎯 Moving to waypoint ${bestNode.id} at (${Math.round(bestNode.x)}, ${Math.round(bestNode.y)})`);
    
              // Update position to the waypoint
              const newPos = { x: bestNode.x, y: bestNode.y };
    
              // Track progress along route
              const currentProgress = client.progress || 0;
              let updatedProgress = currentProgress;
    
              // Check if this waypoint is on our route
              if (client.route) {
                const waypointIndex = client.route.indexOf(bestNode.id);
                if (waypointIndex > currentProgress) {
                  updatedProgress = waypointIndex;
                  log(`📍 Progress: ${updatedProgress}/${client.route.length - 1}`, "info");
    
                  // Halfway point feedback
                  if (updatedProgress === Math.floor(client.route.length / 2)) {
                    speak("Halfway there.");
                  }
                }
              }
    
              // Check if reached destination
              if (updatedProgress >= client.route.length - 1) {
                log(`✅ ${client.name} reached safety!`, "success");
                speak("You are safe.");
                return { ...client, status: "SAFE", progress: updatedProgress };
              }
    
              return {
                ...client,
                pos: newPos,
                node: bestNode.id,
                progress: updatedProgress
              };
            } else {
              // No valid waypoint found - stay in place
              console.log(`⚠️ No valid waypoint in direction ${heading.toFixed(0)}°`);
              return client;
            }

            // Track progress by checking proximity to next waypoint on route
            const currentProgress = client.progress || 0;
            let updatedProgress = currentProgress;

            // ═══════════════════════════════════════════════════════
            // 🎯 HALLWAY-ONLY WAYPOINT TRACKING
            // Only advance progress at corridor waypoints, skip room nodes
            // ═══════════════════════════════════════════════════════

            // Helper: Check if a node is a hallway waypoint (not a room)
            const isHallwayNode = (nodeId) => {
              // Corridor waypoint prefixes (from EXTRA array - corridor centerlines)
              const hallwayPrefixes = ['wc_', 'nc_', 'sc_', 'cc_', 'mv_', 'ev_', 'fe_', 'ax_', 'top_', 'sw_', 'se_'];
              if (hallwayPrefixes.some(prefix => nodeId.startsWith(prefix))) {
                return true;
              }
              // Check if node has hallway property (from RAW data with hallway:true)
              const node = NM[nodeId];
              return node?.feat?.hallway === true;
            };

            if (currentProgress < client.route.length - 1) {
              // Find next HALLWAY node in route (skip over room nodes)
              let nextHallwayIndex = currentProgress + 1;
              while (nextHallwayIndex < client.route.length && !isHallwayNode(client.route[nextHallwayIndex])) {
                nextHallwayIndex++;
              }

              // Check distance to next hallway waypoint
              if (nextHallwayIndex < client.route.length) {
                const nextNodeId = client.route[nextHallwayIndex];
                const nextNode = NM[nextNodeId];

                if (nextNode) {
                  const distanceToNext = Math.sqrt(
                    (newX - nextNode.x) ** 2 + (newY - nextNode.y) ** 2
                  );

                  // Advance progress when within radius of next HALLWAY waypoint
                  const WAYPOINT_RADIUS = 30; // Larger radius since we skip room nodes
                  if (distanceToNext < WAYPOINT_RADIUS) {
                    updatedProgress = nextHallwayIndex; // Jump directly to hallway node

                    // Count hallway waypoints for better progress feedback
                    const hallwaysReached = client.route.slice(0, nextHallwayIndex + 1).filter(id => isHallwayNode(id)).length;
                    const totalHallways = client.route.filter(id => isHallwayNode(id)).length;

                    // Provide audio feedback at halfway point
                    if (hallwaysReached === Math.floor(totalHallways / 2)) {
                      speak("Halfway there.");
                    }

                    log(`📍 Hallway waypoint ${hallwaysReached}/${totalHallways} (${nextNodeId})`, "info");
                  }
                }
              }
            }

            // Check if reached final destination
            if (updatedProgress >= client.route.length - 1) {
              log(`✅ ${client.name} reached safety!`, "success");
              speak("You are safe.");
              return { ...client, status: "SAFE", progress: updatedProgress };
            }

            // Update position smoothly - no snapping, just continuous movement!
            return {
              ...client,
              pos: { x: newX, y: newY },
              progress: updatedProgress
            };
          });
        });
      }
    };

    const handleOrientation = (e) => {
      const compass = e.webkitCompassHeading || Math.abs(e.alpha - 360);
      headingRef.current = compass;
      setUserHeading(compass);
    };

    window.addEventListener('devicemotion', handleMotion);
    window.addEventListener('deviceorientation', handleOrientation);

    return () => {
      window.removeEventListener('devicemotion', handleMotion);
      window.removeEventListener('deviceorientation', handleOrientation);
    };
  }, [mode, sensorPermission, activeClient?.status, activeClientId, findNearestNode, log]);

  // Initialize
  useEffect(() => {
    brain.seed(30); // 30 simulated evacuees for richer demo
    refreshBrain();
    log("EchoAid initialized — MC Building floor plan loaded from PDF", "success");
    log(`${NODES.length} nodes, ${EDGES.length} edges, ${WALLS_RAW.length} wall segments`, "info");
    const a = brain.analytics();
    log(`🧠 Global Brain: ${a.totalUsers} evacuees, balance score ${a.balanceScore}%`, "route");
    const el = brain.exitLoads();
    const exitNames = { p8: "North", p23: "East N", p125: "West", p133: "South" };
    const distStr = EX_IDS.map(e => `${exitNames[e]}:${el[e]}`).join(" · ");
    log(`📊 Exit distribution → ${distStr}`, "info");
  }, []);

  // Simulation tick — move simulated users every 5s (only in SIMULATION mode)
  useEffect(() => {
    if (mode !== "SIMULATION") return;
    simRef.current = setInterval(() => {
      brain.tick();
      refreshBrain();
    }, 2000);
    return () => clearInterval(simRef.current);
  }, [refreshBrain, mode]);

  const evac = useCallback((nid, clientId = activeClientId) => {
    const p = wifi ? brain.route(nid, "main") : brain.localRoute(nid);
    log(wifi ? "🌐 Global Brain: congestion-aware routing..." : "📶 Local Brain: nearest exit...", "route");
    if (p) {
      updateClient(clientId, { route: p, status: "EVACUATING", progress: 0 });
      const last = NM[p[p.length-1]];
      const ex = EXITS.find(e => Math.abs(e.sx - last.x) < 20 && Math.abs(e.sy - last.y) < 20);
      const en = ex ? ex.label : "nearest exit";
      const client = clients.find(c => c.id === clientId);
      log(`✅ ${client?.name}: Route ${p.length} waypoints → ${en}`, "success");
      speak(`Route calculated. Head towards ${en}.`);
      if (wifi) {
        const a = brain.analytics();
        log(`🧠 Balance: ${a.balanceScore}% · Bottleneck: ${a.bottleneck ? a.bottleneck.edge + ` (${a.bottleneck.load} users)` : "none"}`, "info");
      }
      refreshBrain();
    } else {
      log("⚠ No route found!", "error");
      speak("Warning. No route found.");
    }
  }, [wifi, log, refreshBrain, activeClientId, clients, updateClient]);

  const onNode = useCallback(n => {
    if (!n) return;
    updateClient(activeClientId, { node: n.id, pos: { x: n.x, y: n.y } });
    log(`📍 ${activeClient?.name}: Location set to ${n.label || n.id}`);
    if (activeClient?.status === "EVACUATING") evac(n.id);
  }, [activeClient, evac, log, activeClientId, updateClient]);

  const doEvac = useCallback(() => {
    if (!activeClient?.node) { 
      const d = "p48"; 
      updateClient(activeClientId, { node: d, pos: { x: NM[d].x, y: NM[d].y } });
      log(`${activeClient?.name}: Auto-placed in MC 1052.`, "warn"); 
      evac(d); 
    } else {
      evac(activeClient.node);
    }
  }, [activeClient, evac, log, activeClientId, updateClient]);

  const doBlock = useCallback(() => {
    if (!activeClient?.route || activeClient.route.length < 3) { log("Need active route.", "warn"); return; }
    const idx = Math.min(activeClient.progress + 1, activeClient.route.length - 2);
    const edge = `${activeClient.route[idx]}-${activeClient.route[idx+1]}`;
    brain.addBlock(edge, activeClient.name); setBlocks(brain.blocks());
    log(`⛔ Blockade: ${edge}`, "error"); speak("Blockade reported. Rerouting all evacuees.");
    const rr = brain.rerouteAll();
    const a = brain.analytics();
    log(`🔄 ${rr.length} evacuees rerouted (3 convergence passes) · Balance: ${a.balanceScore}%`, "route");
    refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [activeClient, clients, evac, log, refreshBrain]);

  const doRandomBlock = useCallback(() => {
    // Create a random blockage on any hallway edge
    if (EDGES.length === 0) { log("No edges available.", "warn"); return; }
    const randomEdge = EDGES[Math.floor(Math.random() * EDGES.length)];
    const edge = `${randomEdge[0]}-${randomEdge[1]}`;
    brain.addBlock(edge, "simulation"); setBlocks(brain.blocks());
    log(`⛔ Random blockade: ${edge}`, "error");
    speak("Random blockade created. Rerouting all evacuees.");
    const rr = brain.rerouteAll();
    const a = brain.analytics();
    log(`🔄 ${rr.length} evacuees rerouted (3 convergence passes) · Balance: ${a.balanceScore}%`, "route");
    refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [clients, evac, log, refreshBrain]);

  const doManualReroute = useCallback(() => {
    log("🔄 Manual reroute triggered...", "route");
    speak("Manually rerouting all evacuees.");
    const rr = brain.rerouteAll();
    const a = brain.analytics();
    log(`🔄 ${rr.length} evacuees rerouted (3 convergence passes) · Balance: ${a.balanceScore}%`, "route");
    refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [clients, evac, log, refreshBrain]);

  const rmBlock = useCallback(edge => {
    brain.rmBlock(edge); setBlocks(brain.blocks());
    log(`✅ Cleared: ${edge}`, "success"); speak("Blockade cleared.");
    brain.rerouteAll(); refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [clients, evac, log, refreshBrain]);

  const clearAll = useCallback(() => {
    brain.clearBlocks(); setBlocks([]);
    log("✅ All blockades cleared.", "success"); speak("All blockades cleared.");
    brain.rerouteAll(); refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [clients, evac, log, refreshBrain]);

  const doSafe = useCallback(() => {
    updateClient(activeClientId, { status: "SAFE", route: null });
    log(`✅ ${activeClient?.name}: SAFE.`, "success");
    speak("You are safe.");
  }, [log, activeClientId, activeClient, updateClient]);

  // Voice recognition
  const startListen = useCallback(() => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { log("No speech recognition.", "error"); return; }
    const r = new SR(); r.continuous = false; r.interimResults = false; r.lang = "en-US";
    r.onresult = e => {
      const t = e.results[0][0].transcript.toLowerCase(); setTranscript(t); log(`🎤 "${t}"`);
      if (t.includes("fire") || t.includes("emergency")) doEvac();
      else if (t.includes("clear") && t.includes("block")) clearAll();
      else if (t.includes("block")) doBlock();
      else if (t.includes("evacuate") || t.includes("help")) doEvac();
      else if (t.includes("safe")) doSafe();
      else { log("Command not recognized.", "warn"); }
    };
    r.onerror = e => { log(`Voice: ${e.error}`, "error"); setListening(false); };
    r.onend = () => setListening(false);
    r.start(); recRef.current = r; setListening(true); log("🎤 Listening...");
  }, [doEvac, doBlock, clearAll, doSafe, log]);

  // Evacuation step timer - moves each evacuating client (SIMULATION mode only)
  useEffect(() => {
    const intervals = {};
    clients.forEach(client => {
      if (client.status !== "EVACUATING" || !client.route || client.route.length < 2) return;
      // Skip active client in LIVE mode (they use sensors instead)
      if (mode === "LIVE" && client.id === activeClientId) return;
      intervals[client.id] = setInterval(() => {
        const newProgress = client.progress + 1;
        if (newProgress >= client.route.length) {
          clearInterval(intervals[client.id]);
          updateClient(client.id, { status: "SAFE", route: null });
          if (client.id === activeClientId) {
            speak("You are safe.");
            log(`✅ ${client.name}: Evacuated successfully!`, "success");
          }
        } else {
          const nn = NM[client.route[newProgress]];
          if (nn) {
            updateClient(client.id, {
              progress: newProgress,
              pos: { x: nn.x, y: nn.y },
              node: client.route[newProgress]
            });
          }
          if (newProgress === Math.floor(client.route.length / 2) && client.id === activeClientId) {
            speak("Halfway there.");
          }
        }
      }, 200);
    });
    return () => {
      Object.values(intervals).forEach(iv => clearInterval(iv));
    };
  }, [clients, activeClientId, updateClient, mode]);

  // Room search
  const filteredRooms = searchQuery
    ? ROOMS.filter(r => r.label.toLowerCase().includes(searchQuery.toLowerCase())).slice(0, 8)
    : [];

  const sc = activeClient?.status === "EVACUATING" ? "#ff4444" : activeClient?.status === "SAFE" ? "#00ff88" : "#00aaff";

  return (
    <div className="app-shell" style={{ minHeight: "100vh", color: "#c0d0e0", fontFamily: "'IBM Plex Sans',sans-serif" }}>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap');@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}*{box-sizing:border-box;margin:0;padding:0}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#0a0e14}::-webkit-scrollbar-thumb{background:#1a2a40;border-radius:4px}.app-shell{background:radial-gradient(1200px 600px at 10% -10%,#112a45 0%,transparent 60%),radial-gradient(900px 500px at 90% -10%,#401a22 0%,transparent 55%),radial-gradient(800px 600px at 50% 120%,#0f2a24 0%,transparent 60%),#05070d;color:#c7d4e5}.app-header{backdrop-filter:blur(10px);background:linear-gradient(135deg,#0b111a,#0b0f1d);border-bottom:1px solid #1a2a40;box-shadow:0 10px 30px #00000055}.card{background:linear-gradient(180deg,#0c121c,#080c13);border:1px solid #1a2a40;box-shadow:0 10px 30px #00000055,inset 0 1px 0 #ffffff08;transition:transform .3s ease,box-shadow .3s ease,border-color .3s ease}.card:hover{transform:translateY(-2px);box-shadow:0 16px 40px #00000066,inset 0 1px 0 #ffffff12}.map-shell{background:linear-gradient(180deg,#0b111c,#080c14);border:1px solid #1d314a;box-shadow:0 16px 40px #00000066;transition:transform .3s ease,box-shadow .3s ease,border-color .3s ease}.panel-title{letter-spacing:2px;font-family:'Space Grotesk',sans-serif}`}</style>

      {/* HEADER */}
      <header className="app-header" style={{ padding: "12px 20px", display: "flex", alignItems: "center", justifyContent: "space-between", position: "sticky", top: 0, zIndex: 100 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{ width: 36, height: 36, borderRadius: 10, background: activeClient?.status === "EVACUATING" ? "linear-gradient(135deg,#ff2200,#ff6600)" : activeClient?.status === "SAFE" ? "linear-gradient(135deg,#00cc66,#00ff88)" : "linear-gradient(135deg,#0066ff,#00aaff)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, boxShadow: `0 0 20px ${sc}40` }}>
            {activeClient?.status === "EVACUATING" ? "🚨" : activeClient?.status === "SAFE" ? "✅" : "🏢"}
          </div>
          <div>
            <div style={{ fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, fontSize: 18, color: "#e6f2ff", letterSpacing: 2, textShadow: "0 0 18px #00aaff30" }}>
              ECHO<span style={{ color: "#00aaff" }}>AID</span>
            </div>
            <div style={{ fontSize: 9, color: "#445566", fontFamily: "monospace" }}>MC Building No.17 — UWaterloo — Real Floor Plan Data</div>
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          {/* Mode Switcher */}
          <select value={adminMode ? "admin" : "client"} onChange={e => setAdminMode(e.target.value === "admin")}
            style={{ padding: "6px 12px", borderRadius: 6, border: `1px solid ${adminMode ? "#ff880040" : "#1a2a40"}`, background: adminMode ? "#ff880010" : "#0a0e14", color: adminMode ? "#ffaa00" : "#7799bb", fontFamily: "'JetBrains Mono',monospace", fontSize: 10, fontWeight: 600, cursor: "pointer", outline: "none" }}>
            <option value="client">👤 Client View</option>
            <option value="admin">🛡️ Admin Dashboard</option>
          </select>
          
          {/* Client Selector */}
          {!adminMode && (
            <select value={activeClientId} onChange={e => setActiveClientId(Number(e.target.value))}
              style={{ padding: "6px 12px", borderRadius: 6, border: `1px solid ${activeClient?.color}40`, background: "#0a0e14", color: activeClient?.color, fontFamily: "'JetBrains Mono',monospace", fontSize: 10, fontWeight: 600, cursor: "pointer", outline: "none" }}>
              {clients.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          )}

          {/* Mode Toggle: SIMULATION vs LIVE */}
          {!adminMode && (
            <div style={{ display: "flex", gap: 4, background: "#0a0e14", borderRadius: 6, padding: 3, border: "1px solid #1a2a40" }}>
              <button onClick={() => setMode("SIMULATION")}
                style={{ padding: "4px 10px", borderRadius: 4, border: "none", background: mode === "SIMULATION" ? "#00aaff20" : "transparent", color: mode === "SIMULATION" ? "#00aaff" : "#556677", fontSize: 9, fontFamily: "monospace", cursor: "pointer", fontWeight: mode === "SIMULATION" ? 700 : 400, transition: "all .2s" }}>
                🤖 SIM
              </button>
              <button onClick={() => setMode("LIVE")}
                style={{ padding: "4px 10px", borderRadius: 4, border: "none", background: mode === "LIVE" ? "#00ff8820" : "transparent", color: mode === "LIVE" ? "#00ff88" : "#556677", fontSize: 9, fontFamily: "monospace", cursor: "pointer", fontWeight: mode === "LIVE" ? 700 : 400, transition: "all .2s" }}>
                📱 LIVE
              </button>
            </div>
          )}

          {/* Enable Sensors Button */}
          {!adminMode && mode === "LIVE" && !sensorPermission && (
            <button onClick={enableSensors} disabled={requestingSensors}
              style={{ padding: "6px 12px", borderRadius: 6, border: "1px solid #ff880040", background: requestingSensors ? "#ff880020" : "#ff880010", color: requestingSensors ? "#ffaa0080" : "#ffaa00", fontSize: 9, fontFamily: "monospace", cursor: requestingSensors ? "wait" : "pointer", fontWeight: 600, animation: requestingSensors ? "none" : "pulse 2s infinite" }}>
              {requestingSensors ? "⏳ Requesting..." : "🔓 Unlock Sensors"}
            </button>
          )}

          {/* Heading Display (LIVE mode) */}
          {!adminMode && mode === "LIVE" && sensorPermission && (
            <div style={{ padding: "4px 10px", background: "#0a0e14", border: "1px solid #1a2a40", borderRadius: 6, fontSize: 9, fontFamily: "monospace", color: "#7799bb" }}>
              🧭 {userHeading.toFixed(0)}°
            </div>
          )}

          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
            <div style={{ width: 8, height: 8, borderRadius: "50%", background: sc, boxShadow: `0 0 8px ${sc}`, animation: activeClient?.status === "EVACUATING" ? "pulse 1s infinite" : "none" }} />
            <span style={{ color: sc, fontFamily: "'JetBrains Mono',monospace", fontSize: 11, fontWeight: 700, letterSpacing: 2 }}>{activeClient?.status || "STANDBY"}</span>
          </div>
          <span style={{ color: "#334455", fontSize: 10, fontFamily: "monospace" }}>
            {wifi ? "📡 Global" : "📶 Local"} · {analytics?.totalUsers || 0} users · Balance {analytics?.balanceScore || 0}% · {blocks.length} blocks
          </span>
        </div>
      </header>

      <div style={{ padding: "14px 20px", maxWidth: 1600, margin: "0 auto" }}>
        {/* MAP */}
        <div className="map-shell" style={{ borderRadius: 12, padding: 12, marginBottom: 14, maxWidth: "900px", maxHeight: "600px", margin: "0 auto 14px" }}>
          <FloorPlan
            userPos={adminMode ? null : activeClient?.pos}
            route={adminMode ? null : activeClient?.route}
            blockades={blocks}
            congestion={cong}
            edgeCong={eCong}
            exitLoadData={exLoads}
            onClick={onNode}
            people={people}
            hoveredRoom={hoveredRoom}
            setHoveredRoom={setHoveredRoom}
            clients={clients}
            adminMode={adminMode}
            mode={mode}
            userHeading={userHeading}
          />
          {activeClient?.route && !adminMode && <div style={{ marginTop: 10 }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
              <span style={{ color: "#556677", fontSize: 11, fontFamily: "monospace" }}>{activeClient.name} - Evacuation Progress</span>
              <span style={{ color: "#00ff88", fontSize: 11, fontFamily: "monospace", fontWeight: 600 }}>{Math.round(activeClient.progress / (activeClient.route.length - 1) * 100)}%</span>
            </div>
            <div style={{ height: 4, background: "#1a2a40", borderRadius: 2, overflow: "hidden" }}>
              <div style={{ height: "100%", width: `${activeClient.progress / (activeClient.route.length - 1) * 100}%`, background: `linear-gradient(90deg,${activeClient.color},${activeClient.color}aa)`, transition: "width .5s" }} />
            </div>
          </div>}
        </div>

        {/* CONTROLS GRID */}
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: 12 }}>
          {/* Room Search + Actions */}
          <div className="card" style={{ borderRadius: 10, padding: 14 }}>
            <div style={{ color: "#8899bb", fontSize: 10, fontFamily: "monospace", letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>📍 Find Your Room</div>
            <input value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
              placeholder="Search room (e.g. 1052, 1047...)" style={{ width: "100%", padding: "8px 12px", borderRadius: 7, border: "1px solid #1a2a40", background: "#0a0e14", color: "#c0d0e0", fontFamily: "'JetBrains Mono',monospace", fontSize: 11, outline: "none", marginBottom: 6 }} />
            {filteredRooms.length > 0 && (
              <div style={{ maxHeight: 120, overflowY: "auto", marginBottom: 8 }}>
                {filteredRooms.map(r => (
                  <div key={r.id} onClick={() => { onNode(NAV_RAW.find(n => n.feat?.id === r.id)); setSearchQuery(""); }}
                    style={{ padding: "5px 10px", cursor: "pointer", borderRadius: 4, fontSize: 11, fontFamily: "monospace", color: "#7799bb", background: hoveredRoom === r.label ? "#1a2a40" : "transparent" }}
                    onMouseEnter={() => setHoveredRoom(r.label)} onMouseLeave={() => setHoveredRoom(null)}>
                    {r.label} <span style={{ color: "#334455", fontSize: 9 }}>({r.x}, {r.y})</span>
                  </div>
                ))}
              </div>
            )}

            {/* Mode Status Info */}
            {!adminMode && (
              <div style={{ marginTop: 8, marginBottom: 8, padding: "8px 10px", background: mode === "LIVE" ? "#00ff8808" : "#00aaff08", border: `1px solid ${mode === "LIVE" ? "#00ff8820" : "#00aaff20"}`, borderRadius: 6 }}>
                <div style={{ color: mode === "LIVE" ? "#00ff88" : "#00aaff", fontSize: 9, fontFamily: "monospace", fontWeight: 600, marginBottom: 3 }}>
                  {mode === "LIVE" ? "📱 LIVE TRACKING MODE" : "🤖 SIMULATION MODE"}
                </div>
                <div style={{ color: "#556677", fontSize: 8, fontFamily: "monospace", lineHeight: 1.4 }}>
                  {mode === "LIVE"
                    ? "Your phone's sensors track real movement. Walk to follow the route using your actual steps and direction."
                    : "Auto-simulated movement along the evacuation route. Your position updates automatically every 5 seconds."}
                </div>
              </div>
            )}

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginTop: 6 }}>
              <button onClick={doEvac} style={{ padding: 12, borderRadius: 8, border: "none", cursor: "pointer", background: activeClient?.status === "EVACUATING" ? "linear-gradient(135deg,#cc2200,#ff4400)" : "linear-gradient(135deg,#0055cc,#0088ff)", color: "#fff", fontFamily: "'JetBrains Mono',monospace", fontSize: 11, fontWeight: 700, letterSpacing: 1 }}>
                {activeClient?.status === "EVACUATING" ? "🚨 REROUTE" : "🚀 EVACUATE"}
              </button>
              <button onClick={doBlock} style={{ padding: 12, borderRadius: 8, border: "1px solid #ff444040", background: "#ff111110", color: "#ff6666", fontFamily: "'JetBrains Mono',monospace", fontSize: 11, fontWeight: 600, cursor: "pointer" }}>⛔ BLOCKADE</button>
            </div>
          </div>

          {/* Voice + Commands */}
          <div className="card" style={{ borderRadius: 10, padding: 14 }}>
            <div style={{ color: "#8899bb", fontSize: 10, fontFamily: "monospace", letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>🎙️ Voice Control & Commands</div>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
              <div onClick={() => listening ? (recRef.current?.stop(), setListening(false)) : startListen()}
                style={{ width: 36, height: 36, borderRadius: "50%", background: listening ? "#ff444430" : "#1a2a40", border: `2px solid ${listening ? "#ff4444" : "#2a3f5f"}`, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 16 }}>
                {listening ? "🔴" : "🎙️"}
              </div>
              <div>
                <div style={{ color: "#8899bb", fontSize: 10, fontFamily: "monospace", textTransform: "uppercase", letterSpacing: 1 }}>Voice Control</div>
                <div style={{ color: listening ? "#ff6666" : "#445566", fontSize: 9, fontFamily: "monospace" }}>{listening ? "Listening..." : "Tap to speak"}</div>
              </div>
            </div>
            {transcript && <div style={{ background: "#0a0e14", borderRadius: 6, padding: "5px 10px", color: "#6688aa", fontSize: 10, fontFamily: "monospace", fontStyle: "italic", marginBottom: 6 }}>"{transcript}"</div>}
            <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
              {["Report fire", "Report blockade", "Help evacuate", "Clear blockade", "I'm safe"].map(c => (
                <button key={c} onClick={() => { setTranscript(c); log(`Cmd: "${c}"`); if (c.includes("fire")) doEvac(); else if (c === "Report blockade") doBlock(); else if (c === "Clear blockade") clearAll(); else if (c.includes("evacuate")) doEvac(); else doSafe(); }}
                  style={{ background: "#1a2230", border: "1px solid #2a3a50", borderRadius: 5, padding: "4px 8px", color: "#7799bb", fontSize: 9, fontFamily: "monospace", cursor: "pointer" }}>{c}</button>
              ))}
            </div>
          </div>

        </div>

        {/* ═══════════════════════════════════════════════════════════
            ADMIN DASHBOARD - Emergency Management & User Monitoring
            ═══════════════════════════════════════════════════════════ */}
        {adminMode && (
          <>
            {/* Emergency Stats Overview */}
            <div className="card" style={{ borderRadius: 10, padding: 14, marginTop: 12, border: "1px solid #ffaa0030" }}>
              <div style={{ color: "#ffaa00", fontSize: 11, fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 12 }}>
                🛡️ Emergency Control Center
              </div>
              <div style={{ marginBottom: 12 }}>
                {[
                  [clients.filter(c => c.status === "SAFE").length, "Evacuated", "#00ff88", "✓"],
                  [clients.filter(c => c.status === "EVACUATING").length, "Evacuating", "#ffaa00", "→"],
                  [clients.filter(c => c.status === "STANDBY").length, "Still Inside", "#ff4444", "!"],
                  [clients.filter(c => c.status === "EVACUATING" && Math.random() < 0.2).length, "Need Help", "#ff0044", "🆘"],
                ].map(([count, label, color, icon]) => (
                  <div key={label} style={{ background: `${color}08`, border: `1px solid ${color}30`, borderRadius: 8, padding: 10, textAlign: "center" }}>
                    <div style={{ fontSize: 20, fontWeight: 700, color, fontFamily: "'JetBrains Mono',monospace", marginBottom: 2 }}>{icon} {count}</div>
                    <div style={{ fontSize: 9, color: "#556677", fontFamily: "monospace", textTransform: "uppercase" }}>{label}</div>
                  </div>
                ))}
              </div>

              {/* Exit Load Distribution */}
              <div style={{ color: "#556677", fontSize: 9, fontFamily: "monospace", marginBottom: 6, textTransform: "uppercase", letterSpacing: 0.5 }}>🚪 Exit Load Distribution</div>
              {(() => {
                const exitNames = { p8: "North Exit", p23: "East N Exit", p125: "West Exit (ESC)", p133: "South Exit" };
                const exitColors = { p8: "#4488ff", p23: "#ff8844", p125: "#44ff88", p133: "#ff44aa" };
                return EX_IDS.map(eid => {
                  const load = exLoads[eid] || 0;
                  const cap = EXIT_CAPACITY[eid] || 12;
                  const ratio = Math.min(load / cap, 1);
                  const barColor = ratio > 0.8 ? "#ff4444" : ratio > 0.5 ? "#ffaa00" : exitColors[eid];
                  return (
                    <div key={eid} style={{ marginBottom: 5 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 2 }}>
                        <span style={{ color: exitColors[eid], fontSize: 9, fontFamily: "monospace", fontWeight: 600 }}>{exitNames[eid]}</span>
                        <span style={{ color: "#556677", fontSize: 9, fontFamily: "monospace" }}>{load}/{cap} ({Math.round(ratio * 100)}%)</span>
                      </div>
                      <div style={{ height: 5, background: "#0a0e14", borderRadius: 3, overflow: "hidden" }}>
                        <div style={{ height: "100%", width: `${ratio * 100}%`, background: barColor, borderRadius: 3, transition: "width .5s" }} />
                      </div>
                    </div>
                  );
                });
              })()}
            </div>

            {/* Live Clients Monitor */}
            <div className="card" style={{ borderRadius: 10, padding: 14, marginTop: 12, border: "1px solid #00aaff30" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                <div style={{ color: "#00aaff", fontSize: 11, fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, letterSpacing: 2, textTransform: "uppercase" }}>
                  👥 Controllable Clients ({clients.length})
                </div>
                <div style={{ display: "flex", gap: 6, fontSize: 8, fontFamily: "monospace" }}>
                  <span style={{ color: "#00ff88" }}>● Safe</span>
                  <span style={{ color: "#ffaa00" }}>● Evacuating</span>
                  <span style={{ color: "#ff4444" }}>● Standby</span>
                </div>
              </div>

              <div style={{ maxHeight: 400, overflowY: "auto", marginTop: 8 }}>
                {clients.map((client) => {
                  const isEvacuated = client.status === "SAFE";
                  const isEvacuating = client.status === "EVACUATING";
                  const statusColor = isEvacuated ? "#00ff88" : isEvacuating ? "#ffaa00" : "#ff4444";
                  const statusText = isEvacuated ? "Evacuated" : isEvacuating ? "Evacuating" : "Standby";
                  const exitNames = { p8: "North", p23: "East N", p125: "West", p133: "South" };
                  const currentNode = NM[client.route?.[client.progress]] || NM[client.node] || {};
                  const exitNode = client.route ? NM[client.route[client.route.length - 1]] : null;
                  
                  return (
                    <div 
                      key={client.id}
                      onClick={() => setSelectedUser(selectedUser === client.id ? null : client.id)}
                      style={{ 
                        background: selectedUser === client.id ? "#1a2a4020" : "#0a0e14", 
                        border: `1px solid ${selectedUser === client.id ? client.color + "60" : client.color + "30"}`, 
                        borderRadius: 8, 
                        padding: "8px 12px", 
                        marginBottom: 6,
                        cursor: "pointer",
                        transition: "all .2s ease"
                      }}
                    >
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: 4 }}>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 3 }}>
                            <div style={{ width: 6, height: 6, borderRadius: "50%", background: client.color, boxShadow: `0 0 6px ${client.color}` }} />
                            <span style={{ color: client.color, fontSize: 11, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                              {client.name}
                            </span>
                            <span style={{ background: `${statusColor}20`, border: `1px solid ${statusColor}`, borderRadius: 4, padding: "1px 5px", fontSize: 8, color: statusColor, fontWeight: 600 }}>{statusText}</span>
                          </div>
                          <div style={{ color: "#556677", fontSize: 9, fontFamily: "monospace", lineHeight: 1.5 }}>
                            Location: <span style={{ color: "#7799bb", fontWeight: 600 }}>{currentNode.label || client.node}</span>
                            {client.route && <> · Exit: <span style={{ color: "#00aaff" }}>{exitNode?.label || "Unknown"}</span></>}
                          </div>
                        </div>
                        {isEvacuating && (
                          <div style={{ textAlign: "right" }}>
                            <div style={{ color: statusColor, fontSize: 10, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                              {Math.round((client.progress / (client.route.length - 1)) * 100)}%
                            </div>
                            <div style={{ fontSize: 8, color: "#445566", fontFamily: "monospace" }}>
                              {client.progress}/{client.route.length - 1}
                            </div>
                          </div>
                        )}
                      </div>
                      
                      {/* Progress bar */}
                      {isEvacuating && (
                        <div style={{ height: 3, background: "#1a2a40", borderRadius: 2, overflow: "hidden", marginBottom: selectedUser === client.id ? 8 : 0 }}>
                          <div style={{ height: "100%", width: `${(client.progress / (client.route.length - 1)) * 100}%`, background: `linear-gradient(90deg, ${client.color}, ${client.color}aa)`, transition: "width .5s" }} />
                        </div>
                      )}

                      {/* Expanded details + Actions */}
                      {selectedUser === client.id && (
                        <div style={{ marginTop: 8, paddingTop: 8, borderTop: "1px solid #1a2a40" }}>
                          <div style={{ color: "#7799bb", fontSize: 9, fontFamily: "monospace", marginBottom: 4 }}>
                            📍 Position: ({Math.round(client.pos.x)}, {Math.round(client.pos.y)})
                          </div>
                          {client.route && (
                            <div style={{ color: "#7799bb", fontSize: 9, fontFamily: "monospace", marginBottom: 6 }}>
                              🛣️ Route: {client.route.length} waypoints
                            </div>
                          )}
                          {/* Admin Actions */}
                          <div style={{ display: "flex", gap: 4, marginTop: 6 }}>
                            {!isEvacuating && client.node && (
                              <button onClick={(e) => { e.stopPropagation(); evac(client.node, client.id); }}
                                style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: "none", background: "linear-gradient(135deg,#0055cc,#0088ff)", color: "#fff", fontSize: 9, fontFamily: "monospace", fontWeight: 600, cursor: "pointer" }}>
                                🚀 Start Evacuation
                              </button>
                            )}
                            {isEvacuating && (
                              <button onClick={(e) => { e.stopPropagation(); updateClient(client.id, { status: "SAFE", route: null }); }}
                                style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: "1px solid #00ff8840", background: "#00ff8810", color: "#00ff88", fontSize: 9, fontFamily: "monospace", fontWeight: 600, cursor: "pointer" }}>
                                ✓ Mark Safe
                              </button>
                            )}
                            <button onClick={(e) => { e.stopPropagation(); setActiveClientId(client.id); setAdminMode(false); }}
                              style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: `1px solid ${client.color}40`, background: `${client.color}10`, color: client.color, fontSize: 9, fontFamily: "monospace", fontWeight: 600, cursor: "pointer" }}>
                              🎮 Control
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Global Brain Analytics */}
            <div className="card" style={{ borderRadius: 10, padding: 14, marginTop: 12, border: "1px solid #44ff8830" }}>
              <div style={{ color: "#44ff88", fontSize: 11, fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 12 }}>
                🧠 AI Brain Analytics
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                <div style={{ background: "#0a0e14", borderRadius: 6, padding: 10 }}>
                  <div style={{ color: "#556677", fontSize: 8, fontFamily: "monospace", textTransform: "uppercase", marginBottom: 4 }}>Network Mode</div>
                  <div style={{ color: wifi ? "#00aaff" : "#ff8800", fontSize: 14, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                    {wifi ? "📡 Global AI" : "📶 Local Only"}
                  </div>
                </div>
                <div style={{ background: "#0a0e14", borderRadius: 6, padding: 10 }}>
                  <div style={{ color: "#556677", fontSize: 8, fontFamily: "monospace", textTransform: "uppercase", marginBottom: 4 }}>Load Balance</div>
                  <div style={{ color: (analytics?.balanceScore || 0) > 70 ? "#00ff88" : (analytics?.balanceScore || 0) > 40 ? "#ffaa00" : "#ff4444", fontSize: 14, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                    {analytics?.balanceScore || 0}%
                  </div>
                </div>
              </div>
              
              {analytics?.bottleneck && analytics.bottleneck.load > 3 && (
                <div style={{ marginTop: 10, background: "#ff111110", border: "1px solid #ff444420", borderRadius: 6, padding: "8px 12px" }}>
                  <div style={{ color: "#ff6666", fontSize: 10, fontFamily: "monospace", fontWeight: 600, marginBottom: 2 }}>⚠️ Bottleneck Detected</div>
                  <div style={{ color: "#ff8888", fontSize: 9, fontFamily: "monospace" }}>
                    Corridor {analytics.bottleneck.edge.replace("~","→")} · {analytics.bottleneck.load} users · High congestion
                  </div>
                </div>
              )}

              <div style={{ marginTop: 10, color: "#445566", fontSize: 8, fontFamily: "monospace", lineHeight: 1.6 }}>
                {wifi 
                  ? "✓ Global brain active. Congestion-aware routing. Real-time load balancing across all exits. Iterative convergence algorithm optimizing evacuation flow." 
                  : "⚠ Offline mode. Local pathfinding only. No crowd intelligence or dynamic rerouting."}
              </div>
            </div>
          </>
        )}

        {/* Blockade Manager */}
        <div className="card" style={{ border: `1px solid ${blocks.length > 0 ? "#ff444440" : "#1a2a40"}`, borderRadius: 10, padding: 14, marginTop: 12 }}>
          <div onClick={() => setShowBM(!showBM)} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer" }}>
            <span style={{ color: blocks.length > 0 ? "#ff6666" : "#8899bb", fontSize: 10, fontFamily: "monospace", letterSpacing: 1, textTransform: "uppercase" }}>⛔ Blockade & Reroute Manager ({blocks.length})</span>
            <span style={{ color: "#445566", fontSize: 10 }}>{showBM ? "▲" : "▼"}</span>
          </div>
          {showBM && <div style={{ marginTop: 10 }}>
            {/* Blockade simulation controls */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginBottom: 10 }}>
              <button onClick={doRandomBlock} style={{ padding: 10, borderRadius: 7, border: "1px solid #ff444440", background: "#ff111110", color: "#ff6666", fontFamily: "'JetBrains Mono',monospace", fontSize: 10, cursor: "pointer", fontWeight: 600 }}>
                🎲 Random Blockage
              </button>
              <button onClick={doManualReroute} style={{ padding: 10, borderRadius: 7, border: "1px solid #00aaff40", background: "#00aaff10", color: "#00aaff", fontFamily: "'JetBrains Mono',monospace", fontSize: 10, cursor: "pointer", fontWeight: 600 }}>
                🔄 Reroute All
              </button>
            </div>

            {/* Hallway-only pathfinding info */}
            <div style={{ background: "#0a0e14", borderRadius: 6, padding: 8, marginBottom: 10, border: "1px solid #1a2a40" }}>
              <div style={{ color: "#00ff88", fontSize: 9, fontFamily: "monospace", fontWeight: 600, marginBottom: 4 }}>✓ Hallway-Only Navigation Active</div>
              <div style={{ color: "#556677", fontSize: 8, fontFamily: "monospace", lineHeight: 1.5 }}>
                Paths use only green hallway nodes and edges. Regular rooms connect to nearest hallway. {HALLWAY_NODES.length} hallway waypoints ({EXTRA.length} auto-generated at {WAYPOINT_INTERVAL}px intervals) · {EDGES.length} corridor segments.
              </div>
            </div>

            {/* Active blockades list */}
            {blocks.length === 0 ? <div style={{ color: "#334455", fontSize: 10, fontFamily: "monospace", fontStyle: "italic", padding: "8px 0" }}>No active blockades.</div> :
              <>{blocks.map((b, i) => <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", background: "#0a0e14", borderRadius: 6, padding: "6px 10px", marginBottom: 4, border: "1px solid #ff111118" }}>
                <div><div style={{ color: "#ff6666", fontSize: 10, fontFamily: "monospace", fontWeight: 600 }}>{b.edge}</div><div style={{ color: "#445566", fontSize: 8, fontFamily: "monospace" }}>by {b.by} · {new Date(b.time).toLocaleTimeString()}</div></div>
                <button onClick={() => rmBlock(b.edge)} style={{ padding: "4px 10px", borderRadius: 5, border: "1px solid #00ff8840", background: "#00ff8810", color: "#00ff88", fontSize: 9, fontFamily: "monospace", cursor: "pointer", fontWeight: 600 }}>✓ Clear</button>
              </div>)}
                <button onClick={clearAll} style={{ width: "100%", marginTop: 6, padding: 8, borderRadius: 6, border: "1px solid #00ff8840", background: "#00ff8808", color: "#00ff88", fontSize: 10, fontFamily: "monospace", cursor: "pointer", fontWeight: 600 }}>Clear All & Reroute Everyone</button>
              </>}
          </div>}
        </div>

        {/* AI LOG */}
        <div ref={logRef} className="card" style={{ borderRadius: 10, padding: 12, maxHeight: 150, overflowY: "auto", fontFamily: "'JetBrains Mono',monospace", fontSize: 10, marginTop: 12 }}>
          <div style={{ color: "#445566", fontSize: 9, marginBottom: 6, letterSpacing: 1, textTransform: "uppercase" }}>AI Brain Log</div>
          {logs.map((l, i) => (
            <div key={i} style={{ marginBottom: 3, lineHeight: 1.4 }}>
              <span style={{ color: "#222" }}>[{l.time}] </span>
              <span style={{ color: l.type === "error" ? "#ff4444" : l.type === "warn" ? "#ffaa00" : l.type === "success" ? "#00ff88" : l.type === "route" ? "#00aaff" : "#556677" }}>{l.msg}</span>
            </div>
          ))}
          {logs.length === 0 && <div style={{ color: "#334455", fontStyle: "italic" }}>Awaiting...</div>}
        </div>
      </div>
    </div>
  );
}



