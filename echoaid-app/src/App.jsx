import { useState, useEffect, useRef, useCallback, useMemo } from "react";

/* ═══════════════════════════════════════════════════════════════
   ECHOAID — Disaster Evacuation Companion
   UW Mathematics & Computer Building No. 17 — 1st Floor
   Floor plan walls extracted from architectural PDF
   Room coordinates from GeoJSON (OpenCV + Tesseract extraction)
   Coordinate space: 3× PDF scale (Matrix 3,3) → ~3672×2376
   ═══════════════════════════════════════════════════════════════ */

// Transform: GeoJSON coords → SVG viewBox coords
const S = 0.48, OX = 870, OY = 180;
const tx = x => (x - OX) * S;
const ty = y => (y - OY) * S;

// ── ROOM DATA with corrected labels (GeoJSON OCR was noisy) ──
const RAW = [
  {x:1480,y:245,id:2,type:"ROOM",label:"1047"},{x:1411,y:265,id:3,type:"ROOM",label:"ELV 1101"},
  {x:1367,y:267,id:4,type:"ROOM",label:"ELV 1102"},{x:1291,y:261,id:5,type:"ROOM",label:"1100"},
  {x:2047,y:1018,id:6,type:"ROOM",label:"1063"},{x:1299,y:343,id:7,type:"ROOM",label:"1099"},
  {x:1411,y:371,id:8,type:"EXIT",label:"North Exit"},
  {x:2550,y:452,id:9,type:"ROOM",label:"1082"},{x:2626,y:453,id:10,type:"ROOM",label:"1083"},
  {x:1551,y:394,id:11,type:"ROOM",label:"1048"},
  {x:2735,y:391,id:13,type:"ROOM",label:"1083B"},
  {x:1295,y:447,id:21,type:"ROOM",label:"1045"},{x:2748,y:487,id:22,type:"ROOM",label:"1106"},
  {x:2713,y:433,id:23,type:"EXIT",label:"East N Exit"},
  {x:2833,y:482,id:24,type:"ROOM",label:"1119"},
  {x:2487,y:520,id:25,type:"ROOM",label:"1081"},{x:2416,y:520,id:26,type:"ROOM",label:"1080"},
  {x:2351,y:520,id:27,type:"ROOM",label:"1079"},{x:2284,y:520,id:28,type:"ROOM",label:"1076"},
  {x:2220,y:520,id:29,type:"ROOM",label:"1074"},{x:2152,y:520,id:30,type:"ROOM",label:"1073"},
  {x:2088,y:520,id:31,type:"ROOM",label:"1072"},{x:2021,y:520,id:32,type:"ROOM",label:"1071"},
  {x:1957,y:520,id:33,type:"ROOM",label:"1070"},{x:1857,y:520,id:34,type:"ROOM",label:"1068"},
  {x:1726,y:520,id:35,type:"ROOM",label:"1066"},{x:1591,y:521,id:36,type:"ROOM",label:"1065"},
  {x:1406,y:514,id:37,type:"ROOM",label:"1099B"},{x:1301,y:531,id:38,type:"ROOM",label:"1046"},
  {x:3062,y:547,id:39,type:"ROOM",label:"1108A"},{x:2826,y:551,id:40,type:"ROOM",label:"T084"},
  {x:3004,y:666,id:41,type:"ROOM",label:"1107"},{x:1292,y:601,id:42,type:"ROOM",label:"1117"},
  {x:1417,y:1014,id:43,type:"ROOM",label:"1036"},{x:2921,y:758,id:44,type:"ROOM",label:"1108B"},
  {x:2465,y:686,id:45,type:"ROOM",label:"1078"},{x:2282,y:681,id:46,type:"ROOM",label:"1077"},
  {x:2148,y:685,id:47,type:"ROOM",label:"1061A"},{x:1783,y:955,id:48,type:"ROOM",label:"1052"},
  {x:1419,y:647,id:49,type:"ROOM",label:"1049"},{x:1289,y:653,id:50,type:"ROOM",label:"1044"},
  {x:1418,y:749,id:52,type:"ROOM",label:"1049A"},
  {x:2021,y:941,id:51,type:"ROOM",label:"1052C"},{x:2194,y:948,id:54,type:"ROOM",label:"1061"},
  {x:949,y:770,id:55,type:"ROOM",label:"1110D"},{x:942,y:826,id:56,type:"ROOM",label:"1110A"},
  {x:1215,y:826,id:57,type:"ROOM",label:"1041"},{x:1289,y:784,id:58,type:"ROOM",label:"1042"},
  {x:2055,y:817,id:59,type:"ROOM",label:"1103"},{x:2612,y:769,id:60,type:"ROOM",label:"1110B"},
  {x:2480,y:954,id:61,type:"ROOM",label:"1085"},{x:1418,y:853,id:62,type:"ROOM",label:"1040"},
  {x:1289,y:848,id:63,type:"ROOM",label:"1043"},{x:1289,y:916,id:64,type:"ROOM",label:"1038"},
  {x:3040,y:947,id:65,type:"ROOM",label:"1088"},{x:2852,y:934,id:66,type:"ROOM",label:"1088A"},
  {x:1961,y:915,id:67,type:"ROOM",label:"1059"},{x:1419,y:935,id:68,type:"ROOM",label:"1039"},
  {x:954,y:943,id:69,type:"ROOM",label:"1902"},{x:1976,y:957,id:70,type:"ROOM",label:"1052B"},
  {x:1289,y:980,id:71,type:"ROOM",label:"1037"},{x:2936,y:970,id:72,type:"ROOM",label:"1108C"},
  {x:2852,y:976,id:73,type:"ROOM",label:"1110B2"},
  {x:3010,y:1152,id:74,type:"ROOM",label:"1088B"},{x:2833,y:1152,id:75,type:"ROOM",label:"1109"},
  {x:1289,y:1048,id:76,type:"ROOM",label:"1034"},{x:2055,y:1080,id:77,type:"ROOM",label:"1060A"},
  {x:1418,y:1095,id:78,type:"ROOM",label:"1035"},{x:1289,y:1112,id:79,type:"ROOM",label:"1033"},
  {x:1418,y:1173,id:80,type:"ROOM",label:"1032"},{x:2616,y:1174,id:81,type:"ROOM",label:"1060D"},
  {x:2477,y:1174,id:82,type:"ROOM",label:"1060C"},{x:2335,y:1175,id:83,type:"ROOM",label:"1060B"},
  {x:2219,y:1174,id:84,type:"ROOM",label:"1060"},
  {x:2278,y:1214,id:85,type:"ROOM",label:"1060E"},
  {x:1660,y:1280,id:86,type:"ROOM",label:"1056"},{x:1289,y:1179,id:87,type:"ROOM",label:"1031"},
  {x:1289,y:1243,id:89,type:"ROOM",label:"1030"},{x:1417,y:1313,id:90,type:"ROOM",label:"1058"},
  {x:2192,y:1299,id:91,type:"ROOM",label:"1060H"},
  {x:1289,y:1311,id:92,type:"ROOM",label:"1029"},
  {x:2919,y:1356,id:93,type:"ROOM",label:"1091"},{x:3199,y:1357,id:94,type:"ROOM",label:"1001"},
  {x:3099,y:1522,id:95,type:"ROOM",label:"1002"},
  {x:2351,y:1378,id:96,type:"ROOM",label:"1009"},{x:2285,y:1377,id:97,type:"ROOM",label:"1011"},
  {x:2156,y:1379,id:98,type:"ROOM",label:"1018"},{x:2218,y:1378,id:99,type:"ROOM",label:"1013"},
  {x:2092,y:1379,id:100,type:"ROOM",label:"1017"},
  {x:1289,y:1375,id:101,type:"ROOM",label:"1028"},
  {x:2909,y:1424,id:102,type:"ROOM",label:"1089"},
  {x:1296,y:1477,id:103,type:"ROOM",label:"1027"},
  {x:2865,y:1570,id:104,type:"ROOM",label:"1092"},
  {x:2550,y:1507,id:105,type:"ROOM",label:"1007"},{x:2483,y:1508,id:106,type:"ROOM",label:"1009B"},
  {x:2416,y:1507,id:107,type:"ROOM",label:"1095A"},{x:2352,y:1508,id:108,type:"ROOM",label:"1095B"},
  {x:2284,y:1507,id:109,type:"ROOM",label:"1095C"},{x:2220,y:1508,id:110,type:"ROOM",label:"1020"},
  {x:2152,y:1507,id:111,type:"ROOM",label:"1022"},{x:2088,y:1507,id:112,type:"ROOM",label:"1023"},
  {x:1989,y:1507,id:113,type:"ROOM",label:"1018B"},{x:1890,y:1507,id:114,type:"ROOM",label:"1024"},
  {x:1824,y:1507,id:115,type:"ROOM",label:"1026B"},{x:1758,y:1507,id:116,type:"ROOM",label:"1120"},
  {x:1694,y:1508,id:117,type:"ROOM",label:"1096"},{x:1626,y:1507,id:118,type:"ROOM",label:"1026A"},
  {x:1558,y:1507,id:119,type:"ROOM",label:"1026C"},
  {x:1414,y:1537,id:120,type:"ROOM",label:"1026"},
  {x:2693,y:1490,id:121,type:"ROOM",label:"1002B"},{x:2695,y:1566,id:122,type:"ROOM",label:"1115"},
  {x:1317,y:1623,id:123,type:"ROOM",label:"ESC"},{x:1506,y:1623,id:124,type:"ROOM",label:"1025"},
  {x:1378,y:1595,id:125,type:"EXIT",label:"West Exit (ESC)"},
  {x:2732,y:1630,id:133,type:"EXIT",label:"South Exit"},
  {x:1403,y:1637,id:134,type:"ROOM",label:"1026D"},
  {x:2702,y:1670,id:135,type:"ROOM",label:"1002A"},
  {x:2711,y:1758,id:136,type:"ROOM",label:"ELV 1094"},
  {x:2669,y:1714,id:137,type:"ROOM",label:"ELV 1093"},
  {x:2624,y:1757,id:138,type:"ROOM",label:"1092B"},{x:2558,y:1757,id:139,type:"ROOM",label:"1002C"},
];

const ROOMS = RAW.filter(r => r.type === "ROOM").map(r => ({ ...r, sx: tx(r.x), sy: ty(r.y) }));
const EXITS = RAW.filter(r => r.type === "EXIT").map(r => ({ ...r, sx: tx(r.x), sy: ty(r.y) }));

// ── WALL SEGMENTS extracted from architectural PDF ──
// Each [x1,y1,x2,y2] in GeoJSON 3× coordinate space
const WALLS_RAW=[[856,786,856,882],[856,882,856,786],[862,914,862,968],[864,751,1035,751],[864,994,921,994],[891,791,1008,795],[891,795,1008,795],[895,791,1003,791],[921,998,863,998],[925,994,983,994],[983,998,925,998],[986,823,1043,823],[986,823,1043,825],[986,825,1043,825],[987,994,1044,994],[987,998,1045,998],[1008,791,891,791],[1008,795,891,795],[1034,825,1034,882],[1034,825,1036,882],[1034,882,1034,825],[1036,825,1036,882],[1036,844,1081,820],[1036,882,1034,825],[1043,786,1050,882],[1043,823,986,823],[1043,825,986,825],[1043,882,856,882],[1043,882,1043,786],[1050,744,1050,882],[1050,786,1050,882],[1050,882,1043,786],[1050,882,1050,744],[1050,883,1266,890],[1050,889,1050,744],[1050,890,1050,744],[1098,823,1205,829],[1104,841,1163,841],[1104,853,1166,853],[1104,859,1166,859],[1104,871,1177,871],[1106,855,1165,855],[1106,858,1165,858],[1165,830,1104,830],[1165,882,1103,882],[1171,242,1178,481],[1171,481,1171,242],[1171,481,1352,486],[1171,486,1273,488],[1171,488,1171,242],[1171,488,1232,488],[1178,481,1178,242],[1178,481,1345,481],[1198,744,1198,819],[1198,744,1198,823],[1198,744,1266,751],[1198,751,1205,823],[1198,823,1098,823],[1198,823,1198,751],[1205,751,1205,829],[1205,823,1098,823],[1205,823,1205,751],[1205,825,1205,751],[1205,829,1098,829],[1205,829,1104,829],[1232,242,1352,249],[1232,276,1352,283],[1232,283,1239,407],[1232,407,1232,283],[1232,407,1352,414],[1232,414,1232,242],[1232,414,1345,414],[1232,883,1050,883],[1232,883,1170,883],[1232,883,1171,883],[1232,890,1168,890],[1232,1534,1347,1534],[1232,1534,1352,1541],[1232,1541,1292,1548],[1232,1548,1285,1548],[1233,890,1170,890],[1239,407,1239,283],[1239,407,1345,407],[1242,634,1242,737],[1245,771,1247,864],[1245,864,1245,771],[1245,866,1245,769],[1245,903,1247,995],[1245,995,1245,903],[1245,998,1245,900],[1245,1032,1245,1129],[1245,1034,1247,1127],[1245,1127,1245,1034],[1245,1164,1245,1261],[1245,1166,1247,1259],[1245,1259,1245,1166],[1245,1295,1245,1392],[1245,1297,1247,1390],[1245,1390,1245,1297],[1245,1427,1245,1524],[1245,1429,1247,1522],[1245,1522,1245,1429],[1247,771,1247,864],[1247,776,1251,859],[1247,859,1247,776],[1247,864,1247,771],[1247,903,1247,995],[1247,948,1332,950],[1247,995,1247,903],[1247,1034,1247,1127],[1247,1080,1332,1082],[1247,1127,1247,1034],[1247,1166,1247,1259],[1247,1211,1332,1214],[1247,1259,1247,1166],[1247,1297,1247,1390],[1247,1343,1332,1345],[1247,1390,1247,1297],[1247,1429,1247,1522],[1247,1434,1251,1517],[1247,1517,1247,1434],[1247,1522,1247,1429],[1249,685,1301,685],[1249,685,1332,687],[1249,687,1301,687],[1251,776,1251,859],[1251,816,1328,816],[1251,816,1328,818],[1251,859,1251,776],[1251,948,1301,948],[1251,950,1301,950],[1251,1080,1301,1080],[1251,1082,1301,1082],[1251,1211,1301,1211],[1251,1214,1301,1214],[1251,1343,1301,1343],[1251,1345,1301,1345],[1251,1434,1251,1517],[1251,1517,1251,1434],[1259,520,1259,588],[1259,520,1266,583],[1259,583,1259,520],[1266,583,1266,495],[1266,583,1266,520],[1266,583,1328,585],[1266,744,1198,744],[1266,751,1198,751],[1266,883,1050,883],[1266,890,1050,890],[1273,486,1171,486],[1273,486,1344,486],[1273,488,1171,488],[1273,619,1332,621],[1273,750,1332,753],[1273,882,1332,884],[1273,1014,1332,1016],[1273,1145,1332,1148],[1273,1277,1332,1279],[1273,1409,1332,1411],[1285,1548,1292,1712],[1285,1712,1285,1548],[1285,1712,1345,1719],[1285,1719,1285,1548],[1285,1719,1345,1719],[1291,440,1240,440],[1291,441,1239,441],[1291,454,1239,454],[1291,455,1240,455],[1292,1541,1232,1541],[1292,1541,1345,1541],[1292,1548,1232,1548],[1292,1712,1292,1541],[1292,1712,1292,1548],[1328,583,1266,583],[1328,585,1266,585],[1328,816,1251,816],[1328,818,1251,818],[1332,619,1273,619],[1332,621,1273,621],[1332,685,1249,685],[1332,687,1249,687],[1332,750,1273,750],[1332,753,1273,753],[1332,790,1332,713],[1332,882,1273,882],[1332,884,1273,884],[1332,922,1332,844],[1332,948,1247,948],[1332,950,1247,950],[1332,1014,1273,1014],[1332,1016,1273,1016],[1332,1054,1332,976],[1332,1080,1247,1080],[1332,1082,1247,1082],[1332,1145,1273,1145],[1332,1148,1273,1148],[1332,1185,1332,1108],[1332,1211,1247,1211],[1332,1214,1247,1214],[1332,1277,1273,1277],[1332,1279,1273,1279],[1332,1317,1332,1239],[1332,1343,1247,1343],[1332,1345,1247,1345],[1332,1409,1273,1409],[1332,1411,1273,1411],[1332,1441,1332,1371],[1338,1662,1461,1670],[1338,1712,1338,1662],[1341,486,1344,560],[1341,560,1341,486],[1344,560,1344,486],[1345,185,1429,192],[1345,202,1429,204],[1345,242,1232,242],[1345,242,1345,185],[1345,249,1239,249],[1345,276,1239,276],[1345,283,1239,283],[1345,305,1458,310],[1345,414,1352,481],[1345,481,1345,414],[1345,1541,1345,1662],[1345,1541,1352,1611],[1345,1611,1345,1541],[1345,1611,1458,1615],[1345,1670,1461,1670],[1345,1712,1285,1712],[1345,1719,1285,1719],[1347,486,1347,562],[1347,558,1458,562],[1347,1470,1347,1534],[1347,1491,1408,1495],[1352,242,1232,242],[1352,249,1232,249],[1352,276,1232,276],[1352,283,1232,283],[1352,298,1421,301],[1352,305,1352,242],[1352,407,1232,407],[1352,414,1232,414],[1352,436,1401,459],[1352,441,1401,464],[1352,481,1171,481],[1352,481,1352,414],[1352,486,1171,486],[1352,534,1352,371],[1352,1491,1404,1491],[1352,1495,1352,1611],[1352,1495,1408,1495],[1352,1534,1232,1534],[1352,1541,1232,1541],[1352,1611,1352,1541],[1352,1615,1453,1615],[1352,1662,1453,1662],[1365,611,1472,615],[1365,705,1369,814],[1365,814,1365,705],[1365,814,1472,816],[1365,816,1369,870],[1365,870,1365,705],[1365,870,1365,816],[1365,894,1472,896],[1365,920,1369,974],[1365,974,1365,920],[1365,974,1472,976],[1365,976,1369,1030],[1365,1030,1365,920],[1365,1030,1365,976],[1365,1054,1472,1056],[1365,1080,1369,1134],[1365,1134,1365,1080],[1365,1134,1472,1136],[1365,1136,1369,1190],[1365,1190,1365,1080],[1365,1190,1365,1136],[1365,1214,1472,1216],[1365,1216,1369,1415],[1365,1415,1365,1216],[1365,1415,1472,1418],[1365,1418,1365,1210],[1365,1418,1472,1418],[1369,682,1468,682],[1369,682,1468,684],[1369,814,1369,705],[1369,870,1369,816],[1369,974,1369,920],[1369,1030,1369,976],[1369,1134,1369,1080],[1369,1190,1369,1136],[1369,1415,1369,1216],[1369,1415,1468,1415],[1377,414,1429,414],[1401,1567,1351,1594],[1401,1611,1453,1611],[1404,428,1404,484],[1405,427,1405,485],[1408,1467,1458,1467],[1408,1467,1458,1472],[1408,1491,1347,1491],[1408,1495,1347,1495],[1421,192,1352,192],[1421,202,1352,202],[1421,298,1352,298],[1421,301,1352,301],[1421,305,1352,305],[1429,185,1345,185],[1429,192,1345,192],[1429,202,1345,202],[1429,204,1345,204],[1429,484,1429,414],[1430,573,1366,541],[1442,212,1586,212],[1442,212,1586,219],[1450,219,1450,272],[1450,219,1512,219],[1452,427,1452,485],[1453,310,1392,310],[1453,310,1458,532],[1453,532,1453,310],[1453,558,1403,558],[1453,1498,1453,1611],[1453,1563,1508,1566],[1458,305,1345,305],[1458,310,1345,310],[1458,532,1458,305],[1458,532,1458,310],[1458,558,1347,558],[1458,562,1347,562],[1458,1467,1408,1467],[1458,1472,1408,1472],[1458,1566,1458,1626],[1458,1611,1345,1611],[1458,1615,1345,1615],[1460,1566,1460,1626],[1460,1566,1462,1626],[1460,1626,1460,1566],[1461,1662,1338,1662],[1461,1670,1338,1670],[1462,1566,1462,1629],[1462,1626,1462,1566],[1468,615,1369,615],[1468,648,1472,814],[1468,682,1369,682],[1468,684,1369,684],[1468,814,1369,814],[1468,814,1468,648],[1468,816,1369,816],[1468,816,1472,870],[1468,870,1468,816],[1468,894,1369,894],[1468,896,1369,896],[1468,920,1472,974],[1468,974,1369,974],[1468,974,1468,920],[1468,976,1369,976],[1468,976,1472,1030],[1468,1030,1468,976],[1468,1054,1369,1054],[1468,1056,1369,1056],[1468,1080,1472,1134],[1468,1134,1369,1134],[1468,1134,1468,1080],[1468,1136,1369,1136],[1468,1136,1472,1190],[1468,1190,1468,1136],[1468,1214,1369,1214],[1468,1216,1369,1216],[1468,1216,1472,1381],[1468,1381,1468,1216],[1472,611,1365,611],[1472,615,1365,615],[1472,814,1365,814],[1472,814,1472,648],[1472,816,1365,816],[1472,870,1472,648],[1472,870,1472,816],[1472,894,1365,894],[1472,896,1365,896],[1472,974,1365,974],[1472,974,1472,920],[1472,976,1365,976],[1472,1030,1472,920],[1472,1030,1472,976],[1472,1054,1365,1054],[1472,1056,1365,1056],[1472,1134,1365,1134],[1472,1134,1472,1080],[1472,1136,1365,1136],[1472,1190,1472,1080],[1472,1190,1472,1136],[1472,1214,1365,1214],[1472,1216,1365,1216],[1472,1381,1472,1210],[1472,1381,1472,1216],[1472,1415,1365,1415],[1472,1418,1365,1418],[1474,1644,1474,1696],[1474,1679,1559,1682],[1474,1688,1559,1696],[1474,1696,1559,1696],[1482,1682,1551,1682],[1482,1688,1551,1688],[1508,1563,1453,1563],[1508,1566,1453,1566],[1512,219,1516,272],[1512,272,1512,219],[1516,219,1578,219],[1516,272,1516,219],[1521,366,1578,366],[1521,366,1586,369],[1521,395,1521,496],[1521,423,1586,431],[1521,496,1525,559],[1521,559,1521,496],[1521,562,1521,496],[1521,1329,1524,1403],[1521,1403,1521,1329],[1521,1417,1803,1418],[1521,1418,1521,1326],[1521,1471,1523,1533],[1521,1533,1521,1467],[1521,1533,1521,1471],[1523,1533,1523,1471],[1524,1403,1524,1329],[1525,369,1578,369],[1525,423,1578,423],[1525,559,1525,496],[1529,431,1586,431],[1534,759,1534,840],[1534,759,1538,840],[1534,840,1534,759],[1535,671,1535,743],[1535,671,1538,743],[1535,743,1535,671],[1535,940,1535,1005],[1535,940,1538,1005],[1535,1005,1535,940],[1535,1023,1535,1101],[1535,1190,1535,1269],[1535,1190,1538,1269],[1535,1269,1535,1190],[1535,1329,1535,1403],[1535,1329,1538,1403],[1535,1403,1535,1329],[1536,1415,1786,1417],[1538,611,1748,615],[1538,615,1745,615],[1538,615,1748,615],[1538,743,1538,671],[1538,840,1538,759],[1538,897,1538,661],[1538,1005,1538,940],[1538,1110,1538,940],[1538,1144,1784,1144],[1538,1144,1784,1147],[1538,1147,1784,1147],[1538,1269,1538,1190],[1538,1297,1538,1181],[1538,1403,1538,1329],[1538,1415,1538,1320],[1546,475,1644,475],[1546,475,1644,477],[1546,1553,1644,1555],[1549,477,1642,477],[1549,477,1642,482],[1549,1548,1642,1553],[1549,1553,1642,1553],[1551,1589,1551,1644],[1551,1589,1559,1644],[1551,1644,1551,1589],[1553,482,1637,482],[1559,1644,1559,1589],[1559,1679,1474,1679],[1559,1682,1474,1682],[1559,1688,1474,1688],[1559,1696,1474,1696],[1559,1696,1559,1581],[1578,219,1578,272],[1578,219,1586,272],[1578,272,1578,219],[1578,301,1578,366],[1578,301,1586,366],[1578,366,1578,301],[1578,369,1578,423],[1578,369,1586,423],[1578,423,1578,369],[1586,212,1442,212],[1586,212,1586,280],[1586,219,1442,219],[1586,272,1586,219],[1586,293,1586,431],[1586,366,1521,366],[1586,366,1586,301],[1586,369,1521,369],[1586,423,1521,423],[1586,423,1586,369],[1586,431,1521,431],[1594,1471,1596,1548],[1594,1548,1594,1471],[1596,1548,1596,1471],[1622,559,1700,562],[1622,562,1700,562],[1622,1467,1700,1471],[1642,477,1549,477],[1642,482,1549,482],[1642,1548,1549,1548],[1642,1553,1549,1553],[1644,475,1546,475],[1644,477,1546,477],[1644,1553,1546,1553],[1644,1555,1546,1555],[1654,381,1668,448],[1654,448,1654,381],[1654,1581,1668,1649],[1654,1649,1654,1581],[1660,495,1662,559],[1660,559,1660,495],[1660,1471,1660,1534],[1660,1471,1662,1534],[1660,1534,1660,1471],[1662,559,1662,495],[1662,1534,1662,1471],[1668,448,1668,381],[1668,1649,1668,1581],[1678,475,1775,475],[1678,475,1775,477],[1678,1553,1775,1555],[1678,1555,1775,1555],[1680,477,1773,477],[1680,477,1773,482],[1680,1548,1773,1553],[1680,1553,1773,1553],[1685,482,1768,482],[1700,559,1622,559],[1700,562,1622,562],[1700,1467,1622,1467],[1700,1471,1622,1471],[1725,1471,1728,1548],[1725,1548,1725,1471],[1728,1548,1728,1471],[1748,611,1521,611],[1748,611,1538,611],[1748,615,1538,615],[1754,559,1831,562],[1754,562,1831,562],[1754,1467,1831,1471],[1773,477,1680,477],[1773,482,1680,482],[1773,1548,1680,1548],[1773,1553,1680,1553],[1775,475,1678,475],[1775,477,1678,477],[1775,1553,1678,1553],[1775,1555,1678,1555],[1784,1007,1784,1144],[1784,1023,1784,1090],[1784,1144,1538,1144],[1784,1144,1784,1090],[1784,1147,1538,1144],[1784,1147,1538,1147],[1784,1147,1784,1415],[1784,1147,1786,1271],[1784,1271,1784,1147],[1784,1285,1786,1403],[1784,1403,1784,1285],[1784,1415,1538,1415],[1786,381,1800,448],[1786,448,1786,381],[1786,1023,1786,1090],[1786,1090,1784,1023],[1786,1090,1784,1144],[1786,1090,1786,1023],[1786,1271,1786,1090],[1786,1271,1786,1147],[1786,1403,1786,1285],[1786,1415,1536,1415],[1786,1417,1536,1417],[1786,1581,1800,1649],[1786,1649,1786,1581],[1791,495,1794,559],[1791,559,1791,495],[1791,1471,1791,1534],[1791,1471,1794,1534],[1791,1534,1791,1471],[1794,559,1794,495],[1794,1534,1794,1471],[1800,448,1800,381],[1800,611,1999,615],[1800,615,1889,615],[1800,615,1995,615],[1800,615,1999,615],[1800,1649,1800,1581],[1803,1417,1521,1417],[1803,1418,1521,1418],[1810,475,1907,475],[1810,475,1907,477],[1810,1553,1907,1555],[1810,1555,1907,1555],[1812,477,1905,477],[1812,477,1905,482],[1812,1548,1905,1553],[1812,1553,1905,1553],[1817,482,1900,482],[1825,1415,1999,1418],[1831,559,1754,559],[1831,562,1754,562],[1831,1467,1754,1467],[1831,1471,1754,1471],[1857,1471,1859,1548],[1857,1548,1857,1471],[1859,1548,1859,1471],[1885,559,1963,562],[1885,562,1963,562],[1885,1467,1963,1471],[1889,611,1784,611],[1905,477,1812,477],[1905,482,1812,482],[1905,1548,1812,1548],[1905,1553,1812,1553],[1907,475,1810,475],[1907,477,1810,477],[1907,1553,1810,1553],[1907,1555,1810,1555],[1917,381,1931,448],[1917,448,1917,381],[1917,1581,1931,1649],[1917,1649,1917,1581],[1923,495,1923,559],[1923,495,1925,559],[1923,559,1923,495],[1923,611,1784,611],[1923,611,1999,611],[1924,1471,1924,1534],[1924,1471,1926,1534],[1924,1534,1924,1471],[1925,495,1925,559],[1925,559,1925,495],[1926,1534,1926,1471],[1931,448,1931,381],[1931,1649,1931,1581],[1938,891,1938,1015],[1938,891,1999,896],[1938,896,1942,1010],[1938,1010,1938,896],[1938,1010,1994,1010],[1938,1010,1999,1011],[1938,1011,1999,1013],[1938,1013,1999,1015],[1938,1015,1995,1015],[1938,1015,1999,1015],[1941,475,2039,475],[1941,475,2039,477],[1941,1553,2039,1555],[1941,1555,2039,1555],[1942,896,1942,1010],[1942,1010,1942,896],[1942,1010,1994,1010],[1944,477,2036,477],[1944,477,2036,482],[1944,1548,2036,1553],[1944,1553,2036,1553],[1948,482,2031,482],[1948,1548,2031,1548],[1963,559,1885,559],[1963,562,1885,562],[1963,1467,1885,1467],[1963,1471,1885,1471],[1989,488,1991,559],[1989,559,1989,488],[1991,559,1991,488],[1994,896,1942,896],[1994,918,1999,988],[1994,988,1994,918],[1994,1010,1938,1010],[1995,640,1995,795],[1995,640,1999,795],[1995,795,1995,640],[1995,1015,1995,1150],[1995,1015,1999,1150],[1995,1150,1995,1015],[1995,1193,1995,1415],[1995,1193,1999,1415],[1995,1415,1825,1415],[1995,1415,1995,1193],[1999,611,1800,611],[1999,611,1923,611],[1999,611,1925,611],[1999,615,1800,615],[1999,795,1999,640],[1999,797,1999,640],[1999,891,1938,891],[1999,896,1938,896],[1999,988,1999,840],[1999,988,1999,918],[1999,1010,1938,1010],[1999,1011,1938,1011],[1999,1013,1938,1013],[1999,1015,1938,1015],[1999,1150,1999,1010],[1999,1150,1999,1015],[1999,1415,1825,1415],[1999,1415,1999,1193],[1999,1418,1825,1418],[1999,1418,1999,1210],[2017,559,2094,562],[2017,562,2094,562],[2017,1467,2094,1471],[2036,477,1944,477],[2036,482,1944,482],[2036,1548,1944,1548],[2036,1553,1944,1553],[2039,475,1941,475],[2039,477,1941,477],[2039,1553,1941,1553],[2039,1555,1941,1555],[2047,611,2217,613],[2047,627,2051,744],[2047,744,2047,627],[2047,759,2051,876],[2047,876,2047,759],[2047,928,2047,611],[2047,1022,2051,1139],[2047,1139,2047,1022],[2047,1153,2051,1211],[2047,1206,2047,970],[2047,1211,2047,1153],[2047,1211,2160,1214],[2047,1269,2140,1271],[2047,1417,2098,1418],[2049,381,2063,448],[2049,448,2049,381],[2049,1581,2063,1649],[2049,1649,2049,1581],[2051,744,2051,627],[2051,876,2051,759],[2051,1139,2051,1022],[2051,1211,2051,1153],[2055,495,2055,559],[2055,495,2057,559],[2055,559,2055,495],[2055,1471,2055,1534],[2055,1471,2057,1534],[2055,1534,2055,1471],[2057,495,2057,559],[2057,559,2057,495],[2057,1534,2057,1471],[2061,760,2064,876],[2061,876,2061,759],[2061,876,2061,760],[2061,1022,2064,1138],[2061,1138,2061,1022],[2061,1138,2267,1139],[2061,1139,2061,1022],[2061,1285,2061,1401],[2061,1285,2064,1401],[2061,1401,2061,1285],[2063,448,2063,381],[2063,613,2217,615],[2063,1139,2267,1141],[2063,1271,2140,1273],[2063,1649,2063,1581],[2064,876,2064,760],[2064,928,2064,760],[2064,1138,2064,970],[2064,1138,2064,1022],[2064,1269,2137,1269],[2064,1273,2064,1415],[2064,1273,2140,1273],[2064,1401,2064,1285],[2073,475,2170,475],[2073,475,2170,477],[2073,1553,2170,1555],[2073,1555,2170,1555],[2075,477,2168,477],[2075,477,2168,482],[2075,1548,2168,1553],[2075,1553,2168,1553],[2080,482,2163,482],[2094,559,2017,559],[2094,562,2017,562],[2094,1467,2017,1467],[2094,1471,2017,1471],[2098,1417,2047,1417],[2098,1418,2047,1418],[2114,757,2217,760],[2119,482,2119,559],[2119,482,2123,559],[2119,559,2119,482],[2120,1471,2123,1548],[2120,1548,2120,1471],[2123,482,2123,559],[2123,559,2123,482],[2123,1548,2123,1471],[2124,1342,2124,1415],[2124,1345,2126,1415],[2124,1415,2124,1345],[2126,1345,2126,1415],[2126,1415,2126,1345],[2137,1248,2269,1251],[2140,1269,2047,1269],[2140,1271,2047,1271],[2140,1271,2063,1271],[2140,1273,2063,1273],[2148,559,2226,562],[2148,562,2226,562],[2148,1467,2226,1471],[2152,1415,2226,1418],[2160,1211,2047,1211],[2160,1211,2051,1211],[2160,1214,2047,1214],[2168,477,2075,477],[2168,482,2075,482],[2168,1548,2075,1548],[2168,1553,2075,1553],[2170,475,2073,475],[2170,477,2073,477],[2170,1553,2073,1553],[2170,1555,2073,1555],[2180,381,2195,448],[2180,448,2180,381],[2180,1581,2195,1649],[2180,1649,2180,1581],[2186,495,2186,559],[2186,495,2188,559],[2186,559,2186,495],[2186,1141,2063,1141],[2186,1141,2186,1211],[2186,1141,2188,1211],[2186,1211,2186,1141],[2186,1345,2188,1415],[2186,1415,2186,1345],[2186,1471,2186,1534],[2186,1471,2188,1534],[2186,1534,2186,1471],[2188,495,2188,559],[2188,559,2188,495],[2188,1141,2188,1211],[2188,1211,2188,1141],[2188,1342,2306,1345],[2188,1415,2188,1342],[2188,1415,2188,1345],[2188,1534,2188,1471],[2195,448,2195,381],[2195,1649,2195,1581],[2205,475,2302,475],[2205,475,2302,477],[2205,1553,2302,1555],[2205,1555,2302,1555],[2207,477,2300,477],[2207,477,2300,482],[2207,1548,2300,1553],[2207,1553,2300,1553],[2217,611,2047,611],[2217,613,2047,613],[2217,613,2063,613],[2217,615,2063,615],[2217,757,2114,757],[2217,760,2114,760],[2222,1342,2306,1342],[2226,559,2148,559],[2226,562,2148,562],[2226,1415,2152,1415],[2226,1418,2152,1418],[2226,1467,2148,1467],[2226,1471,2148,1471],[2240,757,2312,759],[2240,759,2330,760],[2246,615,2246,757],[2246,615,2250,744],[2246,744,2246,615],[2246,744,2312,748],[2250,615,2250,744],[2250,744,2250,615],[2250,744,2312,744],[2250,757,2312,757],[2251,482,2251,559],[2251,482,2255,559],[2251,559,2251,482],[2252,1345,2254,1410],[2252,1410,2252,1345],[2252,1415,2252,1345],[2252,1471,2254,1548],[2252,1548,2252,1471],[2253,1141,2188,1141],[2253,1141,2253,1211],[2253,1141,2256,1211],[2253,1211,2253,1141],[2254,1345,2306,1345],[2254,1410,2254,1345],[2254,1415,2254,1345],[2254,1548,2254,1471],[2255,482,2255,559],[2255,559,2255,482],[2256,1141,2256,1214],[2256,1211,2256,1141],[2267,1138,2061,1138],[2267,1138,2064,1138],[2267,1139,2061,1139],[2267,1139,2063,1139],[2267,1141,2063,1141],[2268,1138,2064,1138],[2269,1248,2137,1248],[2269,1251,2137,1251],[2269,1251,2140,1251],[2280,1417,2358,1418],[2280,1467,2358,1471],[2281,559,2357,562],[2281,562,2357,562],[2290,1138,2648,1139],[2291,1248,2379,1251],[2293,1141,2293,1214],[2293,1141,2296,1211],[2293,1211,2293,1141],[2296,1141,2296,1211],[2296,1211,2296,1141],[2300,477,2207,477],[2300,482,2207,482],[2300,1548,2207,1548],[2300,1553,2207,1553],[2302,475,2205,475],[2302,477,2205,477],[2302,1553,2205,1553],[2302,1555,2205,1555],[2306,1342,2188,1342],[2306,1345,2188,1345],[2312,381,2326,448],[2312,448,2312,381],[2312,744,2246,744],[2312,748,2246,748],[2312,748,2250,748],[2312,757,2240,757],[2312,759,2240,759],[2312,1581,2326,1649],[2312,1649,2312,1581],[2317,495,2317,559],[2317,495,2321,559],[2317,559,2317,495],[2317,627,2317,744],[2317,627,2321,744],[2317,744,2317,627],[2318,1345,2318,1403],[2318,1345,2320,1403],[2318,1403,2318,1345],[2318,1471,2318,1534],[2318,1471,2320,1534],[2318,1534,2318,1471],[2320,1403,2320,1345],[2320,1534,2320,1471],[2321,495,2321,559],[2321,559,2321,495],[2321,627,2321,744],[2321,744,2321,627],[2322,1211,2379,1214],[2326,448,2326,381],[2326,757,2547,757],[2326,760,2326,1138],[2326,760,2330,1138],[2326,1138,2326,760],[2326,1139,2575,1141],[2326,1649,2326,1581],[2330,757,2575,759],[2330,759,2240,759],[2330,759,2575,760],[2330,760,2240,760],[2330,760,2330,1138],[2330,1138,2330,760],[2336,475,2434,475],[2336,475,2434,477],[2336,1553,2434,1555],[2336,1555,2434,1555],[2339,477,2431,477],[2339,477,2431,482],[2339,1548,2431,1553],[2339,1553,2431,1553],[2357,559,2281,559],[2357,562,2281,562],[2357,611,2549,615],[2358,1417,2280,1417],[2358,1418,2280,1418],[2358,1467,2280,1467],[2358,1471,2280,1471],[2371,1138,2289,1138],[2372,1141,2372,1211],[2372,1141,2375,1211],[2372,1211,2321,1211],[2372,1211,2372,1141],[2372,1214,2321,1214],[2375,1141,2375,1211],[2375,1211,2375,1141],[2379,1211,2322,1211],[2379,1214,2322,1214],[2379,1248,2291,1248],[2379,1251,2291,1251],[2383,482,2383,559],[2383,482,2386,559],[2383,559,2383,482],[2384,1345,2386,1410],[2384,1410,2384,1345],[2384,1415,2384,1345],[2384,1471,2386,1548],[2384,1548,2384,1471],[2386,482,2386,559],[2386,559,2386,482],[2386,1410,2386,1345],[2386,1415,2386,1345],[2386,1548,2386,1471],[2401,1211,2511,1214],[2401,1248,2452,1251],[2412,559,2496,562],[2412,562,2496,562],[2412,1467,2489,1471],[2431,477,2339,477],[2431,482,2339,482],[2431,1548,2339,1548],[2431,1553,2339,1553],[2434,475,2336,475],[2434,477,2336,477],[2434,1553,2336,1553],[2434,1555,2336,1555],[2444,381,2458,448],[2444,448,2444,381],[2444,1581,2458,1649],[2444,1649,2444,1581],[2448,1251,2452,1318],[2448,1318,2448,1251],[2449,495,2449,559],[2449,495,2452,559],[2449,559,2449,495],[2449,1345,2452,1401],[2449,1401,2449,1345],[2449,1401,2547,1405],[2449,1415,2449,1345],[2449,1471,2449,1534],[2449,1471,2452,1534],[2449,1534,2449,1471],[2452,495,2452,559],[2452,559,2452,495],[2452,1248,2401,1248],[2452,1251,2401,1251],[2452,1318,2452,1248],[2452,1318,2452,1251],[2452,1401,2452,1341],[2452,1401,2452,1345],[2452,1534,2452,1471],[2458,448,2458,381],[2458,1649,2458,1581],[2468,475,2522,477],[2468,1553,2565,1555],[2468,1555,2565,1555],[2470,477,2522,477],[2470,477,2528,482],[2470,1548,2563,1553],[2470,1553,2563,1553],[2489,1467,2412,1467],[2489,1471,2412,1471],[2496,559,2412,559],[2496,562,2412,562],[2497,1248,2652,1251],[2511,1211,2401,1211],[2511,1214,2401,1214],[2515,1471,2517,1548],[2515,1548,2515,1471],[2517,1548,2517,1471],[2520,1600,2582,1600],[2520,1600,2591,1607],[2520,1607,2528,1702],[2520,1702,2520,1607],[2520,1710,2520,1600],[2520,1731,2528,1784],[2520,1784,2520,1731],[2520,1784,2664,1791],[2520,1791,2520,1723],[2520,1791,2664,1791],[2522,350,2522,475],[2522,350,2582,356],[2522,356,2528,475],[2522,475,2468,475],[2522,475,2522,356],[2522,477,2468,477],[2522,482,2522,559],[2522,482,2528,559],[2522,559,2522,482],[2528,356,2528,559],[2528,475,2528,356],[2528,477,2470,477],[2528,482,2470,482],[2528,559,2528,482],[2528,1607,2528,1702],[2528,1702,2528,1607],[2528,1784,2528,1731],[2534,1211,2587,1214],[2543,1405,2453,1405],[2547,760,2240,760],[2547,1401,2449,1401],[2547,1401,2452,1401],[2547,1405,2449,1405],[2549,611,2357,611],[2549,615,2357,615],[2563,1548,2470,1548],[2563,1553,2470,1553],[2565,1553,2468,1553],[2565,1555,2468,1555],[2571,611,2652,612],[2571,1417,2652,1418],[2571,1418,2652,1418],[2574,627,2652,629],[2574,760,2577,815],[2574,815,2574,760],[2574,818,2574,760],[2574,1401,2652,1403],[2575,356,2582,479],[2575,479,2575,356],[2575,496,2579,559],[2575,559,2575,496],[2575,757,2330,757],[2575,759,2330,759],[2575,759,2652,760],[2575,760,2330,760],[2575,1139,2326,1139],[2575,1141,2326,1141],[2577,760,2648,815],[2577,815,2577,760],[2579,559,2579,496],[2581,1153,2581,1211],[2581,1153,2583,1211],[2581,1211,2581,1153],[2582,336,2582,481],[2582,336,2667,344],[2582,344,2591,481],[2582,350,2522,350],[2582,356,2522,356],[2582,479,2582,356],[2582,481,2582,344],[2582,815,2648,818],[2582,1548,2591,1600],[2582,1600,2582,1548],[2583,1153,2583,1211],[2583,1211,2583,1153],[2587,496,2591,559],[2587,559,2587,496],[2587,792,2638,812],[2587,812,2638,792],[2587,1211,2534,1211],[2587,1214,2534,1214],[2587,1471,2591,1533],[2587,1533,2587,1471],[2587,1535,2587,1471],[2588,1733,2530,1733],[2588,1782,2530,1782],[2589,612,2652,615],[2589,615,2648,615],[2589,625,2652,627],[2589,757,2652,759],[2589,1139,2648,1141],[2589,1403,2652,1405],[2589,1415,2652,1417],[2590,1731,2594,1784],[2590,1784,2528,1784],[2590,1784,2590,1731],[2591,481,2591,344],[2591,559,2591,344],[2591,559,2591,496],[2591,1533,2591,1471],[2591,1600,2520,1600],[2591,1600,2591,1548],[2591,1607,2520,1607],[2591,1607,2528,1607],[2591,1607,2591,1467],[2593,352,2593,528],[2593,352,2659,354],[2593,391,2595,528],[2593,528,2593,391],[2594,1784,2594,1731],[2595,391,2595,528],[2595,528,2595,391],[2615,629,2618,757],[2615,757,2615,629],[2618,757,2618,629],[2635,629,2638,757],[2635,757,2635,629],[2638,757,2638,629],[2641,559,2691,562],[2647,1504,2762,1509],[2647,1534,2647,1697],[2647,1534,2652,1646],[2647,1646,2647,1534],[2647,1646,2762,1649],[2647,1693,2762,1697],[2648,760,2577,815],[2648,760,2648,827],[2648,760,2652,827],[2648,815,2577,815],[2648,815,2582,815],[2648,818,2574,818],[2648,818,2582,818],[2648,827,2648,760],[2648,907,2648,1013],[2648,910,2652,1013],[2648,1013,2648,910],[2648,1071,2648,1138],[2648,1071,2652,1138],[2648,1138,2290,1138],[2648,1138,2371,1138],[2648,1138,2648,1071],[2648,1138,2648,1211],[2648,1138,2652,1211],[2648,1139,2290,1139],[2648,1139,2589,1139],[2648,1141,2375,1141],[2648,1141,2589,1141],[2648,1211,2648,1138],[2648,1248,2497,1248],[2648,1251,2500,1251],[2648,1251,2648,1401],[2648,1251,2652,1401],[2648,1401,2574,1401],[2648,1401,2648,1251],[2648,1405,2589,1405],[2648,1415,2589,1415],[2652,611,2571,611],[2652,612,2571,612],[2652,612,2589,612],[2652,615,2589,615],[2652,625,2589,625],[2652,627,2574,627],[2652,627,2589,627],[2652,629,2574,629],[2652,757,2589,757],[2652,759,2575,759],[2652,759,2589,759],[2652,760,2575,760],[2652,760,2652,830],[2652,827,2652,760],[2652,910,2652,1017],[2652,1013,2652,910],[2652,1067,2652,1138],[2652,1138,2652,1071],[2652,1138,2652,1220],[2652,1211,2652,1138],[2652,1242,2652,1418],[2652,1248,2497,1248],[2652,1251,2497,1251],[2652,1401,2574,1401],[2652,1401,2652,1251],[2652,1403,2574,1403],[2652,1403,2589,1403],[2652,1405,2589,1405],[2652,1415,2589,1415],[2652,1417,2571,1417],[2652,1417,2589,1417],[2652,1418,2571,1418],[2652,1534,2652,1646],[2652,1646,2652,1534],[2652,1646,2704,1646],[2652,1649,2753,1649],[2652,1693,2753,1693],[2654,1733,2596,1733],[2654,1782,2596,1782],[2656,1731,2656,1784],[2656,1784,2594,1784],[2659,344,2591,344],[2659,352,2593,352],[2659,354,2593,354],[2664,1784,2520,1784],[2664,1791,2520,1791],[2667,336,2582,336],[2667,344,2582,344],[2667,391,2667,336],[2677,1812,2762,1814],[2677,1823,2762,1830],[2677,1830,2677,1774],[2680,364,2874,371],[2683,413,2796,415],[2683,421,2683,488],[2683,421,2688,488],[2683,488,2683,421],[2683,492,2683,559],[2683,492,2688,558],[2683,558,2683,492],[2683,1467,2809,1471],[2684,1814,2755,1814],[2688,415,2688,558],[2688,439,2737,468],[2688,488,2688,421],[2688,558,2688,492],[2691,559,2641,559],[2691,562,2641,562],[2692,1747,2692,1697],[2714,558,2796,561],[2714,561,2796,562],[2717,1504,2659,1504],[2735,415,2735,466],[2735,415,2735,468],[2737,415,2737,466],[2737,415,2737,468],[2737,466,2735,415],[2753,587,2760,904],[2753,904,2753,587],[2753,904,2857,911],[2753,911,2753,579],[2753,911,2857,911],[2753,987,2967,987],[2753,987,3118,994],[2753,1030,2760,1282],[2753,1282,2753,1030],[2753,1311,2912,1319],[2753,1319,2912,1319],[2753,1467,2683,1467],[2753,1467,2809,1467],[2753,1471,2809,1474],[2753,1509,2652,1509],[2753,1509,2753,1646],[2753,1509,2762,1646],[2753,1605,2703,1631],[2753,1646,2753,1509],[2755,1722,2762,1774],[2755,1774,2755,1722],[2755,1823,2684,1823],[2760,904,2760,587],[2760,904,2857,904],[2760,994,2908,994],[2760,1282,2760,1030],[2760,1311,2908,1311],[2762,1474,2762,1681],[2762,1504,2647,1504],[2762,1509,2647,1509],[2762,1646,2647,1646],[2762,1646,2762,1509],[2762,1649,2647,1649],[2762,1681,2964,1681],[2762,1681,2970,1688],[2762,1688,2964,1688],[2762,1693,2647,1693],[2762,1697,2647,1697],[2762,1774,2762,1722],[2762,1812,2677,1812],[2762,1814,2677,1814],[2762,1823,2677,1823],[2762,1830,2677,1830],[2762,1830,2762,1715],[2776,562,2714,562],[2787,620,2787,676],[2788,619,2788,676],[2789,371,2688,371],[2789,413,2688,413],[2789,415,2737,415],[2789,509,2874,519],[2789,558,2738,558],[2796,413,2683,413],[2796,415,2683,415],[2796,429,2847,429],[2796,435,2858,435],[2796,440,2864,440],[2796,446,2864,446],[2796,452,2864,452],[2796,457,2864,457],[2796,463,2796,371],[2796,509,2864,509],[2796,558,2714,558],[2796,561,2714,561],[2796,562,2714,562],[2802,625,2802,676],[2805,969,2908,969],[2809,1467,2683,1467],[2809,1471,2683,1471],[2809,1471,2753,1471],[2809,1474,2753,1474],[2815,612,2815,676],[2816,614,2816,676],[2838,1445,2899,1452],[2838,1467,2838,1400],[2839,1093,2908,1093],[2839,1093,2911,1095],[2841,1095,2908,1095],[2853,877,2903,877],[2853,1521,2853,1452],[2857,904,2753,904],[2857,911,2753,911],[2863,579,2785,579],[2863,582,2785,582],[2863,587,3025,587],[2864,371,2796,371],[2864,371,2874,509],[2864,437,2796,405],[2864,509,2864,371],[2866,519,2866,579],[2866,519,2874,579],[2866,579,2866,519],[2873,612,2972,612],[2873,612,2972,614],[2873,614,2972,614],[2874,364,2680,364],[2874,371,2680,371],[2874,509,2789,509],[2874,509,2874,371],[2874,519,2789,519],[2874,579,2874,364],[2874,579,2874,519],[2874,579,3018,579],[2874,579,3025,587],[2879,904,2987,904],[2879,904,2987,911],[2879,911,2967,911],[2899,1445,2838,1445],[2899,1452,2838,1452],[2908,994,2911,1093],[2908,1093,2908,994],[2908,1095,2911,1151],[2908,1151,2908,1095],[2908,1153,2911,1287],[2908,1287,2908,1153],[2909,1445,2970,1445],[2909,1445,2984,1452],[2909,1452,2970,1452],[2911,994,3111,994],[2911,1093,2839,1093],[2911,1093,2911,994],[2911,1095,2839,1095],[2911,1151,2911,1095],[2911,1287,2911,994],[2911,1287,2911,1153],[2912,1311,2753,1311],[2912,1319,2753,1319],[2913,1400,2984,1400],[2913,1400,2984,1403],[2913,1403,2984,1408],[2920,951,2805,951],[2921,950,2805,950],[2921,950,2974,954],[2928,903,2928,848],[2929,904,2929,848],[2935,1311,3111,1311],[2935,1311,3118,1319],[2935,1319,3241,1319],[2964,1514,2964,1681],[2964,1521,2970,1681],[2964,1681,2964,1521],[2964,1691,3248,1701],[2964,1701,3248,1701],[2970,509,2984,562],[2970,562,2970,509],[2970,1408,2913,1408],[2970,1452,2984,1514],[2970,1514,2970,1452],[2970,1521,2970,1691],[2970,1681,2762,1681],[2970,1681,2970,1521],[2970,1688,2762,1688],[2970,1691,3237,1691],[2972,612,2873,612],[2972,614,2873,614],[2974,911,2974,987],[2974,950,2921,950],[2974,954,2918,954],[2974,987,3111,987],[2984,562,2984,509],[2984,1400,2913,1400],[2984,1403,2913,1403],[2984,1408,2913,1408],[2984,1445,2909,1445],[2984,1452,2909,1452],[2984,1514,2984,1452],[2984,1521,2984,1400],[2987,904,2879,904],[2987,911,2879,911],[2994,612,3056,612],[2994,612,3058,614],[2994,614,3055,614],[3010,904,3111,904],[3010,904,3118,911],[3010,911,3111,911],[3018,509,3018,579],[3018,509,3115,509],[3018,509,3115,517],[3018,517,3025,579],[3018,579,3018,517],[3025,517,3025,587],[3025,517,3102,517],[3025,579,2874,579],[3025,579,3025,517],[3025,579,3102,579],[3025,583,3102,583],[3025,587,2874,587],[3056,612,2994,612],[3058,614,2994,614],[3075,634,3075,779],[3075,634,3078,779],[3075,779,3075,634],[3075,802,3075,878],[3075,802,3078,876],[3075,876,3075,802],[3078,634,3078,779],[3078,779,3078,634],[3078,802,3078,876],[3078,876,3078,802],[3101,1400,3116,1521],[3101,1521,3101,1400],[3102,587,3102,517],[3111,627,3111,744],[3111,627,3118,744],[3111,744,3111,627],[3111,759,3111,876],[3111,759,3118,876],[3111,876,3111,759],[3111,911,3111,987],[3111,911,3118,987],[3111,987,3111,911],[3111,1022,3111,1139],[3111,1022,3118,1139],[3111,1139,3111,1022],[3111,1153,3111,1271],[3111,1153,3118,1271],[3111,1271,3111,1153],[3115,509,3018,509],[3115,509,3115,562],[3115,517,3018,517],[3116,1400,3116,1521],[3116,1521,3116,1400],[3118,579,3118,1309],[3118,744,3118,627],[3118,876,3118,759],[3118,904,3010,904],[3118,911,3010,911],[3118,987,2753,987],[3118,987,3118,911],[3118,994,2753,994],[3118,1139,3118,1022],[3118,1271,3118,1153],[3118,1309,3248,1309],[3118,1309,3248,1319],[3118,1311,2935,1311],[3118,1319,2935,1319],[3136,1399,3136,1320],[3141,1399,3141,1320],[3144,1402,3174,1319],[3145,1394,3241,1394],[3145,1400,3237,1400],[3146,1395,3146,1319],[3147,1394,3248,1400],[3152,1380,3152,1320],[3237,1400,3248,1691],[3237,1691,3237,1400],[3241,1319,3248,1394],[3241,1394,3241,1319],[3248,1309,3118,1309],[3248,1319,3118,1319],[3248,1394,3147,1394],[3248,1394,3248,1319],[3248,1400,3145,1400],[3248,1691,2964,1691],[3248,1691,3248,1400],[3248,1701,2964,1701],[3248,1701,3248,1309]];

// ── NAVIGATION GRAPH ──
const NAV_RAW = RAW.map(r => ({ id: `p${r.id}`, x: tx(r.x), y: ty(r.y), label: r.label, feat: r }));
// ── CORRIDOR WAYPOINTS — placed on actual hallway centerlines traced from PDF ──
// Each waypoint sits in the middle of a real corridor, not inside any room
const EXTRA = [
  // WEST SPINE (x≈1365, between left rooms @1289 and right rooms @1418)
  {id:"wc_top",x:tx(1365),y:ty(465)},{id:"wc_n1",x:tx(1365),y:ty(530)},
  {id:"wc_n2",x:tx(1365),y:ty(600)},{id:"wc_n3",x:tx(1365),y:ty(660)},
  {id:"wc_n4",x:tx(1365),y:ty(750)},{id:"wc_n5",x:tx(1365),y:ty(790)},
  {id:"wc_n6",x:tx(1365),y:ty(855)},{id:"wc_mid",x:tx(1365),y:ty(920)},
  {id:"wc_s1",x:tx(1365),y:ty(985)},{id:"wc_s2",x:tx(1365),y:ty(1050)},
  {id:"wc_s3",x:tx(1365),y:ty(1100)},{id:"wc_s4",x:tx(1365),y:ty(1180)},
  {id:"wc_s5",x:tx(1365),y:ty(1250)},{id:"wc_s6",x:tx(1365),y:ty(1315)},
  {id:"wc_s7",x:tx(1365),y:ty(1380)},{id:"wc_s8",x:tx(1365),y:ty(1470)},
  {id:"wc_bot",x:tx(1365),y:ty(1540)},
  // NORTH CORRIDOR (y≈475, horizontal)
  {id:"nc_w",x:tx(1460),y:ty(475)},{id:"nc_1",x:tx(1555),y:ty(475)},
  {id:"nc_2",x:tx(1595),y:ty(475)},{id:"nc_3",x:tx(1730),y:ty(475)},
  {id:"nc_4",x:tx(1860),y:ty(475)},{id:"nc_5",x:tx(1960),y:ty(475)},
  {id:"nc_6",x:tx(2025),y:ty(475)},{id:"nc_7",x:tx(2060),y:ty(475)},
  {id:"nc_8",x:tx(2155),y:ty(475)},{id:"nc_9",x:tx(2225),y:ty(475)},
  {id:"nc_10",x:tx(2290),y:ty(475)},{id:"nc_11",x:tx(2355),y:ty(475)},
  {id:"nc_12",x:tx(2420),y:ty(475)},{id:"nc_13",x:tx(2490),y:ty(475)},
  {id:"nc_14",x:tx(2555),y:ty(475)},{id:"nc_15",x:tx(2630),y:ty(475)},
  {id:"nc_e",x:tx(2680),y:ty(475)},{id:"nc_ee",x:tx(2740),y:ty(475)},
  // SOUTH CORRIDOR (y≈1460, horizontal)
  {id:"sc_w",x:tx(1460),y:ty(1460)},{id:"sc_1",x:tx(1560),y:ty(1460)},
  {id:"sc_2",x:tx(1630),y:ty(1460)},{id:"sc_3",x:tx(1700),y:ty(1460)},
  {id:"sc_4",x:tx(1760),y:ty(1460)},{id:"sc_5",x:tx(1830),y:ty(1460)},
  {id:"sc_6",x:tx(1900),y:ty(1460)},{id:"sc_7",x:tx(1990),y:ty(1460)},
  {id:"sc_8",x:tx(2060),y:ty(1460)},{id:"sc_9",x:tx(2155),y:ty(1460)},
  {id:"sc_10",x:tx(2225),y:ty(1460)},{id:"sc_11",x:tx(2290),y:ty(1460)},
  {id:"sc_12",x:tx(2355),y:ty(1460)},{id:"sc_13",x:tx(2420),y:ty(1460)},
  {id:"sc_14",x:tx(2485),y:ty(1460)},{id:"sc_15",x:tx(2555),y:ty(1460)},
  {id:"sc_e",x:tx(2680),y:ty(1460)},
  // CENTRAL CORRIDOR (y≈1345, through 1017-1009)
  {id:"cc_w",x:tx(1460),y:ty(1345)},{id:"cc_1",x:tx(2060),y:ty(1345)},
  {id:"cc_2",x:tx(2095),y:ty(1345)},{id:"cc_3",x:tx(2160),y:ty(1345)},
  {id:"cc_4",x:tx(2225),y:ty(1345)},{id:"cc_5",x:tx(2290),y:ty(1345)},
  {id:"cc_6",x:tx(2355),y:ty(1345)},{id:"cc_e",x:tx(2680),y:ty(1345)},
  // MID-VERTICAL (x≈2060, center of building N-S)
  {id:"mv_1",x:tx(2060),y:ty(685)},{id:"mv_2",x:tx(2060),y:ty(820)},
  {id:"mv_3",x:tx(2060),y:ty(950)},{id:"mv_4",x:tx(2060),y:ty(1080)},
  {id:"mv_5",x:tx(2060),y:ty(1200)},
  // EAST-VERTICAL (x≈2680)
  {id:"ev_1",x:tx(2680),y:ty(770)},{id:"ev_2",x:tx(2680),y:ty(950)},
  {id:"ev_3",x:tx(2680),y:ty(1170)},{id:"ev_6",x:tx(2680),y:ty(1570)},
  {id:"ev_7",x:tx(2680),y:ty(1630)},{id:"ev_8",x:tx(2680),y:ty(1720)},
  // FAR-EAST (x≈2920)
  {id:"fe_1",x:tx(2920),y:ty(570)},{id:"fe_2",x:tx(2920),y:ty(760)},
  {id:"fe_3",x:tx(2920),y:ty(950)},{id:"fe_4",x:tx(2920),y:ty(1155)},
  {id:"fe_5",x:tx(2920),y:ty(1360)},{id:"fe_6",x:tx(2920),y:ty(1530)},
  // ANNEX (west wing)
  {id:"ax_jn",x:tx(1200),y:ty(790)},{id:"ax_1",x:tx(1100),y:ty(790)},
  {id:"ax_2",x:tx(1100),y:ty(830)},{id:"ax_3",x:tx(1100),y:ty(945)},
  // TOP AREA (elevators, above north corridor)
  {id:"top_1",x:tx(1365),y:ty(340)},{id:"top_2",x:tx(1410),y:ty(280)},
  // SOUTH-WEST (below west spine)
  {id:"sw_1",x:tx(1365),y:ty(1600)},{id:"sw_2",x:tx(1365),y:ty(1640)},
  {id:"sw_3",x:tx(1510),y:ty(1600)},
  // SOUTH-EAST CORNER
  {id:"se_1",x:tx(2740),y:ty(1630)},{id:"se_2",x:tx(2700),y:ty(1670)},
];
const NODES = [...NAV_RAW, ...EXTRA];
const NM = {}; NODES.forEach(n => NM[n.id] = n);

// ── EDGES — strictly along corridors, no wall-cutting diagonals ──
const EDGES = [
  // WEST SPINE chain
  ["wc_top","wc_n1"],["wc_n1","wc_n2"],["wc_n2","wc_n3"],["wc_n3","wc_n4"],
  ["wc_n4","wc_n5"],["wc_n5","wc_n6"],["wc_n6","wc_mid"],["wc_mid","wc_s1"],
  ["wc_s1","wc_s2"],["wc_s2","wc_s3"],["wc_s3","wc_s4"],["wc_s4","wc_s5"],
  ["wc_s5","wc_s6"],["wc_s6","wc_s7"],["wc_s7","wc_s8"],["wc_s8","wc_bot"],
  // West spine → horizontal corridor corners (L-shaped turns)
  ["wc_top","nc_w"],["wc_s7","cc_w"],["wc_s8","sc_w"],["wc_bot","sc_w"],
  // NORTH CORRIDOR chain
  ["nc_w","nc_1"],["nc_1","nc_2"],["nc_2","nc_3"],["nc_3","nc_4"],["nc_4","nc_5"],
  ["nc_5","nc_6"],["nc_6","nc_7"],["nc_7","nc_8"],["nc_8","nc_9"],["nc_9","nc_10"],
  ["nc_10","nc_11"],["nc_11","nc_12"],["nc_12","nc_13"],["nc_13","nc_14"],
  ["nc_14","nc_15"],["nc_15","nc_e"],["nc_e","nc_ee"],
  // SOUTH CORRIDOR chain
  ["sc_w","sc_1"],["sc_1","sc_2"],["sc_2","sc_3"],["sc_3","sc_4"],["sc_4","sc_5"],
  ["sc_5","sc_6"],["sc_6","sc_7"],["sc_7","sc_8"],["sc_8","sc_9"],["sc_9","sc_10"],
  ["sc_10","sc_11"],["sc_11","sc_12"],["sc_12","sc_13"],["sc_13","sc_14"],
  ["sc_14","sc_15"],["sc_15","sc_e"],
  // CENTRAL CORRIDOR chain
  ["cc_w","cc_1"],["cc_1","cc_2"],["cc_2","cc_3"],["cc_3","cc_4"],["cc_4","cc_5"],
  ["cc_5","cc_6"],["cc_6","cc_e"],
  // MID-VERTICAL chain (with junctions to horizontal corridors)
  ["nc_7","mv_1"],["mv_1","mv_2"],["mv_2","mv_3"],["mv_3","mv_4"],["mv_4","mv_5"],
  ["mv_5","cc_1"],["cc_1","sc_8"],
  // EAST-VERTICAL chain
  ["nc_e","ev_1"],["ev_1","ev_2"],["ev_2","ev_3"],["ev_3","cc_e"],
  ["cc_e","sc_e"],["sc_e","ev_6"],["ev_6","ev_7"],["ev_7","ev_8"],
  // FAR-EAST chain + cross-links to east-vertical
  ["fe_1","fe_2"],["fe_2","fe_3"],["fe_3","fe_4"],["fe_4","fe_5"],["fe_5","fe_6"],
  ["nc_ee","fe_1"],["ev_1","fe_2"],["ev_2","fe_3"],["ev_3","fe_4"],["cc_e","fe_5"],["ev_6","fe_6"],
  // ANNEX
  ["wc_n5","ax_jn"],["ax_jn","ax_1"],["ax_1","ax_2"],["ax_2","ax_3"],
  // TOP AREA
  ["wc_top","top_1"],["top_1","top_2"],
  // SOUTH-WEST
  ["wc_bot","sw_1"],["sw_1","sw_2"],["sw_1","sw_3"],
  // SOUTH-EAST
  ["ev_7","se_1"],["ev_7","se_2"],

  // ═══ ROOM → nearest corridor waypoint (short door-opening step) ═══
  // Top area
  ["p2","top_2"],["p3","top_2"],["p4","top_2"],["p5","top_1"],["p7","top_1"],
  // West spine LEFT column (x≈1289)
  ["p21","wc_top"],["p38","wc_n1"],["p42","wc_n2"],["p50","wc_n3"],
  ["p58","wc_n5"],["p63","wc_n6"],["p64","wc_mid"],["p71","wc_s1"],
  ["p76","wc_s2"],["p79","wc_s3"],["p87","wc_s4"],["p89","wc_s5"],
  ["p92","wc_s6"],["p101","wc_s7"],["p103","wc_s8"],
  // West spine RIGHT column (x≈1418)
  ["p37","wc_n1"],["p49","wc_n3"],["p52","wc_n4"],["p62","wc_n6"],
  ["p68","wc_mid"],["p43","wc_s2"],["p78","wc_s3"],["p80","wc_s4"],["p90","wc_s6"],
  // North corridor rooms
  ["p11","nc_1"],["p36","nc_2"],["p35","nc_3"],["p34","nc_4"],["p33","nc_5"],
  ["p32","nc_6"],["p31","nc_7"],["p30","nc_8"],["p29","nc_9"],["p28","nc_10"],
  ["p27","nc_11"],["p26","nc_12"],["p25","nc_13"],["p9","nc_14"],["p10","nc_15"],
  // Central area (mid-vertical)
  ["p47","mv_1"],["p46","mv_1"],["p45","mv_1"],["p59","mv_2"],
  ["p6","mv_3"],["p48","mv_3"],["p51","mv_3"],["p67","mv_3"],["p70","mv_3"],
  ["p54","mv_3"],["p77","mv_4"],["p84","mv_5"],["p85","mv_5"],
  ["p83","mv_5"],["p82","mv_5"],["p91","mv_5"],["p86","mv_5"],
  // East-vertical rooms
  ["p61","ev_2"],["p81","ev_3"],["p60","ev_1"],
  ["p22","nc_ee"],["p13","nc_ee"],["p24","nc_ee"],
  ["p121","sc_e"],["p122","ev_6"],
  // Far-east rooms
  ["p39","fe_1"],["p40","fe_1"],["p41","fe_2"],["p44","fe_2"],
  ["p65","fe_3"],["p66","fe_3"],["p72","fe_3"],["p73","fe_3"],
  ["p74","fe_4"],["p75","fe_4"],["p93","fe_5"],["p94","fe_5"],
  ["p102","fe_5"],["p95","fe_6"],["p104","fe_6"],
  // Central corridor rooms (1017-1009)
  ["p100","cc_2"],["p98","cc_3"],["p99","cc_4"],["p97","cc_5"],["p96","cc_6"],
  // South corridor rooms
  ["p119","sc_1"],["p118","sc_2"],["p117","sc_3"],["p116","sc_4"],["p115","sc_5"],
  ["p114","sc_6"],["p113","sc_7"],["p112","sc_8"],["p111","sc_9"],["p110","sc_10"],
  ["p109","sc_11"],["p108","sc_12"],["p107","sc_13"],["p106","sc_14"],["p105","sc_15"],
  // South-west rooms
  ["p120","wc_bot"],["p123","sw_1"],["p134","sw_2"],["p124","sw_3"],
  // South-east corner rooms
  ["p135","se_2"],["p136","ev_8"],["p137","ev_8"],["p138","ev_8"],["p139","ev_8"],
  // Annex rooms
  ["p55","ax_1"],["p56","ax_2"],["p57","ax_jn"],["p69","ax_3"],
  // EXIT connections
  ["p8","top_1"],["p23","nc_ee"],["p125","sw_1"],["p133","se_1"],
];
const EX_IDS = ["p8","p23","p125","p133"];

// ── PATHFINDING (A*) ──
const dist = (a,b) => Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2);
function astar(s,e,bl=[]) {
  if(!NM[s]||!NM[e]) return null;
  const adj={}; NODES.forEach(n=>adj[n.id]=[]);
  EDGES.forEach(([a,b])=>{if(!bl.includes(`${a}-${b}`)&&!bl.includes(`${b}-${a}`)){adj[a]?.push(b);adj[b]?.push(a);}});
  const open=new Set([s]),from={},g={},f={};
  NODES.forEach(n=>{g[n.id]=1/0;f[n.id]=1/0;});
  g[s]=0;f[s]=dist(NM[s],NM[e]);
  while(open.size){let c=null,mf=1/0;for(const id of open)if(f[id]<mf){mf=f[id];c=id;}
    if(c===e){const p=[c];let x=c;while(from[x]){x=from[x];p.unshift(x);}return p;}
    open.delete(c);for(const nb of adj[c]||[]){const t=g[c]+dist(NM[c],NM[nb]);if(t<g[nb]){from[nb]=c;g[nb]=t;f[nb]=t+dist(NM[nb],NM[e]);open.add(nb);}}}
  return null;
}

function speak(t){if("speechSynthesis"in window){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.rate=1.1;window.speechSynthesis.speak(u);}}

/* ═══════════════════════════════════════════════════════════════
   GLOBAL BRAIN — Synchronized Multi-User Evacuation Intelligence
   
   The brain coordinates ALL evacuees simultaneously to:
   1. Balance load across exits (no single exit gets overwhelmed)
   2. Penalize congested corridors (edge bandwidth, not just nodes)
   3. Iteratively converge routes (3 passes — rerouting once isn't enough
      because person A's new route may crowd person B's corridor)
   4. Track per-exit capacity & live assignment counts
   5. Simulate user movement so congestion is dynamic
   6. Share blockade knowledge instantly across all users
   ═══════════════════════════════════════════════════════════════ */

// Exit capacity limits (people per minute throughput)
const EXIT_CAPACITY = { p8: 15, p23: 12, p125: 10, p133: 15 };

const brain = (() => {
  let users = new Map(), blocks = [], eventLog = [];

  // ── Edge congestion: counts how many active routes use each edge ──
  function edgeCong() {
    const ec = {};
    for (const [, u] of users) {
      if (!u.path) continue;
      for (let i = 0; i < u.path.length - 1; i++) {
        const ek = [u.path[i], u.path[i+1]].sort().join("~");
        ec[ek] = (ec[ek] || 0) + 1;
      }
    }
    return ec;
  }

  // ── Node congestion (for heatmap vis) ──
  function nodeCong() {
    const c = {};
    NODES.forEach(n => c[n.id] = 0);
    for (const [, u] of users) {
      if (!u.path) continue;
      // Weight nodes by how far along the user is (nodes ahead matter more)
      const start = u.progress || 0;
      for (let i = start; i < u.path.length; i++) {
        c[u.path[i]] = (c[u.path[i]] || 0) + 1;
      }
    }
    return c;
  }

  // ── Per-exit load: how many users are currently routed to each exit ──
  function exitLoads() {
    const loads = {};
    EX_IDS.forEach(e => loads[e] = 0);
    for (const [, u] of users) {
      if (!u.path || u.path.length === 0) continue;
      const dest = u.path[u.path.length - 1];
      if (loads[dest] !== undefined) loads[dest]++;
    }
    return loads;
  }

  // ── Congestion-aware route cost (the core intelligence) ──
  function routeCost(path, ec, el) {
    if (!path) return Infinity;
    let cost = 0;
    const dest = path[path.length - 1];
    for (let i = 1; i < path.length; i++) {
      const baseDist = dist(NM[path[i-1]], NM[path[i]]);
      // Edge congestion penalty — exponential to strongly discourage bottlenecks
      const ek = [path[i-1], path[i]].sort().join("~");
      const edgeLoad = ec[ek] || 0;
      const edgePenalty = edgeLoad > 3 ? edgeLoad * edgeLoad * 8 : edgeLoad * 15;
      cost += baseDist + edgePenalty;
    }
    // Exit overload penalty — push people to less-crowded exits
    const cap = EXIT_CAPACITY[dest] || 12;
    const load = el[dest] || 0;
    const ratio = load / cap;
    if (ratio > 0.8) cost += ratio * ratio * 200; // exponential penalty near capacity
    else if (ratio > 0.5) cost += ratio * 60;
    return cost;
  }

  return {
    addBlock(e, by) {
      if (!blocks.find(b => b.edge === e)) {
        blocks.push({ edge: e, by, time: Date.now() });
        eventLog.push({ type: "blockade", msg: `Blockade at ${e}`, time: Date.now() });
      }
      return [...blocks];
    },
    rmBlock(e) { blocks = blocks.filter(b => b.edge !== e); return [...blocks]; },
    clearBlocks() { blocks = []; return []; },
    blocked() { return blocks.map(b => b.edge); },
    blocks() { return [...blocks]; },

    // Node congestion for heatmap
    cong() { return nodeCong(); },
    // Edge congestion for route intelligence
    edgeCong() { return edgeCong(); },
    // Per-exit assignment counts
    exitLoads() { return exitLoads(); },

    // ── Smart route: considers edge congestion + exit balancing ──
    route(start, uid) {
      const bl = this.blocked();
      const ec = edgeCong();
      const el = exitLoads();
      // If user already has a route to this exit, remove their old contribution first
      const oldUser = users.get(uid);
      if (oldUser?.path) {
        const oldDest = oldUser.path[oldUser.path.length - 1];
        if (el[oldDest] !== undefined) el[oldDest] = Math.max(0, el[oldDest] - 1);
      }
      let best = null, bs = Infinity;
      for (const ex of EX_IDS) {
        const p = astar(start, ex, bl);
        if (p) {
          const c = routeCost(p, ec, el);
          if (c < bs) { bs = c; best = p; }
        }
      }
      if (best) {
        users.set(uid, { nodeId: start, path: best, progress: 0, lastUpdate: Date.now() });
      }
      return best;
    },

    // Local-only route (no congestion awareness — Bluetooth/offline mode)
    localRoute(start) {
      const bl = this.blocked();
      let best = null, bd = Infinity;
      for (const ex of EX_IDS) {
        const p = astar(start, ex, bl);
        if (p) {
          let d = 0;
          for (let i = 1; i < p.length; i++) d += dist(NM[p[i-1]], NM[p[i]]);
          if (d < bd) { bd = d; best = p; }
        }
      }
      return best;
    },

    // ── Iterative convergence reroute ──
    // Single pass can cause thrashing (A steals B's corridor, B steals C's, etc.)
    // Multiple passes let the system settle into a balanced state
    rerouteAll() {
      const ids = [...users.keys()];
      let totalRerouted = 0;
      const PASSES = 3; // 3 convergence passes
      for (let pass = 0; pass < PASSES; pass++) {
        // Shuffle order each pass to avoid ordering bias
        for (let i = ids.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [ids[i], ids[j]] = [ids[j], ids[i]];
        }
        for (const id of ids) {
          const u = users.get(id);
          if (!u) continue;
          const oldPath = u.path ? [...u.path] : null;
          const p = this.route(u.nodeId, id);
          if (p && oldPath && p.join(",") !== oldPath.join(",")) totalRerouted++;
        }
      }
      eventLog.push({ type: "reroute", msg: `Convergence: ${PASSES} passes, ${totalRerouted} route changes`, time: Date.now() });
      return ids;
    },

    // ── Simulate user movement (advance progress along paths) ──
    tick() {
      const moved = [];
      for (const [id, u] of users) {
        if (!u.path || u.path.length === 0) continue;
        const prog = u.progress || 0;
        if (prog < u.path.length - 1) {
          u.progress = prog + 1;
          u.nodeId = u.path[u.progress];
          moved.push({ id, nodeId: u.nodeId, x: NM[u.nodeId]?.x, y: NM[u.nodeId]?.y });
        }
      }
      return moved;
    },

    // Get simulated user positions for map rendering
    getUserPositions() {
      const positions = [];
      for (const [id, u] of users) {
        if (!u.path || u.path.length === 0) continue;
        const node = NM[u.nodeId];
        if (!node) continue;
        // Add small random offset so overlapping users spread visually
        const hash = id.charCodeAt(id.length-1) || 0;
        positions.push({
          x: node.x + (hash % 7 - 3) * 2,
          y: node.y + ((hash * 3) % 7 - 3) * 1.5,
          id,
          progress: u.progress || 0,
          total: u.path.length,
          dest: u.path[u.path.length - 1],
        });
      }
      return positions;
    },

    count() { return users.size; },
    log() { return eventLog.slice(-20); },

    // ── Analytics snapshot ──
    analytics() {
      const el = exitLoads();
      const ec = edgeCong();
      // Find most congested edge
      let maxEdge = "", maxEdgeLoad = 0;
      for (const [e, l] of Object.entries(ec)) {
        if (l > maxEdgeLoad) { maxEdgeLoad = l; maxEdge = e; }
      }
      // Exit balance score (0=perfect, 1=all at one exit)
      const loads = Object.values(el);
      const total = loads.reduce((a, b) => a + b, 0) || 1;
      const ideal = total / EX_IDS.length;
      const imbalance = loads.reduce((s, l) => s + Math.abs(l - ideal), 0) / (total * 2);

      return {
        totalUsers: users.size,
        exitLoads: el,
        exitCapacity: EXIT_CAPACITY,
        bottleneck: maxEdge ? { edge: maxEdge, load: maxEdgeLoad } : null,
        balanceScore: Math.round((1 - imbalance) * 100), // 100=perfect balance
        activeBlocks: blocks.length,
      };
    },

    seed(n) {
      // Spread seed users across different areas of the building
      const roomNodes = NAV_RAW.filter(r => r.feat?.type === "ROOM");
      // Pick rooms distributed across the building
      const step = Math.max(1, Math.floor(roomNodes.length / n));
      for (let i = 0; i < n; i++) {
        const node = roomNodes[(i * step) % roomNodes.length];
        this.route(node.id, `sim_${i}`);
      }
      // Run 2 convergence passes on seed to get a balanced starting state
      this.rerouteAll();
    },
  };
})();

/* ─── SVG FLOOR PLAN COMPONENT ─── */
const FloorPlan = ({ userPos, route, blockades, congestion, edgeCong, exitLoadData, onClick, people, hoveredRoom, setHoveredRoom, clients, adminMode }) => {
  const rp = route ? route.map(id => NM[id]).filter(Boolean) : [];
  
  // Convert wall segments to SVG space
  const wallLines = useMemo(() => WALLS_RAW.map(([x1,y1,x2,y2]) => ({
    x1: tx(x1), y1: ty(y1), x2: tx(x2), y2: ty(y2)
  })), []);

  return (
    <svg viewBox="0 0 1200 820" preserveAspectRatio="xMidYMid meet"
      style={{ width: "100%", height: "100%", background: "#060a10", borderRadius: 12, display: "block" }}>
      <defs>
        <filter id="gl"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <filter id="gs"><feGaussianBlur stdDeviation="5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#00ffaa"/><stop offset="100%" stopColor="#00aaff"/></linearGradient>
        <pattern id="grd" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M20 0L0 0 0 20" fill="none" stroke="#ffffff03" strokeWidth=".3"/></pattern>
      </defs>
      <rect width="1200" height="820" fill="url(#grd)"/>

      {/* ═══ ACTUAL FLOOR PLAN WALLS from PDF ═══ */}
      {wallLines.map((w, i) => (
        <line key={i} x1={w.x1} y1={w.y1} x2={w.x2} y2={w.y2}
          stroke="#1a2a4060" strokeWidth="1" strokeLinecap="round"/>
      ))}

      {/* Rooms */}
      {ROOMS.map(r => {
        const isHovered = hoveredRoom === r.label;
        return (
          <g key={r.id} style={{ cursor: "pointer" }}
            onClick={() => onClick(NAV_RAW.find(n => n.feat?.id === r.id))}
            onMouseEnter={() => setHoveredRoom(r.label)}
            onMouseLeave={() => setHoveredRoom(null)}>
            <circle cx={r.sx} cy={r.sy} r={isHovered ? 14 : 10} fill={isHovered ? "#1a2f4a" : "#141a2880"} stroke={isHovered ? "#3b82f640" : "#1a254020"} strokeWidth={isHovered ? 1 : .5} />
            <circle cx={r.sx} cy={r.sy} r="3.5" fill={isHovered ? "#3b82f6" : "#1e2a3a"} stroke="#2a3f5f30" strokeWidth=".5"/>
            <text x={r.sx} y={r.sy-9} textAnchor="middle" fill={isHovered ? "#93c5fd" : "#4a5a70"} fontSize="5.5" fontFamily="monospace" fontWeight={isHovered ? "bold" : "normal"}>{r.label}</text>
          </g>
        );
      })}

      {/* Exits */}
      {EXITS.map(e => (
        <g key={e.id} filter="url(#gl)">
          <circle cx={e.sx} cy={e.sy} r="8" fill="#00ff8830" stroke="#00ff88" strokeWidth="1.5">
            <animate attributeName="r" values="8;13;8" dur="2s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="1;.3;1" dur="2s" repeatCount="indefinite"/>
          </circle>
          <circle cx={e.sx} cy={e.sy} r="4" fill="#00ff88"/>
          <text x={e.sx} y={e.sy-13} textAnchor="middle" fill="#00ff88" fontSize="6" fontFamily="monospace" fontWeight="bold">EXIT</text>
          <text x={e.sx} y={e.sy+16} textAnchor="middle" fill="#00ff8880" fontSize="4.5" fontFamily="monospace">{e.label}</text>
        </g>
      ))}

      {/* Congestion heatmap — node-level heat + edge-level thickness */}
      {congestion && Object.entries(congestion).map(([nid, lv]) => {
        const n = NM[nid]; if (!n || lv < 2) return null;
        const intensity = Math.min(lv / 8, 1);
        const r = 5 + lv * 2.5;
        const color = lv > 6 ? `rgba(255,30,30,${0.08 + intensity*0.15})` 
                    : lv > 3 ? `rgba(255,140,0,${0.06 + intensity*0.12})` 
                    : `rgba(255,255,0,${0.04 + intensity*0.08})`;
        return <circle key={`c${nid}`} cx={n.x} cy={n.y} r={r} fill={color}/>;
      })}

      {/* Edge congestion — thicker corridor lines where traffic is heavy */}
      {edgeCong && Object.entries(edgeCong).map(([ek, lv]) => {
        if (lv < 2) return null;
        const [a, b] = ek.split("~");
        const na = NM[a], nb = NM[b];
        if (!na || !nb) return null;
        const intensity = Math.min(lv / 6, 1);
        const color = lv > 5 ? "#ff333335" : lv > 3 ? "#ff880028" : "#ffcc001a";
        return <line key={`ec${ek}`} x1={na.x} y1={na.y} x2={nb.x} y2={nb.y}
          stroke={color} strokeWidth={1.5 + intensity * 4} strokeLinecap="round"/>;
      })}

      {/* Exit load indicators — ring fill shows capacity usage */}
      {exitLoadData && EXITS.map(e => {
        const eid = `p${e.id}`;
        const load = exitLoadData[eid] || 0;
        const cap = EXIT_CAPACITY[eid] || 12;
        const ratio = Math.min(load / cap, 1);
        const loadColor = ratio > 0.8 ? "#ff4444" : ratio > 0.5 ? "#ffaa00" : "#00ff88";
        return (
          <g key={`el${e.id}`}>
            {/* Capacity ring background */}
            <circle cx={e.sx} cy={e.sy} r="18" fill="none" stroke="#ffffff08" strokeWidth="2.5"/>
            {/* Filled arc representing load */}
            <circle cx={e.sx} cy={e.sy} r="18" fill="none" stroke={`${loadColor}50`} strokeWidth="2.5"
              strokeDasharray={`${ratio * 113} 113`} strokeDashoffset="28"
              transform={`rotate(-90 ${e.sx} ${e.sy})`}/>
            {/* Load count */}
            <text x={e.sx} y={e.sy+26} textAnchor="middle" fill={loadColor} fontSize="5" fontFamily="monospace" fontWeight="bold">
              {load}/{cap}
            </text>
          </g>
        );
      })}

      {/* Blockades */}
      {blockades.map((b, i) => {
        const ps = b.edge.split("-"), n1 = NM[ps[0]], n2 = NM[ps[1]];
        if (!n1 || !n2) return null;
        const mx = (n1.x + n2.x) / 2, my = (n1.y + n2.y) / 2;
        return (
          <g key={`b${i}`}>
            <line x1={n1.x} y1={n1.y} x2={n2.x} y2={n2.y} stroke="#ff000050" strokeWidth="3" strokeDasharray="5 3"/>
            <circle cx={mx} cy={my} r="10" fill="#ff000025" stroke="#ff3333" strokeWidth="1.5" filter="url(#gl)">
              <animate attributeName="r" values="10;14;10" dur="1.5s" repeatCount="indefinite"/>
            </circle>
            <text x={mx} y={my+1} textAnchor="middle" dominantBaseline="middle" fill="#ff4444" fontSize="12" fontWeight="bold">✕</text>
          </g>
        );
      })}

      {/* Simulated evacuees — colored by assigned exit */}
      {people.map((p, i) => {
        const exitColors = { p8: "#4488ff", p23: "#ff8844", p125: "#44ff88", p133: "#ff44aa" };
        const c = exitColors[p.dest] || "#5588ee";
        const alpha = p.progress < p.total * 0.5 ? 0.6 : 0.3; // fade as they get closer to exit
        return (
          <g key={`sp${i}`}>
            <circle cx={p.x} cy={p.y} r="3.5" fill={`${c}18`}/>
            <circle cx={p.x} cy={p.y} r="1.5" fill={c} opacity={alpha}/>
          </g>
        );
      })}

      {/* Client Routes in Admin Mode */}
      {adminMode && clients && clients.map(client => {
        const clientRoute = client.route ? client.route.map(id => NM[id]).filter(Boolean) : [];
        if (clientRoute.length < 2) return null;
        return (
          <g key={`cr${client.id}`} filter="url(#gs)">
            <polyline 
              points={clientRoute.map(p => `${p.x},${p.y}`).join(" ")} 
              fill="none" 
              stroke={client.color} 
              strokeWidth="2.5" 
              strokeLinecap="round" 
              strokeLinejoin="round" 
              strokeDasharray="8 4"
              opacity="0.7">
              <animate attributeName="stroke-dashoffset" from="0" to="-12" dur=".5s" repeatCount="indefinite"/>
            </polyline>
            {clientRoute.slice(1, -1).map((p, i) => 
              <circle key={`r${i}`} cx={p.x} cy={p.y} r="1.8" fill={client.color} opacity=".4"/>
            )}
          </g>
        );
      })}

      {/* Route (Single Client Mode) */}
      {!adminMode && rp.length > 1 && <g filter="url(#gs)">
        <polyline points={rp.map(p => `${p.x},${p.y}`).join(" ")} fill="none" stroke="url(#rg)" strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round" strokeDasharray="10 5">
          <animate attributeName="stroke-dashoffset" from="0" to="-15" dur=".5s" repeatCount="indefinite"/>
        </polyline>
        {rp.slice(1, -1).map((p, i) => <circle key={`r${i}`} cx={p.x} cy={p.y} r="2.5" fill="#00ffaa" opacity=".5"/>)}
      </g>}

      {/* Client Positions in Admin Mode */}
      {adminMode && clients && clients.map(client => (
        <g key={`cp${client.id}`} filter="url(#gs)">
          <circle cx={client.pos.x} cy={client.pos.y} r="14" fill={`${client.color}08`} stroke={client.color} strokeWidth=".8">
            <animate attributeName="r" values="10;18;10" dur="2s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values=".6;.12;.6" dur="2s" repeatCount="indefinite"/>
          </circle>
          <circle cx={client.pos.x} cy={client.pos.y} r="5" fill={client.color}/>
          <circle cx={client.pos.x} cy={client.pos.y} r="2" fill="#fff"/>
          <text x={client.pos.x} y={client.pos.y - 20} textAnchor="middle" fill={client.color} fontSize="6" fontFamily="monospace" fontWeight="bold">
            {client.name.split(" ")[1]}
          </text>
        </g>
      ))}

      {/* User position (Single Client Mode) */}
      {!adminMode && userPos && <g filter="url(#gs)">
        <circle cx={userPos.x} cy={userPos.y} r="16" fill="#00aaff08" stroke="#00aaff" strokeWidth=".8">
          <animate attributeName="r" values="12;22;12" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values=".6;.12;.6" dur="2s" repeatCount="indefinite"/>
        </circle>
        <circle cx={userPos.x} cy={userPos.y} r="6" fill="#00ccff"/>
        <circle cx={userPos.x} cy={userPos.y} r="2.5" fill="#fff"/>
      </g>}

      {/* Destination (Single Client Mode) */}
      {!adminMode && route && rp.length > 0 && <g filter="url(#gl)">
        <circle cx={rp[rp.length-1].x} cy={rp[rp.length-1].y} r="10" fill="none" stroke="#00ff88" strokeWidth="2">
          <animate attributeName="r" values="10;17;10" dur="1.5s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="1;.2;1" dur="1.5s" repeatCount="indefinite"/>
        </circle>
      </g>}

    {/* Debugging Label */}
    {userPos && (
    <text x="500" y="500" fill="yellow" fontSize="14" fontWeight="bold">
        X: {userPos.x.toFixed(0)} Y: {userPos.y.toFixed(0)}
    </text>
    )}

      <text x="18" y="810" fill="#1a2a4050" fontSize="7" fontFamily="monospace">MC Building No.17 — 1st Floor — University of Waterloo — EchoAid GeoJSON</text>
    </svg>
  );
};

/* ═══════════════════════════════════════
   MAIN APP — ECHOAID
   ═══════════════════════════════════════ */
export default function App() {
  // Initialize 5 controllable clients
  const initialClients = [
    { id: 1, name: "Client Alpha", pos: { x: tx(1783), y: ty(955) }, node: "p48", route: null, status: "STANDBY", progress: 0, color: "#00aaff" },
    { id: 2, name: "Client Beta", pos: { x: tx(1418), y: ty(1014) }, node: "p43", route: null, status: "STANDBY", progress: 0, color: "#00ff88" },
    { id: 3, name: "Client Gamma", pos: { x: tx(2047), y: ty(1018) }, node: "p6", route: null, status: "STANDBY", progress: 0, color: "#ffaa00" },
    { id: 4, name: "Client Delta", pos: { x: tx(1289), y: ty(980) }, node: "p71", route: null, status: "STANDBY", progress: 0, color: "#ff44aa" },
    { id: 5, name: "Client Epsilon", pos: { x: tx(2194), y: ty(948) }, node: "p54", route: null, status: "STANDBY", progress: 0, color: "#4488ff" },
  ];
  
  const [clients, setClients] = useState(initialClients);
  const [activeClientId, setActiveClientId] = useState(1);
  const [wifi, setWifi] = useState(true);
  const [logs, setLogs] = useState([]);
  const [listening, setListening] = useState(false);
  const [transcript, setTranscript] = useState("");
  const [blocks, setBlocks] = useState([]);
  const [cong, setCong] = useState({});
  const [eCong, setECong] = useState({});
  const [exLoads, setExLoads] = useState({});
  const [analytics, setAnalytics] = useState(null);
  const [people, setPeople] = useState([]);
  const [showBM, setShowBM] = useState(false);
  const [hoveredRoom, setHoveredRoom] = useState(null);
  const [searchQuery, setSearchQuery] = useState("");
  const [adminMode, setAdminMode] = useState(false);
  const [selectedUser, setSelectedUser] = useState(null);
  const recRef = useRef(null);
  const logRef = useRef(null);
  const simRef = useRef(null);
  
  const activeClient = clients.find(c => c.id === activeClientId);
  const updateClient = useCallback((id, updates) => {
    setClients(prev => prev.map(c => c.id === id ? { ...c, ...updates } : c));
  }, []);

  const log = useCallback((m, t = "info") => {
    const d = new Date();
    const ts = `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}:${String(d.getSeconds()).padStart(2, "0")}`;
    setLogs(p => [...p.slice(-60), { msg: m, type: t, time: ts }]);
  }, []);
  useEffect(() => { logRef.current && (logRef.current.scrollTop = logRef.current.scrollHeight); }, [logs]);

  // Refresh all brain-derived state
  const refreshBrain = useCallback(() => {
    setCong(brain.cong());
    setECong(brain.edgeCong());
    setExLoads(brain.exitLoads());
    setAnalytics(brain.analytics());
    setPeople(brain.getUserPositions());
  }, []);

  // Initialize
  useEffect(() => {
    brain.seed(30); // 30 simulated evacuees for richer demo
    refreshBrain();
    log("EchoAid initialized — MC Building floor plan loaded from PDF", "success");
    log(`${NODES.length} nodes, ${EDGES.length} edges, ${WALLS_RAW.length} wall segments`, "info");
    const a = brain.analytics();
    log(`🧠 Global Brain: ${a.totalUsers} evacuees, balance score ${a.balanceScore}%`, "route");
    const el = brain.exitLoads();
    const exitNames = { p8: "North", p23: "East N", p125: "West", p133: "South" };
    const distStr = EX_IDS.map(e => `${exitNames[e]}:${el[e]}`).join(" · ");
    log(`📊 Exit distribution → ${distStr}`, "info");
  }, []);

  // Simulation tick — move simulated users every 3s
  useEffect(() => {
    simRef.current = setInterval(() => {
      brain.tick();
      refreshBrain();
    }, 5000);
    return () => clearInterval(simRef.current);
  }, [refreshBrain]);

  const evac = useCallback((nid, clientId = activeClientId) => {
    const p = wifi ? brain.route(nid, "main") : brain.localRoute(nid);
    log(wifi ? "🌐 Global Brain: congestion-aware routing..." : "📶 Local Brain: nearest exit...", "route");
    if (p) {
      updateClient(clientId, { route: p, status: "EVACUATING", progress: 0 });
      const last = NM[p[p.length-1]];
      const ex = EXITS.find(e => Math.abs(e.sx - last.x) < 20 && Math.abs(e.sy - last.y) < 20);
      const en = ex ? ex.label : "nearest exit";
      const client = clients.find(c => c.id === clientId);
      log(`✅ ${client?.name}: Route ${p.length} waypoints → ${en}`, "success");
      speak(`Route calculated. Head towards ${en}.`);
      if (wifi) {
        const a = brain.analytics();
        log(`🧠 Balance: ${a.balanceScore}% · Bottleneck: ${a.bottleneck ? a.bottleneck.edge + ` (${a.bottleneck.load} users)` : "none"}`, "info");
      }
      refreshBrain();
    } else {
      log("⚠ No route found!", "error");
      speak("Warning. No route found.");
    }
  }, [wifi, log, refreshBrain, activeClientId, clients, updateClient]);

  const onNode = useCallback(n => {
    if (!n) return;
    updateClient(activeClientId, { node: n.id, pos: { x: n.x, y: n.y } });
    log(`📍 ${activeClient?.name}: Location set to ${n.label || n.id}`);
    if (activeClient?.status === "EVACUATING") evac(n.id);
  }, [activeClient, evac, log, activeClientId, updateClient]);

  const doEvac = useCallback(() => {
    if (!activeClient?.node) { 
      const d = "p48"; 
      updateClient(activeClientId, { node: d, pos: { x: NM[d].x, y: NM[d].y } });
      log(`${activeClient?.name}: Auto-placed in MC 1052.`, "warn"); 
      evac(d); 
    } else {
      evac(activeClient.node);
    }
  }, [activeClient, evac, log, activeClientId, updateClient]);

  const doBlock = useCallback(() => {
    if (!activeClient?.route || activeClient.route.length < 3) { log("Need active route.", "warn"); return; }
    const idx = Math.min(activeClient.progress + 1, activeClient.route.length - 2);
    const edge = `${activeClient.route[idx]}-${activeClient.route[idx+1]}`;
    brain.addBlock(edge, activeClient.name); setBlocks(brain.blocks());
    log(`⛔ Blockade: ${edge}`, "error"); speak("Blockade reported. Rerouting all evacuees.");
    const rr = brain.rerouteAll();
    const a = brain.analytics();
    log(`🔄 ${rr.length} evacuees rerouted (3 convergence passes) · Balance: ${a.balanceScore}%`, "route");
    refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [activeClient, clients, evac, log, refreshBrain]);

  const rmBlock = useCallback(edge => {
    brain.rmBlock(edge); setBlocks(brain.blocks());
    log(`✅ Cleared: ${edge}`, "success"); speak("Blockade cleared.");
    brain.rerouteAll(); refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [clients, evac, log, refreshBrain]);

  const clearAll = useCallback(() => {
    brain.clearBlocks(); setBlocks([]);
    log("✅ All blockades cleared.", "success"); speak("All blockades cleared.");
    brain.rerouteAll(); refreshBrain();
    clients.forEach(c => {
      if (c.status === "EVACUATING" && c.node) {
        setTimeout(() => evac(c.node, c.id), 300);
      }
    });
  }, [clients, evac, log, refreshBrain]);

  const doSafe = useCallback(() => {
    updateClient(activeClientId, { status: "SAFE", route: null });
    log(`✅ ${activeClient?.name}: SAFE.`, "success");
    speak("You are safe.");
  }, [log, activeClientId, activeClient, updateClient]);

  // Voice recognition
  const startListen = useCallback(() => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { log("No speech recognition.", "error"); return; }
    const r = new SR(); r.continuous = false; r.interimResults = false; r.lang = "en-US";
    r.onresult = e => {
      const t = e.results[0][0].transcript.toLowerCase(); setTranscript(t); log(`🎤 "${t}"`);
      if (t.includes("fire") || t.includes("emergency")) doEvac();
      else if (t.includes("clear") && t.includes("block")) clearAll();
      else if (t.includes("block")) doBlock();
      else if (t.includes("evacuate") || t.includes("help")) doEvac();
      else if (t.includes("safe")) doSafe();
      else { log("Command not recognized.", "warn"); }
    };
    r.onerror = e => { log(`Voice: ${e.error}`, "error"); setListening(false); };
    r.onend = () => setListening(false);
    r.start(); recRef.current = r; setListening(true); log("🎤 Listening...");
  }, [doEvac, doBlock, clearAll, doSafe, log]);

  // Evacuation step timer - moves each evacuating client
  useEffect(() => {
    const intervals = {};
    clients.forEach(client => {
      if (client.status !== "EVACUATING" || !client.route || client.route.length < 2) return;
      intervals[client.id] = setInterval(() => {
        const newProgress = client.progress + 1;
        if (newProgress >= client.route.length - 1) {
          clearInterval(intervals[client.id]);
          updateClient(client.id, { status: "SAFE", route: null });
          if (client.id === activeClientId) {
            speak("You are safe.");
            log(`✅ ${client.name}: Evacuated successfully!`, "success");
          }
        } else {
          const nn = NM[client.route[newProgress]];
          if (nn) {
            updateClient(client.id, {
              progress: newProgress,
              pos: { x: nn.x, y: nn.y },
              node: client.route[newProgress]
            });
          }
          if (newProgress === Math.floor(client.route.length / 2) && client.id === activeClientId) {
            speak("Halfway there.");
          }
        }
      }, 1800);
    });
    return () => {
      Object.values(intervals).forEach(iv => clearInterval(iv));
    };
  }, [clients, activeClientId, updateClient]);

  // Room search
  const filteredRooms = searchQuery
    ? ROOMS.filter(r => r.label.toLowerCase().includes(searchQuery.toLowerCase())).slice(0, 8)
    : [];

  const sc = activeClient?.status === "EVACUATING" ? "#ff4444" : activeClient?.status === "SAFE" ? "#00ff88" : "#00aaff";

  return (
    <div className="app-shell" style={{ minHeight: "100vh", color: "#c0d0e0", fontFamily: "'IBM Plex Sans',sans-serif" }}>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap');@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}*{box-sizing:border-box;margin:0;padding:0}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#0a0e14}::-webkit-scrollbar-thumb{background:#1a2a40;border-radius:4px}.app-shell{background:radial-gradient(1200px 600px at 10% -10%,#112a45 0%,transparent 60%),radial-gradient(900px 500px at 90% -10%,#401a22 0%,transparent 55%),radial-gradient(800px 600px at 50% 120%,#0f2a24 0%,transparent 60%),#05070d;color:#c7d4e5}.app-header{backdrop-filter:blur(10px);background:linear-gradient(135deg,#0b111a,#0b0f1d);border-bottom:1px solid #1a2a40;box-shadow:0 10px 30px #00000055}.card{background:linear-gradient(180deg,#0c121c,#080c13);border:1px solid #1a2a40;box-shadow:0 10px 30px #00000055,inset 0 1px 0 #ffffff08;transition:transform .3s ease,box-shadow .3s ease,border-color .3s ease}.card:hover{transform:translateY(-2px);box-shadow:0 16px 40px #00000066,inset 0 1px 0 #ffffff12}.map-shell{background:linear-gradient(180deg,#0b111c,#080c14);border:1px solid #1d314a;box-shadow:0 16px 40px #00000066;transition:transform .3s ease,box-shadow .3s ease,border-color .3s ease}.panel-title{letter-spacing:2px;font-family:'Space Grotesk',sans-serif}`}</style>

      {/* HEADER */}
      <header className="app-header" style={{ padding: "12px 20px", display: "flex", alignItems: "center", justifyContent: "space-between", position: "sticky", top: 0, zIndex: 100 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{ width: 36, height: 36, borderRadius: 10, background: activeClient?.status === "EVACUATING" ? "linear-gradient(135deg,#ff2200,#ff6600)" : activeClient?.status === "SAFE" ? "linear-gradient(135deg,#00cc66,#00ff88)" : "linear-gradient(135deg,#0066ff,#00aaff)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, boxShadow: `0 0 20px ${sc}40` }}>
            {activeClient?.status === "EVACUATING" ? "🚨" : activeClient?.status === "SAFE" ? "✅" : "🏢"}
          </div>
          <div>
            <div style={{ fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, fontSize: 18, color: "#e6f2ff", letterSpacing: 2, textShadow: "0 0 18px #00aaff30" }}>
              ECHO<span style={{ color: "#00aaff" }}>AID</span>
            </div>
            <div style={{ fontSize: 9, color: "#445566", fontFamily: "monospace" }}>MC Building No.17 — UWaterloo — Real Floor Plan Data</div>
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          {/* Mode Switcher */}
          <select value={adminMode ? "admin" : "client"} onChange={e => setAdminMode(e.target.value === "admin")}
            style={{ padding: "6px 12px", borderRadius: 6, border: `1px solid ${adminMode ? "#ff880040" : "#1a2a40"}`, background: adminMode ? "#ff880010" : "#0a0e14", color: adminMode ? "#ffaa00" : "#7799bb", fontFamily: "'JetBrains Mono',monospace", fontSize: 10, fontWeight: 600, cursor: "pointer", outline: "none" }}>
            <option value="client">👤 Client View</option>
            <option value="admin">🛡️ Admin Dashboard</option>
          </select>
          
          {/* Client Selector */}
          {!adminMode && (
            <select value={activeClientId} onChange={e => setActiveClientId(Number(e.target.value))}
              style={{ padding: "6px 12px", borderRadius: 6, border: `1px solid ${activeClient?.color}40`, background: "#0a0e14", color: activeClient?.color, fontFamily: "'JetBrains Mono',monospace", fontSize: 10, fontWeight: 600, cursor: "pointer", outline: "none" }}>
              {clients.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          )}
          
          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
            <div style={{ width: 8, height: 8, borderRadius: "50%", background: sc, boxShadow: `0 0 8px ${sc}`, animation: activeClient?.status === "EVACUATING" ? "pulse 1s infinite" : "none" }} />
            <span style={{ color: sc, fontFamily: "'JetBrains Mono',monospace", fontSize: 11, fontWeight: 700, letterSpacing: 2 }}>{activeClient?.status || "STANDBY"}</span>
          </div>
          <span style={{ color: "#334455", fontSize: 10, fontFamily: "monospace" }}>
            {wifi ? "📡 Global" : "📶 Local"} · {analytics?.totalUsers || 0} users · Balance {analytics?.balanceScore || 0}% · {blocks.length} blocks
          </span>
        </div>
      </header>

      <div style={{ padding: "14px 20px", maxWidth: 1600, margin: "0 auto" }}>
        {/* MAP */}
        <div className="map-shell" style={{ borderRadius: 12, padding: 12, marginBottom: 14 }}>
          <FloorPlan 
            userPos={adminMode ? null : activeClient?.pos} 
            route={adminMode ? null : activeClient?.route} 
            blockades={blocks} 
            congestion={cong} 
            edgeCong={eCong} 
            exitLoadData={exLoads} 
            onClick={onNode} 
            people={people} 
            hoveredRoom={hoveredRoom} 
            setHoveredRoom={setHoveredRoom}
            clients={clients}
            adminMode={adminMode}
          />
          {activeClient?.route && !adminMode && <div style={{ marginTop: 10 }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
              <span style={{ color: "#556677", fontSize: 11, fontFamily: "monospace" }}>{activeClient.name} - Evacuation Progress</span>
              <span style={{ color: "#00ff88", fontSize: 11, fontFamily: "monospace", fontWeight: 600 }}>{Math.round(activeClient.progress / (activeClient.route.length - 1) * 100)}%</span>
            </div>
            <div style={{ height: 4, background: "#1a2a40", borderRadius: 2, overflow: "hidden" }}>
              <div style={{ height: "100%", width: `${activeClient.progress / (activeClient.route.length - 1) * 100}%`, background: `linear-gradient(90deg,${activeClient.color},${activeClient.color}aa)`, transition: "width .5s" }} />
            </div>
          </div>}
        </div>

        {/* CONTROLS GRID */}
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: 12 }}>
          {/* Room Search + Actions */}
          <div className="card" style={{ borderRadius: 10, padding: 14 }}>
            <div style={{ color: "#8899bb", fontSize: 10, fontFamily: "monospace", letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>📍 Find Your Room</div>
            <input value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
              placeholder="Search room (e.g. 1052, 1047...)" style={{ width: "100%", padding: "8px 12px", borderRadius: 7, border: "1px solid #1a2a40", background: "#0a0e14", color: "#c0d0e0", fontFamily: "'JetBrains Mono',monospace", fontSize: 11, outline: "none", marginBottom: 6 }} />
            {filteredRooms.length > 0 && (
              <div style={{ maxHeight: 120, overflowY: "auto", marginBottom: 8 }}>
                {filteredRooms.map(r => (
                  <div key={r.id} onClick={() => { onNode(NAV_RAW.find(n => n.feat?.id === r.id)); setSearchQuery(""); }}
                    style={{ padding: "5px 10px", cursor: "pointer", borderRadius: 4, fontSize: 11, fontFamily: "monospace", color: "#7799bb", background: hoveredRoom === r.label ? "#1a2a40" : "transparent" }}
                    onMouseEnter={() => setHoveredRoom(r.label)} onMouseLeave={() => setHoveredRoom(null)}>
                    {r.label} <span style={{ color: "#334455", fontSize: 9 }}>({r.x}, {r.y})</span>
                  </div>
                ))}
              </div>
            )}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginTop: 6 }}>
              <button onClick={doEvac} style={{ padding: 12, borderRadius: 8, border: "none", cursor: "pointer", background: activeClient?.status === "EVACUATING" ? "linear-gradient(135deg,#cc2200,#ff4400)" : "linear-gradient(135deg,#0055cc,#0088ff)", color: "#fff", fontFamily: "'JetBrains Mono',monospace", fontSize: 11, fontWeight: 700, letterSpacing: 1 }}>
                {activeClient?.status === "EVACUATING" ? "🚨 REROUTE" : "🚀 EVACUATE"}
              </button>
              <button onClick={doBlock} style={{ padding: 12, borderRadius: 8, border: "1px solid #ff444040", background: "#ff111110", color: "#ff6666", fontFamily: "'JetBrains Mono',monospace", fontSize: 11, fontWeight: 600, cursor: "pointer" }}>⛔ BLOCKADE</button>
            </div>
          </div>

          {/* Voice + Commands */}
          <div className="card" style={{ borderRadius: 10, padding: 14 }}>
            <div style={{ color: "#8899bb", fontSize: 10, fontFamily: "monospace", letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>🎙️ Voice Control & Commands</div>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
              <div onClick={() => listening ? (recRef.current?.stop(), setListening(false)) : startListen()}
                style={{ width: 36, height: 36, borderRadius: "50%", background: listening ? "#ff444430" : "#1a2a40", border: `2px solid ${listening ? "#ff4444" : "#2a3f5f"}`, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 16 }}>
                {listening ? "🔴" : "🎙️"}
              </div>
              <div>
                <div style={{ color: "#8899bb", fontSize: 10, fontFamily: "monospace", textTransform: "uppercase", letterSpacing: 1 }}>Voice Control</div>
                <div style={{ color: listening ? "#ff6666" : "#445566", fontSize: 9, fontFamily: "monospace" }}>{listening ? "Listening..." : "Tap to speak"}</div>
              </div>
            </div>
            {transcript && <div style={{ background: "#0a0e14", borderRadius: 6, padding: "5px 10px", color: "#6688aa", fontSize: 10, fontFamily: "monospace", fontStyle: "italic", marginBottom: 6 }}>"{transcript}"</div>}
            <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
              {["Report fire", "Report blockade", "Help evacuate", "Clear blockade", "I'm safe"].map(c => (
                <button key={c} onClick={() => { setTranscript(c); log(`Cmd: "${c}"`); if (c.includes("fire")) doEvac(); else if (c === "Report blockade") doBlock(); else if (c === "Clear blockade") clearAll(); else if (c.includes("evacuate")) doEvac(); else doSafe(); }}
                  style={{ background: "#1a2230", border: "1px solid #2a3a50", borderRadius: 5, padding: "4px 8px", color: "#7799bb", fontSize: 9, fontFamily: "monospace", cursor: "pointer" }}>{c}</button>
              ))}
            </div>
          </div>

        </div>

        {/* ═══════════════════════════════════════════════════════════
            ADMIN DASHBOARD - Emergency Management & User Monitoring
            ═══════════════════════════════════════════════════════════ */}
        {adminMode && (
          <>
            {/* Emergency Stats Overview */}
            <div className="card" style={{ borderRadius: 10, padding: 14, marginTop: 12, border: "1px solid #ffaa0030" }}>
              <div style={{ color: "#ffaa00", fontSize: 11, fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 12 }}>
                🛡️ Emergency Control Center
              </div>
              <div style={{ marginBottom: 12 }}>
                {[
                  [clients.filter(c => c.status === "SAFE").length, "Evacuated", "#00ff88", "✓"],
                  [clients.filter(c => c.status === "EVACUATING").length, "Evacuating", "#ffaa00", "→"],
                  [clients.filter(c => c.status === "STANDBY").length, "Still Inside", "#ff4444", "!"],
                  [clients.filter(c => c.status === "EVACUATING" && Math.random() < 0.2).length, "Need Help", "#ff0044", "🆘"],
                ].map(([count, label, color, icon]) => (
                  <div key={label} style={{ background: `${color}08`, border: `1px solid ${color}30`, borderRadius: 8, padding: 10, textAlign: "center" }}>
                    <div style={{ fontSize: 20, fontWeight: 700, color, fontFamily: "'JetBrains Mono',monospace", marginBottom: 2 }}>{icon} {count}</div>
                    <div style={{ fontSize: 9, color: "#556677", fontFamily: "monospace", textTransform: "uppercase" }}>{label}</div>
                  </div>
                ))}
              </div>

              {/* Exit Load Distribution */}
              <div style={{ color: "#556677", fontSize: 9, fontFamily: "monospace", marginBottom: 6, textTransform: "uppercase", letterSpacing: 0.5 }}>🚪 Exit Load Distribution</div>
              {(() => {
                const exitNames = { p8: "North Exit", p23: "East N Exit", p125: "West Exit (ESC)", p133: "South Exit" };
                const exitColors = { p8: "#4488ff", p23: "#ff8844", p125: "#44ff88", p133: "#ff44aa" };
                return EX_IDS.map(eid => {
                  const load = exLoads[eid] || 0;
                  const cap = EXIT_CAPACITY[eid] || 12;
                  const ratio = Math.min(load / cap, 1);
                  const barColor = ratio > 0.8 ? "#ff4444" : ratio > 0.5 ? "#ffaa00" : exitColors[eid];
                  return (
                    <div key={eid} style={{ marginBottom: 5 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 2 }}>
                        <span style={{ color: exitColors[eid], fontSize: 9, fontFamily: "monospace", fontWeight: 600 }}>{exitNames[eid]}</span>
                        <span style={{ color: "#556677", fontSize: 9, fontFamily: "monospace" }}>{load}/{cap} ({Math.round(ratio * 100)}%)</span>
                      </div>
                      <div style={{ height: 5, background: "#0a0e14", borderRadius: 3, overflow: "hidden" }}>
                        <div style={{ height: "100%", width: `${ratio * 100}%`, background: barColor, borderRadius: 3, transition: "width .5s" }} />
                      </div>
                    </div>
                  );
                });
              })()}
            </div>

            {/* Live Clients Monitor */}
            <div className="card" style={{ borderRadius: 10, padding: 14, marginTop: 12, border: "1px solid #00aaff30" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                <div style={{ color: "#00aaff", fontSize: 11, fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, letterSpacing: 2, textTransform: "uppercase" }}>
                  👥 Controllable Clients ({clients.length})
                </div>
                <div style={{ display: "flex", gap: 6, fontSize: 8, fontFamily: "monospace" }}>
                  <span style={{ color: "#00ff88" }}>● Safe</span>
                  <span style={{ color: "#ffaa00" }}>● Evacuating</span>
                  <span style={{ color: "#ff4444" }}>● Standby</span>
                </div>
              </div>

              <div style={{ maxHeight: 400, overflowY: "auto", marginTop: 8 }}>
                {clients.map((client) => {
                  const isEvacuated = client.status === "SAFE";
                  const isEvacuating = client.status === "EVACUATING";
                  const statusColor = isEvacuated ? "#00ff88" : isEvacuating ? "#ffaa00" : "#ff4444";
                  const statusText = isEvacuated ? "Evacuated" : isEvacuating ? "Evacuating" : "Standby";
                  const exitNames = { p8: "North", p23: "East N", p125: "West", p133: "South" };
                  const currentNode = NM[client.route?.[client.progress]] || NM[client.node] || {};
                  const exitNode = client.route ? NM[client.route[client.route.length - 1]] : null;
                  
                  return (
                    <div 
                      key={client.id}
                      onClick={() => setSelectedUser(selectedUser === client.id ? null : client.id)}
                      style={{ 
                        background: selectedUser === client.id ? "#1a2a4020" : "#0a0e14", 
                        border: `1px solid ${selectedUser === client.id ? client.color + "60" : client.color + "30"}`, 
                        borderRadius: 8, 
                        padding: "8px 12px", 
                        marginBottom: 6,
                        cursor: "pointer",
                        transition: "all .2s ease"
                      }}
                    >
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: 4 }}>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 3 }}>
                            <div style={{ width: 6, height: 6, borderRadius: "50%", background: client.color, boxShadow: `0 0 6px ${client.color}` }} />
                            <span style={{ color: client.color, fontSize: 11, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                              {client.name}
                            </span>
                            <span style={{ background: `${statusColor}20`, border: `1px solid ${statusColor}`, borderRadius: 4, padding: "1px 5px", fontSize: 8, color: statusColor, fontWeight: 600 }}>{statusText}</span>
                          </div>
                          <div style={{ color: "#556677", fontSize: 9, fontFamily: "monospace", lineHeight: 1.5 }}>
                            Location: <span style={{ color: "#7799bb", fontWeight: 600 }}>{currentNode.label || client.node}</span>
                            {client.route && <> · Exit: <span style={{ color: "#00aaff" }}>{exitNode?.label || "Unknown"}</span></>}
                          </div>
                        </div>
                        {isEvacuating && (
                          <div style={{ textAlign: "right" }}>
                            <div style={{ color: statusColor, fontSize: 10, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                              {Math.round((client.progress / (client.route.length - 1)) * 100)}%
                            </div>
                            <div style={{ fontSize: 8, color: "#445566", fontFamily: "monospace" }}>
                              {client.progress}/{client.route.length - 1}
                            </div>
                          </div>
                        )}
                      </div>
                      
                      {/* Progress bar */}
                      {isEvacuating && (
                        <div style={{ height: 3, background: "#1a2a40", borderRadius: 2, overflow: "hidden", marginBottom: selectedUser === client.id ? 8 : 0 }}>
                          <div style={{ height: "100%", width: `${(client.progress / (client.route.length - 1)) * 100}%`, background: `linear-gradient(90deg, ${client.color}, ${client.color}aa)`, transition: "width .5s" }} />
                        </div>
                      )}

                      {/* Expanded details + Actions */}
                      {selectedUser === client.id && (
                        <div style={{ marginTop: 8, paddingTop: 8, borderTop: "1px solid #1a2a40" }}>
                          <div style={{ color: "#7799bb", fontSize: 9, fontFamily: "monospace", marginBottom: 4 }}>
                            📍 Position: ({Math.round(client.pos.x)}, {Math.round(client.pos.y)})
                          </div>
                          {client.route && (
                            <div style={{ color: "#7799bb", fontSize: 9, fontFamily: "monospace", marginBottom: 6 }}>
                              🛣️ Route: {client.route.length} waypoints
                            </div>
                          )}
                          {/* Admin Actions */}
                          <div style={{ display: "flex", gap: 4, marginTop: 6 }}>
                            {!isEvacuating && client.node && (
                              <button onClick={(e) => { e.stopPropagation(); evac(client.node, client.id); }}
                                style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: "none", background: "linear-gradient(135deg,#0055cc,#0088ff)", color: "#fff", fontSize: 9, fontFamily: "monospace", fontWeight: 600, cursor: "pointer" }}>
                                🚀 Start Evacuation
                              </button>
                            )}
                            {isEvacuating && (
                              <button onClick={(e) => { e.stopPropagation(); updateClient(client.id, { status: "SAFE", route: null }); }}
                                style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: "1px solid #00ff8840", background: "#00ff8810", color: "#00ff88", fontSize: 9, fontFamily: "monospace", fontWeight: 600, cursor: "pointer" }}>
                                ✓ Mark Safe
                              </button>
                            )}
                            <button onClick={(e) => { e.stopPropagation(); setActiveClientId(client.id); setAdminMode(false); }}
                              style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: `1px solid ${client.color}40`, background: `${client.color}10`, color: client.color, fontSize: 9, fontFamily: "monospace", fontWeight: 600, cursor: "pointer" }}>
                              🎮 Control
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Global Brain Analytics */}
            <div className="card" style={{ borderRadius: 10, padding: 14, marginTop: 12, border: "1px solid #44ff8830" }}>
              <div style={{ color: "#44ff88", fontSize: 11, fontFamily: "'Space Grotesk',sans-serif", fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 12 }}>
                🧠 AI Brain Analytics
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                <div style={{ background: "#0a0e14", borderRadius: 6, padding: 10 }}>
                  <div style={{ color: "#556677", fontSize: 8, fontFamily: "monospace", textTransform: "uppercase", marginBottom: 4 }}>Network Mode</div>
                  <div style={{ color: wifi ? "#00aaff" : "#ff8800", fontSize: 14, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                    {wifi ? "📡 Global AI" : "📶 Local Only"}
                  </div>
                </div>
                <div style={{ background: "#0a0e14", borderRadius: 6, padding: 10 }}>
                  <div style={{ color: "#556677", fontSize: 8, fontFamily: "monospace", textTransform: "uppercase", marginBottom: 4 }}>Load Balance</div>
                  <div style={{ color: (analytics?.balanceScore || 0) > 70 ? "#00ff88" : (analytics?.balanceScore || 0) > 40 ? "#ffaa00" : "#ff4444", fontSize: 14, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700 }}>
                    {analytics?.balanceScore || 0}%
                  </div>
                </div>
              </div>
              
              {analytics?.bottleneck && analytics.bottleneck.load > 3 && (
                <div style={{ marginTop: 10, background: "#ff111110", border: "1px solid #ff444420", borderRadius: 6, padding: "8px 12px" }}>
                  <div style={{ color: "#ff6666", fontSize: 10, fontFamily: "monospace", fontWeight: 600, marginBottom: 2 }}>⚠️ Bottleneck Detected</div>
                  <div style={{ color: "#ff8888", fontSize: 9, fontFamily: "monospace" }}>
                    Corridor {analytics.bottleneck.edge.replace("~","→")} · {analytics.bottleneck.load} users · High congestion
                  </div>
                </div>
              )}

              <div style={{ marginTop: 10, color: "#445566", fontSize: 8, fontFamily: "monospace", lineHeight: 1.6 }}>
                {wifi 
                  ? "✓ Global brain active. Congestion-aware routing. Real-time load balancing across all exits. Iterative convergence algorithm optimizing evacuation flow." 
                  : "⚠ Offline mode. Local pathfinding only. No crowd intelligence or dynamic rerouting."}
              </div>
            </div>
          </>
        )}

        {/* Blockade Manager */}
        <div className="card" style={{ border: `1px solid ${blocks.length > 0 ? "#ff444440" : "#1a2a40"}`, borderRadius: 10, padding: 14, marginTop: 12 }}>
          <div onClick={() => setShowBM(!showBM)} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer" }}>
            <span style={{ color: blocks.length > 0 ? "#ff6666" : "#8899bb", fontSize: 10, fontFamily: "monospace", letterSpacing: 1, textTransform: "uppercase" }}>⛔ Blockade Manager ({blocks.length})</span>
            <span style={{ color: "#445566", fontSize: 10 }}>{showBM ? "▲" : "▼"}</span>
          </div>
          {showBM && <div style={{ marginTop: 10 }}>
            {blocks.length === 0 ? <div style={{ color: "#334455", fontSize: 10, fontFamily: "monospace", fontStyle: "italic", padding: "8px 0" }}>No active blockades.</div> :
              <>{blocks.map((b, i) => <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", background: "#0a0e14", borderRadius: 6, padding: "6px 10px", marginBottom: 4, border: "1px solid #ff111118" }}>
                <div><div style={{ color: "#ff6666", fontSize: 10, fontFamily: "monospace", fontWeight: 600 }}>{b.edge}</div><div style={{ color: "#445566", fontSize: 8, fontFamily: "monospace" }}>by {b.by} · {new Date(b.time).toLocaleTimeString()}</div></div>
                <button onClick={() => rmBlock(b.edge)} style={{ padding: "4px 10px", borderRadius: 5, border: "1px solid #00ff8840", background: "#00ff8810", color: "#00ff88", fontSize: 9, fontFamily: "monospace", cursor: "pointer", fontWeight: 600 }}>✓ Clear</button>
              </div>)}
                <button onClick={clearAll} style={{ width: "100%", marginTop: 6, padding: 8, borderRadius: 6, border: "1px solid #00ff8840", background: "#00ff8808", color: "#00ff88", fontSize: 10, fontFamily: "monospace", cursor: "pointer", fontWeight: 600 }}>Clear All & Reroute Everyone</button>
              </>}
          </div>}
        </div>

        {/* AI LOG */}
        <div ref={logRef} className="card" style={{ borderRadius: 10, padding: 12, maxHeight: 150, overflowY: "auto", fontFamily: "'JetBrains Mono',monospace", fontSize: 10, marginTop: 12 }}>
          <div style={{ color: "#445566", fontSize: 9, marginBottom: 6, letterSpacing: 1, textTransform: "uppercase" }}>AI Brain Log</div>
          {logs.map((l, i) => (
            <div key={i} style={{ marginBottom: 3, lineHeight: 1.4 }}>
              <span style={{ color: "#222" }}>[{l.time}] </span>
              <span style={{ color: l.type === "error" ? "#ff4444" : l.type === "warn" ? "#ffaa00" : l.type === "success" ? "#00ff88" : l.type === "route" ? "#00aaff" : "#556677" }}>{l.msg}</span>
            </div>
          ))}
          {logs.length === 0 && <div style={{ color: "#334455", fontStyle: "italic" }}>Awaiting...</div>}
        </div>
      </div>
    </div>
  );
}



